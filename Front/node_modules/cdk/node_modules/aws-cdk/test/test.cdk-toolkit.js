"use strict";
const nodeunit = require("nodeunit");
const stacks_1 = require("../lib/api/cxapp/stacks");
const sdk_1 = require("../lib/api/util/sdk");
const cdk_toolkit_1 = require("../lib/cdk-toolkit");
class MockStack {
    constructor(stackName, template = { Resources: { TempalteName: stackName } }, templateFile = `fake/stack/${stackName}.json`, assets = [], parameters = {}, environment = { name: 'MockEnv', account: '123456789012', region: 'bermuda-triangle-1' }) {
        this.stackName = stackName;
        this.template = template;
        this.templateFile = templateFile;
        this.assets = assets;
        this.parameters = parameters;
        this.environment = environment;
    }
}
class TestAppStacks extends stacks_1.AppStacks {
    constructor(test) {
        super(undefined);
        this.test = test;
    }
    getTagsFromStackMetadata(stack) {
        switch (stack.stackName) {
            case TestAppStacks.MOCK_STACK_A.stackName:
                return [{ Key: 'Foo', Value: 'Bar' }];
            case TestAppStacks.MOCK_STACK_B.stackName:
                return [{ Key: 'Baz', Value: 'Zinga!' }];
            default:
                throw new Error(`Not an expected mock stack: ${stack.stackName}`);
        }
    }
    selectStacks(selectors) {
        this.test.deepEqual(selectors, ['Test-Stack-A', 'Test-Stack-B']);
        return Promise.resolve([
            // Cheating the type system here (intentionally, so we have to stub less!)
            TestAppStacks.MOCK_STACK_A,
            TestAppStacks.MOCK_STACK_B,
        ]);
    }
    processMetadata(stacks) {
        stacks.forEach(stack => this.test.ok(stack === TestAppStacks.MOCK_STACK_A || stack === TestAppStacks.MOCK_STACK_B, `Not an expected mock stack: ${stack.stackName}`));
    }
    listStacks() {
        throw new Error('Not Implemented');
    }
    synthesizeStack() {
        throw new Error('Not Implemented');
    }
    synthesizeStacks() {
        throw new Error('Not Implemented');
    }
}
TestAppStacks.MOCK_STACK_A = new MockStack('Test-Stack-A');
TestAppStacks.MOCK_STACK_B = new MockStack('Test-Stack-B');
class TestProvisioner {
    constructor(test, expectedTags = {}, expectedNotificationArns) {
        this.test = test;
        this.expectedTags = {};
        for (const [stackName, tags] of Object.entries(expectedTags)) {
            this.expectedTags[stackName] =
                Object.entries(tags).map(([Key, Value]) => ({ Key, Value }))
                    .sort((l, r) => l.Key.localeCompare(r.Key));
        }
        if (expectedNotificationArns) {
            this.expectedNotificationArns = expectedNotificationArns;
        }
    }
    deployStack(options) {
        this.test.ok(options.stack.stackName === TestAppStacks.MOCK_STACK_A.stackName || options.stack.stackName === TestAppStacks.MOCK_STACK_B.stackName, `Not an expected mock stack: ${options.stack.stackName}`);
        this.test.deepEqual(options.tags, this.expectedTags[options.stack.stackName]);
        this.test.deepEqual(options.notificationArns, this.expectedNotificationArns);
        return Promise.resolve({
            stackArn: `arn:aws:cloudformation:::stack/${options.stack.stackName}/MockedOut`,
            noOp: false,
            outputs: { StackName: options.stack.stackName },
        });
    }
    readCurrentTemplate(stack) {
        switch (stack.stackName) {
            case TestAppStacks.MOCK_STACK_A.stackName:
                return Promise.resolve({});
            case TestAppStacks.MOCK_STACK_B.stackName:
                return Promise.resolve({});
            default:
                return Promise.reject(`Not an expected mock stack: ${stack.stackName}`);
        }
    }
}
module.exports = nodeunit.testCase({
    deploy: {
        'makes correct CloudFormation calls': {
            'without options'(test) {
                // GIVEN
                const toolkit = new cdk_toolkit_1.CdkToolkit({
                    appStacks: new TestAppStacks(test),
                    provisioner: new TestProvisioner(test, {
                        'Test-Stack-A': { Foo: 'Bar' },
                        'Test-Stack-B': { Baz: 'Zinga!' },
                    }),
                });
                // WHEN
                toolkit.deploy({ stackNames: ['Test-Stack-A', 'Test-Stack-B'], sdk: new sdk_1.SDK() });
                // THEN
                test.done();
            },
            'with sns notification arns'(test) {
                // GIVEN
                const notificationArns = ['arn:aws:sns:::cfn-notifications', 'arn:aws:sns:::my-cool-topic'];
                const toolkit = new cdk_toolkit_1.CdkToolkit({
                    appStacks: new TestAppStacks(test),
                    provisioner: new TestProvisioner(test, {
                        'Test-Stack-A': { Foo: 'Bar' },
                        'Test-Stack-B': { Baz: 'Zinga!' },
                    }, notificationArns),
                });
                // WHEN
                toolkit.deploy({
                    stackNames: ['Test-Stack-A', 'Test-Stack-B'],
                    notificationArns,
                    sdk: new sdk_1.SDK()
                });
                // THEN
                test.done();
            },
        },
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5jZGstdG9vbGtpdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInRlc3QuY2RrLXRvb2xraXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLHFDQUFzQztBQUN0QyxvREFBeUQ7QUFHekQsNkNBQTBDO0FBQzFDLG9EQUFnRDtBQThDaEQsTUFBTSxTQUFTO0lBQ2IsWUFDa0IsU0FBaUIsRUFDakIsV0FBZ0IsRUFBRSxTQUFTLEVBQUUsRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLEVBQUUsRUFDMUQsZUFBdUIsY0FBYyxTQUFTLE9BQU8sRUFDckQsU0FBcUMsRUFBRSxFQUN2QyxhQUF1QyxFQUFFLEVBQ3pDLGNBQWlDLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sRUFBRSxvQkFBb0IsRUFBRTtRQUwzRyxjQUFTLEdBQVQsU0FBUyxDQUFRO1FBQ2pCLGFBQVEsR0FBUixRQUFRLENBQWtEO1FBQzFELGlCQUFZLEdBQVosWUFBWSxDQUF5QztRQUNyRCxXQUFNLEdBQU4sTUFBTSxDQUFpQztRQUN2QyxlQUFVLEdBQVYsVUFBVSxDQUErQjtRQUN6QyxnQkFBVyxHQUFYLFdBQVcsQ0FBZ0c7SUFDMUgsQ0FBQztDQUNMO0FBRUQsTUFBTSxhQUFjLFNBQVEsa0JBQVM7SUFJbkMsWUFBNkIsSUFBbUI7UUFDOUMsS0FBSyxDQUFDLFNBQWdCLENBQUMsQ0FBQztRQURHLFNBQUksR0FBSixJQUFJLENBQWU7SUFFaEQsQ0FBQztJQUVNLHdCQUF3QixDQUFDLEtBQXdDO1FBQ3RFLFFBQVEsS0FBSyxDQUFDLFNBQVMsRUFBRTtZQUN2QixLQUFLLGFBQWEsQ0FBQyxZQUFZLENBQUMsU0FBUztnQkFDdkMsT0FBTyxDQUFDLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUN4QyxLQUFLLGFBQWEsQ0FBQyxZQUFZLENBQUMsU0FBUztnQkFDdkMsT0FBTyxD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SCxPQUFPO2dCQUNQLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxVQUFVLEVBQUUsQ0FBQyxjQUFjLEVBQUUsY0FBYyxDQUFDLEVBQUUsR0FBRyxFQUFFLElBQUksU0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUVqRixPQUFPO2dCQUNQLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNkLENBQUM7WUFDRCw0QkFBNEIsQ0FBQyxJQUFtQjtnQkFDOUMsUUFBUTtnQkFDUixNQUFNLGdCQUFnQixHQUFHLENBQUMsaUNBQWlDLEVBQUUsNkJBQTZCLENBQUMsQ0FBQztnQkFDNUYsTUFBTSxPQUFPLEdBQUcsSUFBSSx3QkFBVSxDQUFDO29CQUM3QixTQUFTLEVBQUUsSUFBSSxhQUFhLENBQUMsSUFBSSxDQUFDO29CQUNsQyxXQUFXLEVBQUUsSUFBSSxlQUFlLENBQUMsSUFBSSxFQUFFO3dCQUNyQyxjQUFjLEVBQUUsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFO3dCQUM5QixjQUFjLEVBQUUsRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFO3FCQUNsQyxFQUFFLGdCQUFnQixDQUFDO2lCQUNyQixDQUFDLENBQUM7Z0JBRUgsT0FBTztnQkFDUCxPQUFPLENBQUMsTUFBTSxDQUFDO29CQUNiLFVBQVUsRUFBRSxDQUFDLGNBQWMsRUFBRSxjQUFjLENBQUM7b0JBQzVDLGdCQUFnQjtvQkFDaEIsR0FBRyxFQUFFLElBQUksU0FBRyxFQUFFO2lCQUNmLENBQUMsQ0FBQztnQkFFSCxPQUFPO2dCQUNQLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNkLENBQUM7U0FDRjtLQUNGO0NBQ0YsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGN4YXBpID0gcmVxdWlyZSgnQGF3cy1jZGsvY3gtYXBpJyk7XG5pbXBvcnQgbm9kZXVuaXQgPSByZXF1aXJlKCdub2RldW5pdCcpO1xuaW1wb3J0IHsgQXBwU3RhY2tzLCBUYWcgfSBmcm9tICcuLi9saWIvYXBpL2N4YXBwL3N0YWNrcyc7XG5pbXBvcnQgeyBEZXBsb3lTdGFja1Jlc3VsdCB9IGZyb20gJy4uL2xpYi9hcGkvZGVwbG95LXN0YWNrJztcbmltcG9ydCB7IERlcGxveVN0YWNrT3B0aW9ucywgSURlcGxveW1lbnRUYXJnZXQsIFRlbXBsYXRlIH0gZnJvbSAnLi4vbGliL2FwaS9kZXBsb3ltZW50LXRhcmdldCc7XG5pbXBvcnQgeyBTREsgfSBmcm9tICcuLi9saWIvYXBpL3V0aWwvc2RrJztcbmltcG9ydCB7IENka1Rvb2xraXQgfSBmcm9tICcuLi9saWIvY2RrLXRvb2xraXQnO1xuXG5leHBvcnQgPSBub2RldW5pdC50ZXN0Q2FzZSh7XG4gIGRlcGxveToge1xuICAgICdtYWtlcyBjb3JyZWN0IENsb3VkRm9ybWF0aW9uIGNhbGxzJzoge1xuICAgICAgJ3dpdGhvdXQgb3B0aW9ucycodGVzdDogbm9kZXVuaXQuVGVzdCkge1xuICAgICAgICAvLyBHSVZFTlxuICAgICAgICBjb25zdCB0b29sa2l0ID0gbmV3IENka1Rvb2xraXQoe1xuICAgICAgICAgIGFwcFN0YWNrczogbmV3IFRlc3RBcHBTdGFja3ModGVzdCksXG4gICAgICAgICAgcHJvdmlzaW9uZXI6IG5ldyBUZXN0UHJvdmlzaW9uZXIodGVzdCwge1xuICAgICAgICAgICAgJ1Rlc3QtU3RhY2stQSc6IHsgRm9vOiAnQmFyJyB9LFxuICAgICAgICAgICAgJ1Rlc3QtU3RhY2stQic6IHsgQmF6OiAnWmluZ2EhJyB9LFxuICAgICAgICAgIH0pLFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBXSEVOXG4gICAgICAgIHRvb2xraXQuZGVwbG95KHsgc3RhY2tOYW1lczogWydUZXN0LVN0YWNrLUEnLCAnVGVzdC1TdGFjay1CJ10sIHNkazogbmV3IFNESygpIH0pO1xuXG4gICAgICAgIC8vIFRIRU5cbiAgICAgICAgdGVzdC5kb25lKCk7XG4gICAgICB9LFxuICAgICAgJ3dpdGggc25zIG5vdGlmaWNhdGlvbiBhcm5zJyh0ZXN0OiBub2RldW5pdC5UZXN0KSB7XG4gICAgICAgIC8vIEdJVkVOXG4gICAgICAgIGNvbnN0IG5vdGlmaWNhdGlvbkFybnMgPSBbJ2Fybjphd3M6c25zOjo6Y2ZuLW5vdGlmaWNhdGlvbnMnLCAnYXJuOmF3czpzbnM6OjpteS1jb29sLXRvcGljJ107XG4gICAgICAgIGNvbnN0IHRvb2xraXQgPSBuZXcgQ2RrVG9vbGtpdCh7XG4gICAgICAgICAgYXBwU3RhY2tzOiBuZXcgVGVzdEFwcFN0YWNrcyh0ZXN0KSxcbiAgICAgICAgICBwcm92aXNpb25lcjogbmV3IFRlc3RQcm92aXNpb25lcih0ZXN0LCB7XG4gICAgICAgICAgICAnVGVzdC1TdGFjay1BJzogeyBGb286ICdCYXInIH0sXG4gICAgICAgICAgICAnVGVzdC1TdGFjay1CJzogeyBCYXo6ICdaaW5nYSEnIH0sXG4gICAgICAgICAgfSwgbm90aWZpY2F0aW9uQXJucyksXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFdIRU5cbiAgICAgICAgdG9vbGtpdC5kZXBsb3koe1xuICAgICAgICAgIHN0YWNrTmFtZXM6IFsnVGVzdC1TdGFjay1BJywgJ1Rlc3QtU3RhY2stQiddLFxuICAgICAgICAgIG5vdGlmaWNhdGlvbkFybnMsXG4gICAgICAgICAgc2RrOiBuZXcgU0RLKClcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gVEhFTlxuICAgICAgICB0ZXN0LmRvbmUoKTtcbiAgICAgIH0sXG4gICAgfSxcbiAgfSxcbn0pO1xuXG5jbGFzcyBNb2NrU3RhY2sge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgcmVhZG9ubHkgc3RhY2tOYW1lOiBzdHJpbmcsXG4gICAgcHVibGljIHJlYWRvbmx5IHRlbXBsYXRlOiBhbnkgPSB7IFJlc291cmNlczogeyBUZW1wYWx0ZU5hbWU6IHN0YWNrTmFtZSB9IH0sXG4gICAgcHVibGljIHJlYWRvbmx5IHRlbXBsYXRlRmlsZTogc3RyaW5nID0gYGZha2Uvc3RhY2svJHtzdGFja05hbWV9Lmpzb25gLFxuICAgIHB1YmxpYyByZWFkb25seSBhc3NldHM6IGN4YXBpLkFzc2V0TWV0YWRhdGFFbnRyeVtdID0gW10sXG4gICAgcHVibGljIHJlYWRvbmx5IHBhcmFtZXRlcnM6IHsgW2lkOiBzdHJpbmddOiBzdHJpbmcgfSA9IHt9LFxuICAgIHB1YmxpYyByZWFkb25seSBlbnZpcm9ubWVudDogY3hhcGkuRW52aXJvbm1lbnQgPSB7IG5hbWU6ICdNb2NrRW52JywgYWNjb3VudDogJzEyMzQ1Njc4OTAxMicsIHJlZ2lvbjogJ2Jlcm11ZGEtdHJpYW5nbGUtMScgfSxcbiAgKSB7fVxufVxuXG5jbGFzcyBUZXN0QXBwU3RhY2tzIGV4dGVuZHMgQXBwU3RhY2tzIHtcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBNT0NLX1NUQUNLX0EgPSBuZXcgTW9ja1N0YWNrKCdUZXN0LVN0YWNrLUEnKTtcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBNT0NLX1NUQUNLX0IgPSBuZXcgTW9ja1N0YWNrKCdUZXN0LVN0YWNrLUInKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHRlc3Q6IG5vZGV1bml0LlRlc3QpIHtcbiAgICBzdXBlcih1bmRlZmluZWQgYXMgYW55KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRUYWdzRnJvbVN0YWNrTWV0YWRhdGEoc3RhY2s6IGN4YXBpLkNsb3VkRm9ybWF0aW9uU3RhY2tBcnRpZmFjdCk6IFRhZ1tdIHtcbiAgICBzd2l0Y2ggKHN0YWNrLnN0YWNrTmFtZSkge1xuICAgICAgY2FzZSBUZXN0QXBwU3RhY2tzLk1PQ0tfU1RBQ0tfQS5zdGFja05hbWU6XG4gICAgICAgIHJldHVybiBbeyBLZXk6ICdGb28nLCBWYWx1ZTogJ0JhcicgfV07XG4gICAgICBjYXNlIFRlc3RBcHBTdGFja3MuTU9DS19TVEFDS19CLnN0YWNrTmFtZTpcbiAgICAgICAgcmV0dXJuIFt7IEtleTogJ0JheicsIFZhbHVlOiAnWmluZ2EhJyB9XTtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgTm90IGFuIGV4cGVjdGVkIG1vY2sgc3RhY2s6ICR7c3RhY2suc3RhY2tOYW1lfWApO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzZWxlY3RTdGFja3Moc2VsZWN0b3JzOiBzdHJpbmdbXSk6IFByb21pc2U8Y3hhcGkuQ2xvdWRGb3JtYXRpb25TdGFja0FydGlmYWN0W10+IHtcbiAgICB0aGlzLnRlc3QuZGVlcEVxdWFsKHNlbGVjdG9ycywgWydUZXN0LVN0YWNrLUEnLCAnVGVzdC1TdGFjay1CJ10pO1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoW1xuICAgICAgLy8gQ2hlYXRpbmcgdGhlIHR5cGUgc3lzdGVtIGhlcmUgKGludGVudGlvbmFsbHksIHNvIHdlIGhhdmUgdG8gc3R1YiBsZXNzISlcbiAgICAgIFRlc3RBcHBTdGFja3MuTU9DS19TVEFDS19BIGFzIGN4YXBpLkNsb3VkRm9ybWF0aW9uU3RhY2tBcnRpZmFjdCxcbiAgICAgIFRlc3RBcHBTdGFja3MuTU9DS19TVEFDS19CIGFzIGN4YXBpLkNsb3VkRm9ybWF0aW9uU3RhY2tBcnRpZmFjdCxcbiAgICBdKTtcbiAgfVxuXG4gIHB1YmxpYyBwcm9jZXNzTWV0YWRhdGEoc3RhY2tzOiBjeGFwaS5DbG91ZEZvcm1hdGlvblN0YWNrQXJ0aWZhY3RbXSk6IHZvaWQge1xuICAgIHN0YWNrcy5mb3JFYWNoKHN0YWNrID0+XG4gICAgICB0aGlzLnRlc3Qub2soc3RhY2sgPT09IFRlc3RBcHBTdGFja3MuTU9DS19TVEFDS19BIHx8IHN0YWNrID09PSBUZXN0QXBwU3RhY2tzLk1PQ0tfU1RBQ0tfQixcbiAgICAgICAgYE5vdCBhbiBleHBlY3RlZCBtb2NrIHN0YWNrOiAke3N0YWNrLnN0YWNrTmFtZX1gKSk7XG4gIH1cblxuICBwdWJsaWMgbGlzdFN0YWNrcygpOiBuZXZlciB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgSW1wbGVtZW50ZWQnKTtcbiAgfVxuXG4gIHB1YmxpYyBzeW50aGVzaXplU3RhY2soKTogbmV2ZXIge1xuICAgIHRocm93IG5ldyBFcnJvcignTm90IEltcGxlbWVudGVkJyk7XG4gIH1cblxuICBwdWJsaWMgc3ludGhlc2l6ZVN0YWNrcygpOiBuZXZlciB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgSW1wbGVtZW50ZWQnKTtcbiAgfVxufVxuXG5jbGFzcyBUZXN0UHJvdmlzaW9uZXIgaW1wbGVtZW50cyBJRGVwbG95bWVudFRhcmdldCB7XG4gIHByaXZhdGUgcmVhZG9ubHkgZXhwZWN0ZWRUYWdzOiB7IFtzdGFja05hbWU6IHN0cmluZ106IFRhZ1tdIH0gPSB7fTtcbiAgcHJpdmF0ZSByZWFkb25seSBleHBlY3RlZE5vdGlmaWNhdGlvbkFybnM/OiBzdHJpbmdbXTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHRlc3Q6IG5vZGV1bml0LlRlc3QsXG4gICAgZXhwZWN0ZWRUYWdzOiB7IFtzdGFja05hbWU6IHN0cmluZ106IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0gfSA9IHt9LFxuICAgIGV4cGVjdGVkTm90aWZpY2F0aW9uQXJucz86IHN0cmluZ1tdLFxuICApIHtcbiAgICBmb3IgKGNvbnN0IFtzdGFja05hbWUsIHRhZ3NdIG9mIE9iamVjdC5lbnRyaWVzKGV4cGVjdGVkVGFncykpIHtcbiAgICAgIHRoaXMuZXhwZWN0ZWRUYWdzW3N0YWNrTmFtZV0gPVxuICAgICAgICBPYmplY3QuZW50cmllcyh0YWdzKS5tYXAoKFtLZXksIFZhbHVlXSkgPT4gKHsgS2V5LCBWYWx1ZSB9KSlcbiAgICAgICAgICAuc29ydCgobCwgcikgPT4gIGwuS2V5LmxvY2FsZUNvbXBhcmUoci5LZXkpKTtcbiAgICB9XG4gICAgaWYgKGV4cGVjdGVkTm90aWZpY2F0aW9uQXJucykge1xuICAgICAgdGhpcy5leHBlY3RlZE5vdGlmaWNhdGlvbkFybnMgPSBleHBlY3RlZE5vdGlmaWNhdGlvbkFybnM7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGRlcGxveVN0YWNrKG9wdGlvbnM6IERlcGxveVN0YWNrT3B0aW9ucyk6IFByb21pc2U8RGVwbG95U3RhY2tSZXN1bHQ+IHtcbiAgICB0aGlzLnRlc3Qub2soXG4gICAgICBvcHRpb25zLnN0YWNrLnN0YWNrTmFtZSA9PT0gVGVzdEFwcFN0YWNrcy5NT0NLX1NUQUNLX0Euc3RhY2tOYW1lIHx8IG9wdGlvbnMuc3RhY2suc3RhY2tOYW1lID09PSBUZXN0QXBwU3RhY2tzLk1PQ0tfU1RBQ0tfQi5zdGFja05hbWUsXG4gICAgICBgTm90IGFuIGV4cGVjdGVkIG1vY2sgc3RhY2s6ICR7b3B0aW9ucy5zdGFjay5zdGFja05hbWV9YFxuICAgICk7XG4gICAgdGhpcy50ZXN0LmRlZXBFcXVhbChvcHRpb25zLnRhZ3MsIHRoaXMuZXhwZWN0ZWRUYWdzW29wdGlvbnMuc3RhY2suc3RhY2tOYW1lXSk7XG4gICAgdGhpcy50ZXN0LmRlZXBFcXVhbChvcHRpb25zLm5vdGlmaWNhdGlvbkFybnMsIHRoaXMuZXhwZWN0ZWROb3RpZmljYXRpb25Bcm5zKTtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtcbiAgICAgIHN0YWNrQXJuOiBgYXJuOmF3czpjbG91ZGZvcm1hdGlvbjo6OnN0YWNrLyR7b3B0aW9ucy5zdGFjay5zdGFja05hbWV9L01vY2tlZE91dGAsXG4gICAgICBub09wOiBmYWxzZSxcbiAgICAgIG91dHB1dHM6IHsgU3RhY2tOYW1lOiBvcHRpb25zLnN0YWNrLnN0YWNrTmFtZSB9LFxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHJlYWRDdXJyZW50VGVtcGxhdGUoc3RhY2s6IGN4YXBpLkNsb3VkRm9ybWF0aW9uU3RhY2tBcnRpZmFjdCk6IFByb21pc2U8VGVtcGxhdGU+IHtcbiAgICBzd2l0Y2ggKHN0YWNrLnN0YWNrTmFtZSkge1xuICAgICAgY2FzZSBUZXN0QXBwU3RhY2tzLk1PQ0tfU1RBQ0tfQS5zdGFja05hbWU6XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe30pO1xuICAgICAgY2FzZSBUZXN0QXBwU3RhY2tzLk1PQ0tfU1RBQ0tfQi5zdGFja05hbWU6XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe30pO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGBOb3QgYW4gZXhwZWN0ZWQgbW9jayBzdGFjazogJHtzdGFjay5zdGFja05hbWV9YCk7XG4gICAgfVxuICB9XG59XG4iXX0=