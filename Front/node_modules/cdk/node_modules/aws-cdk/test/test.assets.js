"use strict";
const assets_1 = require("../lib/assets");
const util_1 = require("./util");
class FakeToolkit {
    constructor() {
        this.bucketUrl = 'https://bucket';
        this.bucketName = 'bucket';
    }
    async uploadIfChanged(_data, props) {
        const filename = `12345${props.s3KeySuffix}`;
        return {
            filename,
            key: `${props.s3KeyPrefix}${filename}`,
            hash: '12345',
            changed: true,
        };
    }
}
module.exports = {
    async 'prepare assets'(test) {
        // GIVEN
        const assembly = util_1.testAssembly({
            stacks: [{
                    stackName: 'SomeStack',
                    template: {
                        Resources: {
                            SomeResource: {
                                Type: 'AWS::Something::Something'
                            }
                        }
                    },
                    assets: [
                        {
                            sourceHash: 'source-hash',
                            path: __filename,
                            id: 'SomeStackSomeResource4567',
                            packaging: 'file',
                            s3BucketParameter: 'BucketParameter',
                            s3KeyParameter: 'KeyParameter',
                            artifactHashParameter: 'ArtifactHashParameter',
                        }
                    ]
                }]
        });
        const toolkit = new FakeToolkit();
        // WHEN
        const params = await assets_1.prepareAssets(assembly.getStackByName('SomeStack'), toolkit);
        // THEN
        test.deepEqual(params, [
            { ParameterKey: 'BucketParameter', ParameterValue: 'bucket' },
            { ParameterKey: 'KeyParameter', ParameterValue: 'assets/SomeStackSomeResource4567/||12345.js' },
            { ParameterKey: 'ArtifactHashParameter', ParameterValue: '12345' },
        ]);
        test.done();
    },
    async 'prepare assets with reuse'(test) {
        // GIVEN
        const stack = util_1.testStack({
            stackName: 'SomeStack',
            assets: [
                {
                    path: __filename,
                    id: 'SomeStackSomeResource4567',
                    packaging: 'file',
                    s3BucketParameter: 'BucketParameter',
                    s3KeyParameter: 'KeyParameter',
                    artifactHashParameter: 'ArtifactHashParameter',
                    sourceHash: 'boom'
                }
            ],
            template: {
                Resources: {
                    SomeResource: {
                        Type: 'AWS::Something::Something'
                    }
                }
            }
        });
        const toolkit = new FakeToolkit();
        // WHEN
        const params = await assets_1.prepareAssets(stack, toolkit, undefined, ['SomeStackSomeResource4567']);
        // THEN
        test.deepEqual(params, [
            { ParameterKey: 'BucketParameter', UsePreviousValue: true },
            { ParameterKey: 'KeyParameter', UsePreviousValue: true },
            { ParameterKey: 'ArtifactHashParameter', UsePreviousValue: true },
        ]);
        test.done();
    },
    async 'prepare container asset with reuse'(test) {
        // GIVEN
        const stack = util_1.testStack({
            stackName: 'SomeStack',
            assets: [
                {
                    path: __dirname,
                    id: 'SomeStackSomeResource4567',
                    packaging: 'container-image',
                    imageNameParameter: 'asdf',
                    sourceHash: 'source-hash'
                }
            ],
            template: {
                Resources: {
                    SomeResource: {
                        Type: 'AWS::Something::Something'
                    }
                }
            }
        });
        const toolkit = new FakeToolkit();
        // WHEN
        const params = await assets_1.prepareAssets(stack, toolkit, undefined, ['SomeStackSomeResource4567']);
        // THEN
        test.deepEqual(params, [
            { ParameterKey: 'asdf', UsePreviousValue: true },
        ]);
        test.done();
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5hc3NldHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0ZXN0LmFzc2V0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBRUEsMENBQThDO0FBQzlDLGlDQUFpRDtBQXFIakQsTUFBTSxXQUFXO0lBQWpCO1FBQ1MsY0FBUyxHQUFXLGdCQUFnQixDQUFDO1FBQ3JDLGVBQVUsR0FBVyxRQUFRLENBQUM7SUFXdkMsQ0FBQztJQVRRLEtBQUssQ0FBQyxlQUFlLENBQUMsS0FBVSxFQUFFLEtBQWtCO1FBQ3pELE1BQU0sUUFBUSxHQUFHLFFBQVEsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzdDLE9BQU87WUFDTCxRQUFRO1lBQ1IsR0FBRyxFQUFFLEdBQUcsS0FBSyxDQUFDLFdBQVcsR0FBRyxRQUFRLEVBQUU7WUFDdEMsSUFBSSxFQUFFLE9BQU87WUFDYixPQUFPLEVBQUUsSUFBSTtTQUNkLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUFoSUQsaUJBQVM7SUFDUCxLQUFLLENBQUMsZ0JBQWdCLENBQUMsSUFBVTtRQUMvQixRQUFRO1FBQ1IsTUFBTSxRQUFRLEdBQUcsbUJBQVksQ0FBQztZQUM1QixNQUFNLEVBQUUsQ0FBQztvQkFDUCxTQUFTLEVBQUUsV0FBVztvQkFDdEIsUUFBUSxFQUFFO3dCQUNSLFNBQVMsRUFBRTs0QkFDVCxZQUFZLEVBQUU7Z0NBQ1osSUFBSSxFQUFFLDJCQUEyQjs2QkFDbEM7eUJBQ0Y7cUJBQ0Y7b0JBQ0QsTUFBTSxFQUFFO3dCQUNOOzRCQUNFLFVBQVUsRUFBRSxhQUFhOzRCQUN6QixJQUFJLEVBQUUsVUFBVTs0QkFDaEIsRUFBRSxFQUFFLDJCQUEyQjs0QkFDL0IsU0FBUyxFQUFFLE1BQU07NEJBQ2pCLGlCQUFpQixFQUFFLGlCQUFpQjs0QkFDcEMsY0FBYyxFQUFFLGNBQWM7NEJBQzlCLHFCQUFxQixFQUFFLHVCQUF1Qjt5QkFDL0M7cUJBQ0Y7aUJBQ0YsQ0FBQztTQUNILENBQUMsQ0FBQztRQUVILE1BQU0s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SCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDZCxDQUFDO0NBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlc3QgfSBmcm9tICdub2RldW5pdCc7XG5pbXBvcnQgeyBVcGxvYWRlZCwgVXBsb2FkUHJvcHMgfSBmcm9tICcuLi9saWInO1xuaW1wb3J0IHsgcHJlcGFyZUFzc2V0cyB9IGZyb20gJy4uL2xpYi9hc3NldHMnO1xuaW1wb3J0IHsgdGVzdEFzc2VtYmx5LCB0ZXN0U3RhY2sgfSBmcm9tICcuL3V0aWwnO1xuXG5leHBvcnQgPSB7XG4gIGFzeW5jICdwcmVwYXJlIGFzc2V0cycodGVzdDogVGVzdCkge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3QgYXNzZW1ibHkgPSB0ZXN0QXNzZW1ibHkoe1xuICAgICAgc3RhY2tzOiBbe1xuICAgICAgICBzdGFja05hbWU6ICdTb21lU3RhY2snLFxuICAgICAgICB0ZW1wbGF0ZToge1xuICAgICAgICAgIFJlc291cmNlczoge1xuICAgICAgICAgICAgU29tZVJlc291cmNlOiB7XG4gICAgICAgICAgICAgIFR5cGU6ICdBV1M6OlNvbWV0aGluZzo6U29tZXRoaW5nJ1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgYXNzZXRzOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgc291cmNlSGFzaDogJ3NvdXJjZS1oYXNoJyxcbiAgICAgICAgICAgIHBhdGg6IF9fZmlsZW5hbWUsXG4gICAgICAgICAgICBpZDogJ1NvbWVTdGFja1NvbWVSZXNvdXJjZTQ1NjcnLFxuICAgICAgICAgICAgcGFja2FnaW5nOiAnZmlsZScsXG4gICAgICAgICAgICBzM0J1Y2tldFBhcmFtZXRlcjogJ0J1Y2tldFBhcmFtZXRlcicsXG4gICAgICAgICAgICBzM0tleVBhcmFtZXRlcjogJ0tleVBhcmFtZXRlcicsXG4gICAgICAgICAgICBhcnRpZmFjdEhhc2hQYXJhbWV0ZXI6ICdBcnRpZmFjdEhhc2hQYXJhbWV0ZXInLFxuICAgICAgICAgIH1cbiAgICAgICAgXVxuICAgICAgfV1cbiAgICB9KTtcblxuICAgIGNvbnN0IHRvb2xraXQgPSBuZXcgRmFrZVRvb2xraXQoKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCBwYXJhbXMgPSBhd2FpdCBwcmVwYXJlQXNzZXRzKGFzc2VtYmx5LmdldFN0YWNrQnlOYW1lKCdTb21lU3RhY2snKSwgdG9vbGtpdCBhcyBhbnkpO1xuXG4gICAgLy8gVEhFTlxuICAgIHRlc3QuZGVlcEVxdWFsKHBhcmFtcywgW1xuICAgICAgeyBQYXJhbWV0ZXJLZXk6ICdCdWNrZXRQYXJhbWV0ZXInLCBQYXJhbWV0ZXJWYWx1ZTogJ2J1Y2tldCcgfSxcbiAgICAgIHsgUGFyYW1ldGVyS2V5OiAnS2V5UGFyYW1ldGVyJywgUGFyYW1ldGVyVmFsdWU6ICdhc3NldHMvU29tZVN0YWNrU29tZVJlc291cmNlNDU2Ny98fDEyMzQ1LmpzJyB9LFxuICAgICAgeyBQYXJhbWV0ZXJLZXk6ICdBcnRpZmFjdEhhc2hQYXJhbWV0ZXInLCBQYXJhbWV0ZXJWYWx1ZTogJzEyMzQ1JyB9LFxuICAgIF0pO1xuXG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgYXN5bmMgJ3ByZXBhcmUgYXNzZXRzIHdpdGggcmV1c2UnKHRlc3Q6IFRlc3QpIHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gdGVzdFN0YWNrKHtcbiAgICAgIHN0YWNrTmFtZTogJ1NvbWVTdGFjaycsXG4gICAgICBhc3NldHM6IFtcbiAgICAgICAge1xuICAgICAgICAgIHBhdGg6IF9fZmlsZW5hbWUsXG4gICAgICAgICAgaWQ6ICdTb21lU3RhY2tTb21lUmVzb3VyY2U0NTY3JyxcbiAgICAgICAgICBwYWNrYWdpbmc6ICdmaWxlJyxcbiAgICAgICAgICBzM0J1Y2tldFBhcmFtZXRlcjogJ0J1Y2tldFBhcmFtZXRlcicsXG4gICAgICAgICAgczNLZXlQYXJhbWV0ZXI6ICdLZXlQYXJhbWV0ZXInLFxuICAgICAgICAgIGFydGlmYWN0SGFzaFBhcmFtZXRlcjogJ0FydGlmYWN0SGFzaFBhcmFtZXRlcicsXG4gICAgICAgICAgc291cmNlSGFzaDogJ2Jvb20nXG4gICAgICAgIH1cbiAgICAgIF0sXG4gICAgICB0ZW1wbGF0ZToge1xuICAgICAgICBSZXNvdXJjZXM6IHtcbiAgICAgICAgICBTb21lUmVzb3VyY2U6IHtcbiAgICAgICAgICAgIFR5cGU6ICdBV1M6OlNvbWV0aGluZzo6U29tZXRoaW5nJ1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICAgIGNvbnN0IHRvb2xraXQgPSBuZXcgRmFrZVRvb2xraXQoKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCBwYXJhbXMgPSBhd2FpdCBwcmVwYXJlQXNzZXRzKHN0YWNrLCB0b29sa2l0IGFzIGFueSwgdW5kZWZpbmVkLCBbJ1NvbWVTdGFja1NvbWVSZXNvdXJjZTQ1NjcnXSk7XG5cbiAgICAvLyBUSEVOXG4gICAgdGVzdC5kZWVwRXF1YWwocGFyYW1zLCBbXG4gICAgICB7IFBhcmFtZXRlcktleTogJ0J1Y2tldFBhcmFtZXRlcicsIFVzZVByZXZpb3VzVmFsdWU6IHRydWUgfSxcbiAgICAgIHsgUGFyYW1ldGVyS2V5OiAnS2V5UGFyYW1ldGVyJywgVXNlUHJldmlvdXNWYWx1ZTogdHJ1ZSB9LFxuICAgICAgeyBQYXJhbWV0ZXJLZXk6ICdBcnRpZmFjdEhhc2hQYXJhbWV0ZXInLCBVc2VQcmV2aW91c1ZhbHVlOiB0cnVlIH0sXG4gICAgXSk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICBhc3luYyAncHJlcGFyZSBjb250YWluZXIgYXNzZXQgd2l0aCByZXVzZScodGVzdDogVGVzdCkge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSB0ZXN0U3RhY2soe1xuICAgICAgc3RhY2tOYW1lOiAnU29tZVN0YWNrJyxcbiAgICAgIGFzc2V0czogW1xuICAgICAgICB7XG4gICAgICAgICAgcGF0aDogX19kaXJuYW1lLFxuICAgICAgICAgIGlkOiAnU29tZVN0YWNrU29tZVJlc291cmNlNDU2NycsXG4gICAgICAgICAgcGFja2FnaW5nOiAnY29udGFpbmVyLWltYWdlJyxcbiAgICAgICAgICBpbWFnZU5hbWVQYXJhbWV0ZXI6ICdhc2RmJyxcbiAgICAgICAgICBzb3VyY2VIYXNoOiAnc291cmNlLWhhc2gnXG4gICAgICAgIH1cbiAgICAgIF0sXG4gICAgICB0ZW1wbGF0ZToge1xuICAgICAgICBSZXNvdXJjZXM6IHtcbiAgICAgICAgICBTb21lUmVzb3VyY2U6IHtcbiAgICAgICAgICAgIFR5cGU6ICdBV1M6OlNvbWV0aGluZzo6U29tZXRoaW5nJ1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICAgIGNvbnN0IHRvb2xraXQgPSBuZXcgRmFrZVRvb2xraXQoKTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCBwYXJhbXMgPSBhd2FpdCBwcmVwYXJlQXNzZXRzKHN0YWNrLCB0b29sa2l0IGFzIGFueSwgdW5kZWZpbmVkLCBbJ1NvbWVTdGFja1NvbWVSZXNvdXJjZTQ1NjcnXSk7XG5cbiAgICAvLyBUSEVOXG4gICAgdGVzdC5kZWVwRXF1YWwocGFyYW1zLCBbXG4gICAgICB7IFBhcmFtZXRlcktleTogJ2FzZGYnLCBVc2VQcmV2aW91c1ZhbHVlOiB0cnVlIH0sXG4gICAgXSk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfVxufTtcblxuY2xhc3MgRmFrZVRvb2xraXQge1xuICBwdWJsaWMgYnVja2V0VXJsOiBzdHJpbmcgPSAnaHR0cHM6Ly9idWNrZXQnO1xuICBwdWJsaWMgYnVja2V0TmFtZTogc3RyaW5nID0gJ2J1Y2tldCc7XG5cbiAgcHVibGljIGFzeW5jIHVwbG9hZElmQ2hhbmdlZChfZGF0YTogYW55LCBwcm9wczogVXBsb2FkUHJvcHMpOiBQcm9taXNlPFVwbG9hZGVkPiB7XG4gICAgY29uc3QgZmlsZW5hbWUgPSBgMTIzNDUke3Byb3BzLnMzS2V5U3VmZml4fWA7XG4gICAgcmV0dXJuIHtcbiAgICAgIGZpbGVuYW1lLFxuICAgICAga2V5OiBgJHtwcm9wcy5zM0tleVByZWZpeH0ke2ZpbGVuYW1lfWAsXG4gICAgICBoYXNoOiAnMTIzNDUnLFxuICAgICAgY2hhbmdlZDogdHJ1ZSxcbiAgICB9O1xuICB9XG59XG4iXX0=