"use strict";
const stream_1 = require("stream");
const string_decoder_1 = require("string_decoder");
const stacks_1 = require("../lib/api/cxapp/stacks");
const sdk_1 = require("../lib/api/util/sdk");
const cdk_toolkit_1 = require("../lib/cdk-toolkit");
const settings_1 = require("../lib/settings");
const util_1 = require("./util");
const FIXED_RESULT = util_1.testAssembly({
    stacks: [{
            stackName: 'A',
            template: { resource: 'A' },
        },
        {
            stackName: 'B',
            depends: ['A'],
            template: { resource: 'B' },
        }]
});
const appStacks = new stacks_1.AppStacks({
    configuration: new settings_1.Configuration(),
    aws: new sdk_1.SDK(),
    synthesizer: async () => FIXED_RESULT,
});
class StringWritable extends stream_1.Writable {
    constructor(options = {}) {
        super(options);
        this._decoder = new string_decoder_1.StringDecoder(options && options.defaultEncoding);
        this.data = '';
    }
    _write(chunk, encoding, callback) {
        if (encoding === 'buffer') {
            chunk = this._decoder.write(chunk);
        }
        this.data += chunk;
        callback();
    }
    _final(callback) {
        this.data += this._decoder.end();
        callback();
    }
}
module.exports = {
    async 'diff can diff multiple stacks'(test) {
        // GIVEN
        const provisioner = {
            async readCurrentTemplate(_stack) {
                return {};
            },
            async deployStack(_options) {
                return { noOp: true, outputs: {}, stackArn: '' };
            }
        };
        const toolkit = new cdk_toolkit_1.CdkToolkit({ appStacks, provisioner });
        const buffer = new StringWritable();
        // WHEN
        const exitCode = await toolkit.diff({
            stackNames: ['B'],
            stream: buffer
        });
        // THEN
        const plainTextOutput = buffer.data.replace(/\x1B\[[0-?]*[ -/]*[@-~]/g, '');
        test.ok(plainTextOutput.indexOf('Stack A') > -1, `Did not contain "Stack A": ${plainTextOutput}`);
        test.ok(plainTextOutput.indexOf('Stack B') > -1, `Did not contain "Stack B": ${plainTextOutput}`);
        test.equals(1, exitCode);
        test.done();
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5kaWZmLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGVzdC5kaWZmLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFFQSxtQ0FBa0M7QUFDbEMsbURBQW1FO0FBRW5FLG9EQUFvRDtBQUVwRCw2Q0FBMEM7QUFDMUMsb0RBQWdEO0FBQ2hELDhDQUFnRDtBQUNoRCxpQ0FBc0M7QUFFdEMsTUFBTSxZQUFZLEdBQUcsbUJBQVksQ0FBQztJQUNoQyxNQUFNLEVBQUUsQ0FBQztZQUNQLFNBQVMsRUFBRSxHQUFHO1lBQ2QsUUFBUSxFQUFFLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRTtTQUM1QjtRQUNEO1lBQ0UsU0FBUyxFQUFFLEdBQUc7WUFDZCxPQUFPLEVBQUUsQ0FBQyxHQUFHLENBQUM7WUFDZCxRQUFRLEVBQUUsRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFO1NBQzVCLENBQUM7Q0FDSCxDQUFDLENBQUM7QUFFSCxNQUFNLFNBQVMsR0FBRyxJQUFJLGtCQUFTLENBQUM7SUFDOUIsYUFBYSxFQUFFLElBQUksd0JBQWEsRUFBRTtJQUNsQyxHQUFHLEVBQUUsSUFBSSxTQUFHLEVBQUU7SUFDZCxXQUFXLEVBQUUsS0FBSyxJQUFJLEVBQUUsQ0FBQyxZQUFZO0NBQ3RDLENBQUMsQ0FBQztBQWlDSCxNQUFNLGNBQWUsU0FBUSxpQkFBUTtJQUluQyxZQUFZLFVBQWUsRUFBRTtRQUMzQixLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDZixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksOEJBQWEsQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ3RFLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ2pCLENBQUM7SUFFTSxNQUFNLENBQUMsS0FBVSxFQUFFLFFBQWdCLEVBQUUsUUFBNkM7UUFDdkYsSUFBSSxRQUFRLEtBQUssUUFBUSxFQUFFO1lBQ3pCLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNwQztRQUNELElBQUksQ0FBQyxJQUFJLElBQUksS0FBSyxDQUFDO1FBQ25CLFFBQVEsRUFBRSxDQUFDO0lBQ2IsQ0FBQztJQUVNLE1BQU0sQ0FBQyxRQUF3QztRQUNwRCxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDakMsUUFBUSxFQUFFLENBQUM7SUFDYixDQUFDO0NBQ0Y7QUFyREQsaUJBQVM7SUFDUCxLQUFLLENBQUMsK0JBQStCLENBQUMsSUFBVTtRQUM5QyxRQUFRO1FBQ1IsTUFBTSxXQUFXLEdBQXNCO1lBQ3JDLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxNQUF5QztnQkFDakUsT0FBTyxFQUFFLENBQUM7WUFDWixDQUFDO1lBQ0QsS0FBSyxDQUFDLFdBQVcsQ0FBQyxRQUE0QjtnQkFDNUMsT0FBTyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFDLENBQUM7WUFDbEQsQ0FBQztTQUNGLENBQUM7UUFDRixNQUFNLE9BQU8sR0FBRyxJQUFJLHdCQUFVLENBQUMsRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUMzRCxNQUFNLE1BQU0sR0FBRyxJQUFJLGNBQWMsRUFBRSxDQUFDO1FBRXBDLE9BQU87UUFDUCxNQUFNLFFBQVEsR0FBRyxNQUFNLE9BQU8sQ0FBQyxJQUFJLENBQUM7WUFDbEMsVUFBVSxFQUFFLENBQUMsR0FBRyxDQUFDO1lBQ2pCLE1BQU0sRUFBRSxNQUFNO1NBQ2YsQ0FBQyxDQUFDO1FBRUgsT0FBTztRQUNQLE1BQU0sZUFBZSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLDBCQUEwQixFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQzVFLElBQUksQ0FBQyxFQUFFLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSw4QkFBOEIsZUFBZSxFQUFFLENBQUMsQ0FBQztRQUNsRyxJQUFJLENBQUMsRUFBRSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsOEJBQThCLGVBQWUsRUFBRSxDQUFDLENBQUM7UUFFbEcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFFekIsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2QsQ0FBQztDQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY3hhcGkgPSByZXF1aXJlKCdAYXdzLWNkay9jeC1hcGknKTtcbmltcG9ydCB7IFRlc3QgfSBmcm9tICdub2RldW5pdCc7XG5pbXBvcnQgeyBXcml0YWJsZSB9IGZyb20gJ3N0cmVhbSc7XG5pbXBvcnQgeyBOb2RlU3RyaW5nRGVjb2RlciwgU3RyaW5nRGVjb2RlciAgfSBmcm9tICdzdHJpbmdfZGVjb2Rlcic7XG5pbXBvcnQgeyBEZXBsb3lTdGFja09wdGlvbnMsIERlcGxveVN0YWNrUmVzdWx0IH0gZnJvbSAnLi4vbGliJztcbmltcG9ydCB7IEFwcFN0YWNrcyB9IGZyb20gJy4uL2xpYi9hcGkvY3hhcHAvc3RhY2tzJztcbmltcG9ydCB7IElEZXBsb3ltZW50VGFyZ2V0LCBUZW1wbGF0ZSB9IGZyb20gJy4uL2xpYi9hcGkvZGVwbG95bWVudC10YXJnZXQnO1xuaW1wb3J0IHsgU0RLIH0gZnJvbSAnLi4vbGliL2FwaS91dGlsL3Nkayc7XG5pbXBvcnQgeyBDZGtUb29sa2l0IH0gZnJvbSAnLi4vbGliL2Nkay10b29sa2l0JztcbmltcG9ydCB7IENvbmZpZ3VyYXRpb24gfSBmcm9tICcuLi9saWIvc2V0dGluZ3MnO1xuaW1wb3J0IHsgdGVzdEFzc2VtYmx5IH0gZnJvbSAnLi91dGlsJztcblxuY29uc3QgRklYRURfUkVTVUxUID0gdGVzdEFzc2VtYmx5KHtcbiAgc3RhY2tzOiBbe1xuICAgIHN0YWNrTmFtZTogJ0EnLFxuICAgIHRlbXBsYXRlOiB7IHJlc291cmNlOiAnQScgfSxcbiAgfSxcbiAge1xuICAgIHN0YWNrTmFtZTogJ0InLFxuICAgIGRlcGVuZHM6IFsnQSddLFxuICAgIHRlbXBsYXRlOiB7IHJlc291cmNlOiAnQicgfSxcbiAgfV1cbn0pO1xuXG5jb25zdCBhcHBTdGFja3MgPSBuZXcgQXBwU3RhY2tzKHtcbiAgY29uZmlndXJhdGlvbjogbmV3IENvbmZpZ3VyYXRpb24oKSxcbiAgYXdzOiBuZXcgU0RLKCksXG4gIHN5bnRoZXNpemVyOiBhc3luYyAoKSA9PiBGSVhFRF9SRVNVTFQsXG59KTtcblxuZXhwb3J0ID0ge1xuICBhc3luYyAnZGlmZiBjYW4gZGlmZiBtdWx0aXBsZSBzdGFja3MnKHRlc3Q6IFRlc3QpIHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHByb3Zpc2lvbmVyOiBJRGVwbG95bWVudFRhcmdldCA9IHtcbiAgICAgIGFzeW5jIHJlYWRDdXJyZW50VGVtcGxhdGUoX3N0YWNrOiBjeGFwaS5DbG91ZEZvcm1hdGlvblN0YWNrQXJ0aWZhY3QpOiBQcm9taXNlPFRlbXBsYXRlPiB7XG4gICAgICAgIHJldHVybiB7fTtcbiAgICAgIH0sXG4gICAgICBhc3luYyBkZXBsb3lTdGFjayhfb3B0aW9uczogRGVwbG95U3RhY2tPcHRpb25zKTogUHJvbWlzZTxEZXBsb3lTdGFja1Jlc3VsdD4ge1xuICAgICAgICByZXR1cm4geyBub09wOiB0cnVlLCBvdXRwdXRzOiB7fSwgc3RhY2tBcm46ICcnfTtcbiAgICAgIH1cbiAgICB9O1xuICAgIGNvbnN0IHRvb2xraXQgPSBuZXcgQ2RrVG9vbGtpdCh7IGFwcFN0YWNrcywgcHJvdmlzaW9uZXIgfSk7XG4gICAgY29uc3QgYnVmZmVyID0gbmV3IFN0cmluZ1dyaXRhYmxlKCk7XG5cbiAgICAvLyBXSEVOXG4gICAgY29uc3QgZXhpdENvZGUgPSBhd2FpdCB0b29sa2l0LmRpZmYoe1xuICAgICAgc3RhY2tOYW1lczogWydCJ10sXG4gICAgICBzdHJlYW06IGJ1ZmZlclxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGNvbnN0IHBsYWluVGV4dE91dHB1dCA9IGJ1ZmZlci5kYXRhLnJlcGxhY2UoL1xceDFCXFxbWzAtP10qWyAtL10qW0Atfl0vZywgJycpO1xuICAgIHRlc3Qub2socGxhaW5UZXh0T3V0cHV0LmluZGV4T2YoJ1N0YWNrIEEnKSA+IC0xLCBgRGlkIG5vdCBjb250YWluIFwiU3RhY2sgQVwiOiAke3BsYWluVGV4dE91dHB1dH1gKTtcbiAgICB0ZXN0Lm9rKHBsYWluVGV4dE91dHB1dC5pbmRleE9mKCdTdGFjayBCJykgPiAtMSwgYERpZCBub3QgY29udGFpbiBcIlN0YWNrIEJcIjogJHtwbGFpblRleHRPdXRwdXR9YCk7XG5cbiAgICB0ZXN0LmVxdWFscygxLCBleGl0Q29kZSk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcbn07XG5cbmNsYXNzIFN0cmluZ1dyaXRhYmxlIGV4dGVuZHMgV3JpdGFibGUge1xuICBwdWJsaWMgZGF0YTogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IF9kZWNvZGVyOiBOb2RlU3RyaW5nRGVjb2RlcjtcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBhbnkgPSB7fSkge1xuICAgIHN1cGVyKG9wdGlvbnMpO1xuICAgIHRoaXMuX2RlY29kZXIgPSBuZXcgU3RyaW5nRGVjb2RlcihvcHRpb25zICYmIG9wdGlvbnMuZGVmYXVsdEVuY29kaW5nKTtcbiAgICB0aGlzLmRhdGEgPSAnJztcbiAgfVxuXG4gIHB1YmxpYyBfd3JpdGUoY2h1bms6IGFueSwgZW5jb2Rpbmc6IHN0cmluZywgY2FsbGJhY2s6IChlcnJvcj86IEVycm9yIHwgdW5kZWZpbmVkKSA9PiB2b2lkKSB7XG4gICAgaWYgKGVuY29kaW5nID09PSAnYnVmZmVyJykge1xuICAgICAgY2h1bmsgPSB0aGlzLl9kZWNvZGVyLndyaXRlKGNodW5rKTtcbiAgICB9XG4gICAgdGhpcy5kYXRhICs9IGNodW5rO1xuICAgIGNhbGxiYWNrKCk7XG4gIH1cblxuICBwdWJsaWMgX2ZpbmFsKGNhbGxiYWNrOiAoZXJyb3I/OiBFcnJvciB8IG51bGwpID0+IHZvaWQpIHtcbiAgICB0aGlzLmRhdGEgKz0gdGhpcy5fZGVjb2Rlci5lbmQoKTtcbiAgICBjYWxsYmFjaygpO1xuICB9XG59XG4iXX0=