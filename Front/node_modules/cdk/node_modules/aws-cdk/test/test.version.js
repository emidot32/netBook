"use strict";
const fs = require("fs-extra");
const os = require("os");
const path = require("path");
const sinon = require("sinon");
const timers_1 = require("timers");
const util_1 = require("util");
const version_1 = require("../lib/version");
const setTimeout = util_1.promisify(timers_1.setTimeout);
function tmpfile() {
    return `/tmp/version-${Math.floor(Math.random() * 10000)}`;
}
module.exports = {
    'tearDown'(callback) {
        sinon.restore();
        callback();
    },
    'initialization fails on unwritable directory'(test) {
        test.expect(1);
        const cacheFile = tmpfile();
        sinon.stub(fs, 'mkdirsSync').withArgs(path.dirname(cacheFile)).throws('Cannot make directory');
        test.throws(() => new version_1.VersionCheckTTL(cacheFile), /not writable/);
        test.done();
    },
    async 'cache file responds correctly when file is not present'(test) {
        test.expect(1);
        const cache = new version_1.VersionCheckTTL(tmpfile(), 1);
        test.strictEqual(await cache.hasExpired(), true);
        test.done();
    },
    async 'cache file honours the specified TTL'(test) {
        test.expect(2);
        const cache = new version_1.VersionCheckTTL(tmpfile(), 1);
        await cache.update();
        test.strictEqual(await cache.hasExpired(), false);
        await setTimeout(1001); // Just above 1 sec in ms
        test.strictEqual(await cache.hasExpired(), true);
        test.done();
    },
    async 'Skip version check if cache has not expired'(test) {
        test.expect(1);
        const cache = new version_1.VersionCheckTTL(tmpfile(), 100);
        await cache.update();
        test.equal(await version_1.latestVersionIfHigher('0.0.0', cache), null);
        test.done();
    },
    async 'Return later version when exists & skip recent re-check'(test) {
        test.expect(3);
        const cache = new version_1.VersionCheckTTL(tmpfile(), 100);
        const result = await version_1.latestVersionIfHigher('0.0.0', cache);
        test.notEqual(result, null);
        test.ok(result.length > 0);
        const result2 = await version_1.latestVersionIfHigher('0.0.0', cache);
        test.equal(result2, null);
        test.done();
    },
    async 'Return null if version is higher than npm'(test) {
        test.expect(1);
        const cache = new version_1.VersionCheckTTL(tmpfile(), 100);
        const result = await version_1.latestVersionIfHigher('100.100.100', cache);
        test.equal(result, null);
        test.done();
    },
    'No homedir for the given user'(test) {
        test.expect(1);
        sinon.stub(os, 'homedir').returns('');
        sinon.stub(os, 'userInfo').returns({ username: '', uid: 10, gid: 11, shell: null, homedir: '' });
        test.throws(() => new version_1.VersionCheckTTL(), /Cannot determine home directory/);
        test.done();
    },
    async 'Version specified is stored in the TTL file'(test) {
        test.expect(1);
        const cacheFile = tmpfile();
        const cache = new version_1.VersionCheckTTL(cacheFile, 1);
        await cache.update('1.1.1');
        const storedVersion = fs.readFileSync(cacheFile, 'utf8');
        test.equal(storedVersion, '1.1.1');
        test.done();
    },
    async 'No Version specified for storage in the TTL file'(test) {
        test.expect(1);
        const cacheFile = tmpfile();
        const cache = new version_1.VersionCheckTTL(cacheFile, 1);
        await cache.update();
        const storedVersion = fs.readFileSync(cacheFile, 'utf8');
        test.equal(storedVersion, '');
        test.done();
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC52ZXJzaW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGVzdC52ZXJzaW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSwrQkFBZ0M7QUFFaEMseUJBQTBCO0FBQzFCLDZCQUE4QjtBQUM5QiwrQkFBZ0M7QUFDaEMsbUNBQW1EO0FBQ25ELCtCQUFpQztBQUNqQyw0Q0FBd0U7QUFFeEUsTUFBTSxVQUFVLEdBQUcsZ0JBQVMsQ0FBQyxtQkFBVyxDQUFDLENBQUM7QUFFMUMsU0FBUyxPQUFPO0lBQ2QsT0FBTyxnQkFBZ0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLEVBQUUsQ0FBQztBQUM3RCxDQUFDO0FBRUQsaUJBQVM7SUFDUCxVQUFVLENBQUMsUUFBb0I7UUFDN0IsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ2hCLFFBQVEsRUFBRSxDQUFDO0lBQ2IsQ0FBQztJQUVELDhDQUE4QyxDQUFDLElBQVU7UUFDdkQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNmLE1BQU0sU0FBUyxHQUFHLE9BQU8sRUFBRSxDQUFDO1FBQzVCLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLFlBQVksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFDL0YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLHlCQUFlLENBQUMsU0FBUyxDQUFDLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFDbEUsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUVELEtBQUssQ0FBQyx3REFBd0QsQ0FBQyxJQUFVO1FBQ3ZFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDZixNQUFNLEtBQUssR0FBRyxJQUFJ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QUM7UUFDekQsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDOUIsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2QsQ0FBQztDQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgPSByZXF1aXJlKCdmcy1leHRyYScpO1xuaW1wb3J0IHsgVGVzdCB9IGZyb20gJ25vZGV1bml0JztcbmltcG9ydCBvcyA9IHJlcXVpcmUoJ29zJyk7XG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmltcG9ydCBzaW5vbiA9IHJlcXVpcmUoJ3Npbm9uJyk7XG5pbXBvcnQgeyBzZXRUaW1lb3V0IGFzIF9zZXRUaW1lb3V0IH0gZnJvbSAndGltZXJzJztcbmltcG9ydCB7IHByb21pc2lmeSB9IGZyb20gJ3V0aWwnO1xuaW1wb3J0IHsgbGF0ZXN0VmVyc2lvbklmSGlnaGVyLCBWZXJzaW9uQ2hlY2tUVEwgfSBmcm9tICcuLi9saWIvdmVyc2lvbic7XG5cbmNvbnN0IHNldFRpbWVvdXQgPSBwcm9taXNpZnkoX3NldFRpbWVvdXQpO1xuXG5mdW5jdGlvbiB0bXBmaWxlKCk6IHN0cmluZyB7XG4gIHJldHVybiBgL3RtcC92ZXJzaW9uLSR7TWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMTAwMDApfWA7XG59XG5cbmV4cG9ydCA9IHtcbiAgJ3RlYXJEb3duJyhjYWxsYmFjazogKCkgPT4gdm9pZCkge1xuICAgIHNpbm9uLnJlc3RvcmUoKTtcbiAgICBjYWxsYmFjaygpO1xuICB9LFxuXG4gICdpbml0aWFsaXphdGlvbiBmYWlscyBvbiB1bndyaXRhYmxlIGRpcmVjdG9yeScodGVzdDogVGVzdCkge1xuICAgIHRlc3QuZXhwZWN0KDEpO1xuICAgIGNvbnN0IGNhY2hlRmlsZSA9IHRtcGZpbGUoKTtcbiAgICBzaW5vbi5zdHViKGZzLCAnbWtkaXJzU3luYycpLndpdGhBcmdzKHBhdGguZGlybmFtZShjYWNoZUZpbGUpKS50aHJvd3MoJ0Nhbm5vdCBtYWtlIGRpcmVjdG9yeScpO1xuICAgIHRlc3QudGhyb3dzKCgpID0+IG5ldyBWZXJzaW9uQ2hlY2tUVEwoY2FjaGVGaWxlKSwgL25vdCB3cml0YWJsZS8pO1xuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gIGFzeW5jICdjYWNoZSBmaWxlIHJlc3BvbmRzIGNvcnJlY3RseSB3aGVuIGZpbGUgaXMgbm90IHByZXNlbnQnKHRlc3Q6IFRlc3QpIHtcbiAgICB0ZXN0LmV4cGVjdCgxKTtcbiAgICBjb25zdCBjYWNoZSA9IG5ldyBWZXJzaW9uQ2hlY2tUVEwodG1wZmlsZSgpLCAxKTtcbiAgICB0ZXN0LnN0cmljdEVxdWFsKGF3YWl0IGNhY2hlLmhhc0V4cGlyZWQoKSwgdHJ1ZSk7XG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgYXN5bmMgJ2NhY2hlIGZpbGUgaG9ub3VycyB0aGUgc3BlY2lmaWVkIFRUTCcodGVzdDogVGVzdCkge1xuICAgIHRlc3QuZXhwZWN0KDIpO1xuICAgIGNvbnN0IGNhY2hlID0gbmV3IFZlcnNpb25DaGVja1RUTCh0bXBmaWxlKCksIDEpO1xuICAgIGF3YWl0IGNhY2hlLnVwZGF0ZSgpO1xuICAgIHRlc3Quc3RyaWN0RXF1YWwoYXdhaXQgY2FjaGUuaGFzRXhwaXJlZCgpLCBmYWxzZSk7XG4gICAgYXdhaXQgc2V0VGltZW91dCgxMDAxKTsgLy8gSnVzdCBhYm92ZSAxIHNlYyBpbiBtc1xuICAgIHRlc3Quc3RyaWN0RXF1YWwoYXdhaXQgY2FjaGUuaGFzRXhwaXJlZCgpLCB0cnVlKTtcbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICBhc3luYyAnU2tpcCB2ZXJzaW9uIGNoZWNrIGlmIGNhY2hlIGhhcyBub3QgZXhwaXJlZCcodGVzdDogVGVzdCkge1xuICAgIHRlc3QuZXhwZWN0KDEpO1xuICAgIGNvbnN0IGNhY2hlID0gbmV3IFZlcnNpb25DaGVja1RUTCh0bXBmaWxlKCksIDEwMCk7XG4gICAgYXdhaXQgY2FjaGUudXBkYXRlKCk7XG4gICAgdGVzdC5lcXVhbChhd2FpdCBsYXRlc3RWZXJzaW9uSWZIaWdoZXIoJzAuMC4wJywgY2FjaGUpLCBudWxsKTtcbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICBhc3luYyAnUmV0dXJuIGxhdGVyIHZlcnNpb24gd2hlbiBleGlzdHMgJiBza2lwIHJlY2VudCByZS1jaGVjaycodGVzdDogVGVzdCkge1xuICAgIHRlc3QuZXhwZWN0KDMpO1xuICAgIGNvbnN0IGNhY2hlID0gbmV3IFZlcnNpb25DaGVja1RUTCh0bXBmaWxlKCksIDEwMCk7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgbGF0ZXN0VmVyc2lvbklmSGlnaGVyKCcwLjAuMCcsIGNhY2hlKTtcbiAgICB0ZXN0Lm5vdEVxdWFsKHJlc3VsdCwgbnVsbCk7XG4gICAgdGVzdC5vaygocmVzdWx0IGFzIHN0cmluZykubGVuZ3RoID4gMCk7XG5cbiAgICBjb25zdCByZXN1bHQyID0gYXdhaXQgbGF0ZXN0VmVyc2lvbklmSGlnaGVyKCcwLjAuMCcsIGNhY2hlKTtcbiAgICB0ZXN0LmVxdWFsKHJlc3VsdDIsIG51bGwpO1xuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gIGFzeW5jICdSZXR1cm4gbnVsbCBpZiB2ZXJzaW9uIGlzIGhpZ2hlciB0aGFuIG5wbScodGVzdDogVGVzdCkge1xuICAgIHRlc3QuZXhwZWN0KDEpO1xuICAgIGNvbnN0IGNhY2hlID0gbmV3IFZlcnNpb25DaGVja1RUTCh0bXBmaWxlKCksIDEwMCk7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgbGF0ZXN0VmVyc2lvbklmSGlnaGVyKCcxMDAuMTAwLjEwMCcsIGNhY2hlKTtcbiAgICB0ZXN0LmVxdWFsKHJlc3VsdCwgbnVsbCk7XG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgJ05vIGhvbWVkaXIgZm9yIHRoZSBnaXZlbiB1c2VyJyh0ZXN0OiBUZXN0KSB7XG4gICAgdGVzdC5leHBlY3QoMSk7XG4gICAgc2lub24uc3R1YihvcywgJ2hvbWVkaXInKS5yZXR1cm5zKCcnKTtcbiAgICBzaW5vbi5zdHViKG9zLCAndXNlckluZm8nKS5yZXR1cm5zKHsgdXNlcm5hbWU6ICcnLCB1aWQ6IDEwLCBnaWQ6IDExLCBzaGVsbDogbnVsbCwgaG9tZWRpcjogJyd9KTtcbiAgICB0ZXN0LnRocm93cygoKSA9PiBuZXcgVmVyc2lvbkNoZWNrVFRMKCksIC9DYW5ub3QgZGV0ZXJtaW5lIGhvbWUgZGlyZWN0b3J5Lyk7XG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgYXN5bmMgJ1ZlcnNpb24gc3BlY2lmaWVkIGlzIHN0b3JlZCBpbiB0aGUgVFRMIGZpbGUnKHRlc3Q6IFRlc3QpIHtcbiAgICB0ZXN0LmV4cGVjdCgxKTtcbiAgICBjb25zdCBjYWNoZUZpbGUgPSB0bXBmaWxlKCk7XG4gICAgY29uc3QgY2FjaGUgPSBuZXcgVmVyc2lvbkNoZWNrVFRMKGNhY2hlRmlsZSwgMSk7XG4gICAgYXdhaXQgY2FjaGUudXBkYXRlKCcxLjEuMScpO1xuICAgIGNvbnN0IHN0b3JlZFZlcnNpb24gPSBmcy5yZWFkRmlsZVN5bmMoY2FjaGVGaWxlLCAndXRmOCcpO1xuICAgIHRlc3QuZXF1YWwoc3RvcmVkVmVyc2lvbiwgJzEuMS4xJyk7XG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgYXN5bmMgJ05vIFZlcnNpb24gc3BlY2lmaWVkIGZvciBzdG9yYWdlIGluIHRoZSBUVEwgZmlsZScodGVzdDogVGVzdCkge1xuICAgIHRlc3QuZXhwZWN0KDEpO1xuICAgIGNvbnN0IGNhY2hlRmlsZSA9IHRtcGZpbGUoKTtcbiAgICBjb25zdCBjYWNoZSA9IG5ldyBWZXJzaW9uQ2hlY2tUVEwoY2FjaGVGaWxlLCAxKTtcbiAgICBhd2FpdCBjYWNoZS51cGRhdGUoKTtcbiAgICBjb25zdCBzdG9yZWRWZXJzaW9uID0gZnMucmVhZEZpbGVTeW5jKGNhY2hlRmlsZSwgJ3V0ZjgnKTtcbiAgICB0ZXN0LmVxdWFsKHN0b3JlZFZlcnNpb24sICcnKTtcbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcbn07XG4iXX0=