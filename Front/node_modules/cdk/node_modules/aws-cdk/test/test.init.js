"use strict";
const cxapi = require("@aws-cdk/cx-api");
const fs = require("fs-extra");
const os = require("os");
const path = require("path");
const init_1 = require("../lib/init");
const state = {};
async function newTempWorkDir() {
    const newDir = await fs.mkdtemp(path.join(os.tmpdir(), 'aws-cdk-test'));
    process.chdir(newDir);
    return newDir;
}
module.exports = {
    async "setUp"(callback) {
        state.previousWorkingDir = process.cwd();
        state.tempDir = await newTempWorkDir();
        // tslint:disable-next-line:no-console
        console.log('Temporary working directory:', state.tempDir);
        callback();
    },
    async "tearDown"(callback) {
        // tslint:disable-next-line:no-console
        console.log('Switching back to', state.previousWorkingDir, 'cleaning up', state.tempDir);
        process.chdir(state.previousWorkingDir);
        await fs.remove(state.tempDir);
        callback();
    },
    async 'create a TypeScript library project'(test) {
        await init_1.cliInit('lib', 'typescript', false);
        // Check that package.json and lib/ got created in the current directory
        test.equal(true, await fs.pathExists('package.json'));
        test.equal(true, await fs.pathExists('lib'));
        test.done();
    },
    async 'create a TypeScript app project'(test) {
        await init_1.cliInit('app', 'typescript', false);
        // Check that package.json and bin/ got created in the current directory
        test.equal(true, await fs.pathExists('package.json'));
        test.equal(true, await fs.pathExists('bin'));
        test.done();
    },
    async 'create a JavaScript app project'(test) {
        await init_1.cliInit('app', 'javascript', false);
        // Check that package.json and bin/ got created in the current directory
        test.equal(true, await fs.pathExists('package.json'));
        test.equal(true, await fs.pathExists('bin'));
        test.done();
    },
    async 'git directory does not throw off the initer!'(test) {
        fs.mkdirSync('.git');
        await init_1.cliInit('app', 'typescript', false);
        // Check that package.json and bin/ got created in the current directory
        test.equal(true, await fs.pathExists('package.json'));
        test.equal(true, await fs.pathExists('bin'));
        test.done();
    },
    async 'verify "future flags" are added to cdk.json'(test) {
        for (const templ of await init_1.availableInitTemplates) {
            for (const lang of templ.languages) {
                const prevdir = process.cwd();
                try {
                    await newTempWorkDir();
                    await init_1.cliInit(templ.name, lang, 
                    /* canUseNetwork */ false, 
                    /* generateOnly */ true);
                    // ok if template doesn't have a cdk.json file (e.g. the "lib" template)
                    if (!await fs.pathExists('cdk.json')) {
                        continue;
                    }
                    const config = await fs.readJson('cdk.json');
                    const context = config.context || {};
                    for (const [key, expected] of Object.entries(cxapi.FUTURE_FLAGS)) {
                        const actual = context[key];
                        test.equal(actual, expected, `expected future flag "${key}=${expected}" in generated cdk.json for ${templ.name}/${lang} but got "${actual}"`);
                    }
                }
                finally {
                    process.chdir(prevdir);
                }
            }
        }
        test.done();
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5pbml0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGVzdC5pbml0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSx5Q0FBMEM7QUFDMUMsK0JBQWdDO0FBRWhDLHlCQUEwQjtBQUMxQiw2QkFBOEI7QUFDOUIsc0NBQThEO0FBRTlELE1BQU0sS0FBSyxHQUdQLEVBQUUsQ0FBQztBQWdHUCxLQUFLLFVBQVUsY0FBYztJQUMzQixNQUFNLE1BQU0sR0FBRyxNQUFNLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLEVBQUUsY0FBYyxDQUFDLENBQUMsQ0FBQztJQUN4RSxPQUFPLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3RCLE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUM7QUFsR0QsaUJBQVM7SUFDUCxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQW9CO1FBQ2hDLEtBQUssQ0FBQyxrQkFBa0IsR0FBRyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDekMsS0FBSyxDQUFDLE9BQU8sR0FBRyxNQUFNLGNBQWMsRUFBRSxDQUFDO1FBQ3ZDLHNDQUFzQztRQUN0QyxPQUFPLENBQUMsR0FBRyxDQUFDLDhCQUE4QixFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMzRCxRQUFRLEVBQUUsQ0FBQztJQUNiLENBQUM7SUFFRCxLQUFLLENBQUMsVUFBVSxDQUFDLFFBQW9CO1FBQ25DLHNDQUFzQztRQUN0QyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixFQUFFLEtBQUssQ0FBQyxrQkFBa0IsRUFBRSxhQUFhLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3pGLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLGtCQUFtQixDQUFDLENBQUM7UUFDekMsTUFBTSxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFRLENBQUMsQ0FBQztR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b0JBQ3JDLEtBQUssTUFBTSxDQUFFLEdBQUcsRUFBRSxRQUFRLENBQUUsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsRUFBRTt3QkFDbEUsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO3dCQUM1QixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxRQUFRLEVBQ3pCLHlCQUF5QixHQUFHLElBQUksUUFBUSwrQkFBK0IsS0FBSyxDQUFDLElBQUksSUFBSSxJQUFJLGFBQWEsTUFBTSxHQUFHLENBQUMsQ0FBQztxQkFDcEg7aUJBRUY7d0JBQVM7b0JBQ1IsT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztpQkFDeEI7YUFDRjtTQUNGO1FBRUQsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2QsQ0FBQztDQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY3hhcGkgPSByZXF1aXJlKCdAYXdzLWNkay9jeC1hcGknKTtcbmltcG9ydCBmcyA9IHJlcXVpcmUoJ2ZzLWV4dHJhJyk7XG5pbXBvcnQgeyBUZXN0IH0gZnJvbSAnbm9kZXVuaXQnO1xuaW1wb3J0IG9zID0gcmVxdWlyZSgnb3MnKTtcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuaW1wb3J0IHsgYXZhaWxhYmxlSW5pdFRlbXBsYXRlcywgY2xpSW5pdCB9IGZyb20gJy4uL2xpYi9pbml0JztcblxuY29uc3Qgc3RhdGU6IHtcbiAgcHJldmlvdXNXb3JraW5nRGlyPzogc3RyaW5nO1xuICB0ZW1wRGlyPzogc3RyaW5nO1xufSA9IHt9O1xuXG5leHBvcnQgPSB7XG4gIGFzeW5jIFwic2V0VXBcIihjYWxsYmFjazogKCkgPT4gdm9pZCkge1xuICAgIHN0YXRlLnByZXZpb3VzV29ya2luZ0RpciA9IHByb2Nlc3MuY3dkKCk7XG4gICAgc3RhdGUudGVtcERpciA9IGF3YWl0IG5ld1RlbXBXb3JrRGlyKCk7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWNvbnNvbGVcbiAgICBjb25zb2xlLmxvZygnVGVtcG9yYXJ5IHdvcmtpbmcgZGlyZWN0b3J5OicsIHN0YXRlLnRlbXBEaXIpO1xuICAgIGNhbGxiYWNrKCk7XG4gIH0sXG5cbiAgYXN5bmMgXCJ0ZWFyRG93blwiKGNhbGxiYWNrOiAoKSA9PiB2b2lkKSB7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWNvbnNvbGVcbiAgICBjb25zb2xlLmxvZygnU3dpdGNoaW5nIGJhY2sgdG8nLCBzdGF0ZS5wcmV2aW91c1dvcmtpbmdEaXIsICdjbGVhbmluZyB1cCcsIHN0YXRlLnRlbXBEaXIpO1xuICAgIHByb2Nlc3MuY2hkaXIoc3RhdGUucHJldmlvdXNXb3JraW5nRGlyISk7XG4gICAgYXdhaXQgZnMucmVtb3ZlKHN0YXRlLnRlbXBEaXIhKTtcblxuICAgIGNhbGxiYWNrKCk7XG4gIH0sXG5cbiAgYXN5bmMgJ2NyZWF0ZSBhIFR5cGVTY3JpcHQgbGlicmFyeSBwcm9qZWN0Jyh0ZXN0OiBUZXN0KSB7XG4gICAgYXdhaXQgY2xpSW5pdCgnbGliJywgJ3R5cGVzY3JpcHQnLCBmYWxzZSk7XG5cbiAgICAvLyBDaGVjayB0aGF0IHBhY2thZ2UuanNvbiBhbmQgbGliLyBnb3QgY3JlYXRlZCBpbiB0aGUgY3VycmVudCBkaXJlY3RvcnlcbiAgICB0ZXN0LmVxdWFsKHRydWUsIGF3YWl0IGZzLnBhdGhFeGlzdHMoJ3BhY2thZ2UuanNvbicpKTtcbiAgICB0ZXN0LmVxdWFsKHRydWUsIGF3YWl0IGZzLnBhdGhFeGlzdHMoJ2xpYicpKTtcblxuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gIGFzeW5jICdjcmVhdGUgYSBUeXBlU2NyaXB0IGFwcCBwcm9qZWN0Jyh0ZXN0OiBUZXN0KSB7XG4gICAgYXdhaXQgY2xpSW5pdCgnYXBwJywgJ3R5cGVzY3JpcHQnLCBmYWxzZSk7XG5cbiAgICAvLyBDaGVjayB0aGF0IHBhY2thZ2UuanNvbiBhbmQgYmluLyBnb3QgY3JlYXRlZCBpbiB0aGUgY3VycmVudCBkaXJlY3RvcnlcbiAgICB0ZXN0LmVxdWFsKHRydWUsIGF3YWl0IGZzLnBhdGhFeGlzdHMoJ3BhY2thZ2UuanNvbicpKTtcbiAgICB0ZXN0LmVxdWFsKHRydWUsIGF3YWl0IGZzLnBhdGhFeGlzdHMoJ2JpbicpKTtcblxuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gIGFzeW5jICdjcmVhdGUgYSBKYXZhU2NyaXB0IGFwcCBwcm9qZWN0Jyh0ZXN0OiBUZXN0KSB7XG4gICAgYXdhaXQgY2xpSW5pdCgnYXBwJywgJ2phdmFzY3JpcHQnLCBmYWxzZSk7XG5cbiAgICAvLyBDaGVjayB0aGF0IHBhY2thZ2UuanNvbiBhbmQgYmluLyBnb3QgY3JlYXRlZCBpbiB0aGUgY3VycmVudCBkaXJlY3RvcnlcbiAgICB0ZXN0LmVxdWFsKHRydWUsIGF3YWl0IGZzLnBhdGhFeGlzdHMoJ3BhY2thZ2UuanNvbicpKTtcbiAgICB0ZXN0LmVxdWFsKHRydWUsIGF3YWl0IGZzLnBhdGhFeGlzdHMoJ2JpbicpKTtcblxuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gIGFzeW5jICdnaXQgZGlyZWN0b3J5IGRvZXMgbm90IHRocm93IG9mZiB0aGUgaW5pdGVyIScodGVzdDogVGVzdCkge1xuICAgIGZzLm1rZGlyU3luYygnLmdpdCcpO1xuXG4gICAgYXdhaXQgY2xpSW5pdCgnYXBwJywgJ3R5cGVzY3JpcHQnLCBmYWxzZSk7XG5cbiAgICAvLyBDaGVjayB0aGF0IHBhY2thZ2UuanNvbiBhbmQgYmluLyBnb3QgY3JlYXRlZCBpbiB0aGUgY3VycmVudCBkaXJlY3RvcnlcbiAgICB0ZXN0LmVxdWFsKHRydWUsIGF3YWl0IGZzLnBhdGhFeGlzdHMoJ3BhY2thZ2UuanNvbicpKTtcbiAgICB0ZXN0LmVxdWFsKHRydWUsIGF3YWl0IGZzLnBhdGhFeGlzdHMoJ2JpbicpKTtcblxuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gIGFzeW5jICd2ZXJpZnkgXCJmdXR1cmUgZmxhZ3NcIiBhcmUgYWRkZWQgdG8gY2RrLmpzb24nKHRlc3Q6IFRlc3QpIHtcbiAgICBmb3IgKGNvbnN0IHRlbXBsIG9mIGF3YWl0IGF2YWlsYWJsZUluaXRUZW1wbGF0ZXMpIHtcbiAgICAgIGZvciAoY29uc3QgbGFuZyBvZiB0ZW1wbC5sYW5ndWFnZXMpIHtcbiAgICAgICAgY29uc3QgcHJldmRpciA9IHByb2Nlc3MuY3dkKCk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgYXdhaXQgbmV3VGVtcFdvcmtEaXIoKTtcblxuICAgICAgICAgIGF3YWl0IGNsaUluaXQodGVtcGwubmFtZSwgbGFuZyxcbiAgICAgICAgICAgIC8qIGNhblVzZU5ldHdvcmsgKi8gZmFsc2UsXG4gICAgICAgICAgICAvKiBnZW5lcmF0ZU9ubHkgKi8gdHJ1ZSk7XG5cbiAgICAgICAgICAvLyBvayBpZiB0ZW1wbGF0ZSBkb2Vzbid0IGhhdmUgYSBjZGsuanNvbiBmaWxlIChlLmcuIHRoZSBcImxpYlwiIHRlbXBsYXRlKVxuICAgICAgICAgIGlmICghYXdhaXQgZnMucGF0aEV4aXN0cygnY2RrLmpzb24nKSkge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY29uc3QgY29uZmlnID0gYXdhaXQgZnMucmVhZEpzb24oJ2Nkay5qc29uJyk7XG4gICAgICAgICAgY29uc3QgY29udGV4dCA9IGNvbmZpZy5jb250ZXh0IHx8IHt9O1xuICAgICAgICAgIGZvciAoY29uc3QgWyBrZXksIGV4cGVjdGVkIF0gb2YgT2JqZWN0LmVudHJpZXMoY3hhcGkuRlVUVVJFX0ZMQUdTKSkge1xuICAgICAgICAgICAgY29uc3QgYWN0dWFsID0gY29udGV4dFtrZXldO1xuICAgICAgICAgICAgdGVzdC5lcXVhbChhY3R1YWwsIGV4cGVjdGVkLFxuICAgICAgICAgICAgICBgZXhwZWN0ZWQgZnV0dXJlIGZsYWcgXCIke2tleX09JHtleHBlY3RlZH1cIiBpbiBnZW5lcmF0ZWQgY2RrLmpzb24gZm9yICR7dGVtcGwubmFtZX0vJHtsYW5nfSBidXQgZ290IFwiJHthY3R1YWx9XCJgKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICBwcm9jZXNzLmNoZGlyKHByZXZkaXIpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGVzdC5kb25lKCk7XG4gIH1cbn07XG5cbmFzeW5jIGZ1bmN0aW9uIG5ld1RlbXBXb3JrRGlyKCkge1xuICBjb25zdCBuZXdEaXIgPSBhd2FpdCBmcy5ta2R0ZW1wKHBhdGguam9pbihvcy50bXBkaXIoKSwgJ2F3cy1jZGstdGVzdCcpKTtcbiAgcHJvY2Vzcy5jaGRpcihuZXdEaXIpO1xuICByZXR1cm4gbmV3RGlyO1xufSJdfQ==