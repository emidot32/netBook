"use strict";
const lib_1 = require("../../lib");
const serialize_1 = require("../../lib/serialize");
const mock_sdk_1 = require("../util/mock-sdk");
module.exports = {
    async 'do bootstrap'(test) {
        // GIVEN
        const sdk = new mock_sdk_1.MockSDK();
        let executed = false;
        sdk.stubCloudFormation({
            describeStacks() {
                return {
                    Stacks: []
                };
            },
            createChangeSet(info) {
                const template = serialize_1.fromYAML(info.TemplateBody);
                const bucketProperties = template.Resources.StagingBucket.Properties;
                test.equals(bucketProperties.BucketName, undefined, 'Expected BucketName to be undefined');
                test.equals(bucketProperties.BucketEncryption.ServerSideEncryptionConfiguration[0].ServerSideEncryptionByDefault.KMSMasterKeyID, undefined, 'Expected KMSMasterKeyID to be undefined');
                return {};
            },
            describeChangeSet() {
                return {
                    Status: 'CREATE_COMPLETE',
                    Changes: [],
                };
            },
            executeChangeSet() {
                executed = true;
                return {};
            }
        });
        // WHEN
        const ret = await lib_1.bootstrapEnvironment({
            account: '123456789012',
            region: 'us-east-1',
            name: 'mock',
        }, sdk, 'mockStack', undefined);
        // THEN
        test.equals(ret.noOp, false);
        test.equals(executed, true);
        test.done();
    },
    async 'do bootstrap using custom bucket name'(test) {
        // GIVEN
        const sdk = new mock_sdk_1.MockSDK();
        let executed = false;
        sdk.stubCloudFormation({
            describeStacks() {
                return {
                    Stacks: []
                };
            },
            createChangeSet(info) {
                const template = serialize_1.fromYAML(info.TemplateBody);
                const bucketProperties = template.Resources.StagingBucket.Properties;
                test.equals(bucketProperties.BucketName, 'foobar', 'Expected BucketName to be foobar');
                test.equals(bucketProperties.BucketEncryption.ServerSideEncryptionConfiguration[0].ServerSideEncryptionByDefault.KMSMasterKeyID, undefined, 'Expected KMSMasterKeyID to be undefined');
                return {};
            },
            describeChangeSet() {
                return {
                    Status: 'CREATE_COMPLETE',
                    Changes: [],
                };
            },
            executeChangeSet() {
                executed = true;
                return {};
            }
        });
        // WHEN
        const ret = await lib_1.bootstrapEnvironment({
            account: '123456789012',
            region: 'us-east-1',
            name: 'mock',
        }, sdk, 'mockStack', undefined, {
            bucketName: 'foobar',
        });
        // THEN
        test.equals(ret.noOp, false);
        test.equals(executed, true);
        test.done();
    },
    async 'do bootstrap using KMS CMK'(test) {
        // GIVEN
        const sdk = new mock_sdk_1.MockSDK();
        let executed = false;
        sdk.stubCloudFormation({
            describeStacks() {
                return {
                    Stacks: []
                };
            },
            createChangeSet(info) {
                const template = serialize_1.fromYAML(info.TemplateBody);
                const bucketProperties = template.Resources.StagingBucket.Properties;
                test.equals(bucketProperties.BucketName, undefined, 'Expected BucketName to be undefined');
                test.equals(bucketProperties.BucketEncryption.ServerSideEncryptionConfiguration[0].ServerSideEncryptionByDefault.KMSMasterKeyID, 'myKmsKey', 'Expected KMSMasterKeyID to be myKmsKey');
                return {};
            },
            describeChangeSet() {
                return {
                    Status: 'CREATE_COMPLETE',
                    Changes: [],
                };
            },
            executeChangeSet() {
                executed = true;
                return {};
            }
        });
        // WHEN
        const ret = await lib_1.bootstrapEnvironment({
            account: '123456789012',
            region: 'us-east-1',
            name: 'mock',
        }, sdk, 'mockStack', undefined, {
            kmsKeyId: 'myKmsKey',
        });
        // THEN
        test.equals(ret.noOp, false);
        test.equals(executed, true);
        test.done();
    },
    async 'do bootstrap with custom tags for toolkit stack'(test) {
        // GIVEN
        const sdk = new mock_sdk_1.MockSDK();
        let executed = false;
        sdk.stubCloudFormation({
            describeStacks() {
                return {
                    Stacks: []
                };
            },
            createChangeSet(info) {
                const template = serialize_1.fromYAML(info.TemplateBody);
                const bucketProperties = template.Resources.StagingBucket.Properties;
                test.equals(bucketProperties.BucketName, undefined, 'Expected BucketName to be undefined');
                test.equals(bucketProperties.BucketEncryption.ServerSideEncryptionConfiguration[0].ServerSideEncryptionByDefault.KMSMasterKeyID, undefined, 'Expected KMSMasterKeyID to be undefined');
                return {};
            },
            describeChangeSet() {
                return {
                    Status: 'CREATE_COMPLETE',
                    Changes: [],
                };
            },
            executeChangeSet() {
                executed = true;
                return {};
            }
        });
        // WHEN
        const ret = await lib_1.bootstrapEnvironment({
            account: '123456789012',
            region: 'us-east-1',
            name: 'mock',
        }, sdk, 'mockStack', undefined, {
            tags: [{ Key: 'Foo', Value: 'Bar' }]
        });
        // THEN
        test.equals(ret.noOp, false);
        test.equals(executed, true);
        test.done();
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5ib290c3RyYXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0ZXN0LmJvb3RzdHJhcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBRUEsbUNBQWlEO0FBQ2pELG1EQUErQztBQUMvQywrQ0FBMkM7QUFFM0MsaUJBQVM7SUFDUCxLQUFLLENBQUMsY0FBYyxDQUFDLElBQVU7UUFDN0IsUUFBUTtRQUNSLE1BQU0sR0FBRyxHQUFHLElBQUksa0JBQU8sRUFBRSxDQUFDO1FBRTFCLElBQUksUUFBUSxHQUFHLEtBQUssQ0FBQztRQUVyQixHQUFHLENBQUMsa0JBQWtCLENBQUM7WUFDckIsY0FBYztnQkFDWixPQUFPO29CQUNMLE1BQU0sRUFBRSxFQUFFO2lCQUNYLENBQUM7WUFDSixDQUFDO1lBRUQsZUFBZSxDQUFDLElBQTBCO2dCQUN4QyxNQUFNLFFBQVEsR0FBRyxvQkFBUSxDQUFDLElBQUksQ0FBQyxZQUFzQixDQUFDLENBQUM7Z0JBQ3ZELE1BQU0sZ0JBQWdCLEdBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDO2dCQUNyRSxJQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsRUFBRSxTQUFTLEVBQUUscUNBQXFDLENBQUMsQ0FBQztnQkFDM0YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxnQkFBZ0IsQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyw2QkFBNkIsQ0FBQyxjQUFjLEVBQzdILFNBQVMsRUFBRSx5Q0FBeUMsQ0FBQyxDQUFDO2dCQUN4RCxPQUFPLEVBQUUsQ0FBQztZQUNaLENBQUM7WUFFRCxpQkFBaUI7Z0JBQ2YsT0FBTztvQkFDTCxNQUFNLEVBQUUsaUJBQWlCO29CQUN6QixPQUFPLEVBQUUsRUFBRTtpQkFDWixDQUFDO1lBQ0osQ0FBQztZQUVELGdCQUFnQjtnQkFDZCxRQUFRLEdBQUcsSUFBSSxDQUFDO2dCQUNoQixPQUFPLEVBQUUsQ0FBQztZQUNa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QyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDN0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFNUIsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2QsQ0FBQztDQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDcmVhdGVDaGFuZ2VTZXRJbnB1dCB9IGZyb20gJ2F3cy1zZGsvY2xpZW50cy9jbG91ZGZvcm1hdGlvbic7XG5pbXBvcnQgeyBUZXN0IH0gZnJvbSAnbm9kZXVuaXQnO1xuaW1wb3J0IHsgYm9vdHN0cmFwRW52aXJvbm1lbnQgfSBmcm9tICcuLi8uLi9saWInO1xuaW1wb3J0IHsgZnJvbVlBTUwgfSBmcm9tICcuLi8uLi9saWIvc2VyaWFsaXplJztcbmltcG9ydCB7IE1vY2tTREsgfSBmcm9tICcuLi91dGlsL21vY2stc2RrJztcblxuZXhwb3J0ID0ge1xuICBhc3luYyAnZG8gYm9vdHN0cmFwJyh0ZXN0OiBUZXN0KSB7XG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBzZGsgPSBuZXcgTW9ja1NESygpO1xuXG4gICAgbGV0IGV4ZWN1dGVkID0gZmFsc2U7XG5cbiAgICBzZGsuc3R1YkNsb3VkRm9ybWF0aW9uKHtcbiAgICAgIGRlc2NyaWJlU3RhY2tzKCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIFN0YWNrczogW11cbiAgICAgICAgfTtcbiAgICAgIH0sXG5cbiAgICAgIGNyZWF0ZUNoYW5nZVNldChpbmZvOiBDcmVhdGVDaGFuZ2VTZXRJbnB1dCkge1xuICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IGZyb21ZQU1MKGluZm8uVGVtcGxhdGVCb2R5IGFzIHN0cmluZyk7XG4gICAgICAgIGNvbnN0IGJ1Y2tldFByb3BlcnRpZXMgPSB0ZW1wbGF0ZS5SZXNvdXJjZXMuU3RhZ2luZ0J1Y2tldC5Qcm9wZXJ0aWVzO1xuICAgICAgICB0ZXN0LmVxdWFscyhidWNrZXRQcm9wZXJ0aWVzLkJ1Y2tldE5hbWUsIHVuZGVmaW5lZCwgJ0V4cGVjdGVkIEJ1Y2tldE5hbWUgdG8gYmUgdW5kZWZpbmVkJyk7XG4gICAgICAgIHRlc3QuZXF1YWxzKGJ1Y2tldFByb3BlcnRpZXMuQnVja2V0RW5jcnlwdGlvbi5TZXJ2ZXJTaWRlRW5jcnlwdGlvbkNvbmZpZ3VyYXRpb25bMF0uU2VydmVyU2lkZUVuY3J5cHRpb25CeURlZmF1bHQuS01TTWFzdGVyS2V5SUQsXG4gICAgICAgICAgdW5kZWZpbmVkLCAnRXhwZWN0ZWQgS01TTWFzdGVyS2V5SUQgdG8gYmUgdW5kZWZpbmVkJyk7XG4gICAgICAgIHJldHVybiB7fTtcbiAgICAgIH0sXG5cbiAgICAgIGRlc2NyaWJlQ2hhbmdlU2V0KCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIFN0YXR1czogJ0NSRUFURV9DT01QTEVURScsXG4gICAgICAgICAgQ2hhbmdlczogW10sXG4gICAgICAgIH07XG4gICAgICB9LFxuXG4gICAgICBleGVjdXRlQ2hhbmdlU2V0KCkge1xuICAgICAgICBleGVjdXRlZCA9IHRydWU7XG4gICAgICAgIHJldHVybiB7fTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCByZXQgPSBhd2FpdCBib290c3RyYXBFbnZpcm9ubWVudCh7XG4gICAgICBhY2NvdW50OiAnMTIzNDU2Nzg5MDEyJyxcbiAgICAgIHJlZ2lvbjogJ3VzLWVhc3QtMScsXG4gICAgICBuYW1lOiAnbW9jaycsXG4gICAgfSwgc2RrLCAnbW9ja1N0YWNrJywgdW5kZWZpbmVkKTtcblxuICAgIC8vIFRIRU5cbiAgICB0ZXN0LmVxdWFscyhyZXQubm9PcCwgZmFsc2UpO1xuICAgIHRlc3QuZXF1YWxzKGV4ZWN1dGVkLCB0cnVlKTtcblxuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuICBhc3luYyAnZG8gYm9vdHN0cmFwIHVzaW5nIGN1c3RvbSBidWNrZXQgbmFtZScodGVzdDogVGVzdCkge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc2RrID0gbmV3IE1vY2tTREsoKTtcblxuICAgIGxldCBleGVjdXRlZCA9IGZhbHNlO1xuXG4gICAgc2RrLnN0dWJDbG91ZEZvcm1hdGlvbih7XG4gICAgICBkZXNjcmliZVN0YWNrcygpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBTdGFja3M6IFtdXG4gICAgICAgIH07XG4gICAgICB9LFxuXG4gICAgICBjcmVhdGVDaGFuZ2VTZXQoaW5mbzogQ3JlYXRlQ2hhbmdlU2V0SW5wdXQpIHtcbiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBmcm9tWUFNTChpbmZvLlRlbXBsYXRlQm9keSBhcyBzdHJpbmcpO1xuICAgICAgICBjb25zdCBidWNrZXRQcm9wZXJ0aWVzID0gdGVtcGxhdGUuUmVzb3VyY2VzLlN0YWdpbmdCdWNrZXQuUHJvcGVydGllcztcbiAgICAgICAgdGVzdC5lcXVhbHMoYnVja2V0UHJvcGVydGllcy5CdWNrZXROYW1lLCAnZm9vYmFyJywgJ0V4cGVjdGVkIEJ1Y2tldE5hbWUgdG8gYmUgZm9vYmFyJyk7XG4gICAgICAgIHRlc3QuZXF1YWxzKGJ1Y2tldFByb3BlcnRpZXMuQnVja2V0RW5jcnlwdGlvbi5TZXJ2ZXJTaWRlRW5jcnlwdGlvbkNvbmZpZ3VyYXRpb25bMF0uU2VydmVyU2lkZUVuY3J5cHRpb25CeURlZmF1bHQuS01TTWFzdGVyS2V5SUQsXG4gICAgICAgICAgdW5kZWZpbmVkLCAnRXhwZWN0ZWQgS01TTWFzdGVyS2V5SUQgdG8gYmUgdW5kZWZpbmVkJyk7XG4gICAgICAgIHJldHVybiB7fTtcbiAgICAgIH0sXG5cbiAgICAgIGRlc2NyaWJlQ2hhbmdlU2V0KCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIFN0YXR1czogJ0NSRUFURV9DT01QTEVURScsXG4gICAgICAgICAgQ2hhbmdlczogW10sXG4gICAgICAgIH07XG4gICAgICB9LFxuXG4gICAgICBleGVjdXRlQ2hhbmdlU2V0KCkge1xuICAgICAgICBleGVjdXRlZCA9IHRydWU7XG4gICAgICAgIHJldHVybiB7fTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCByZXQgPSBhd2FpdCBib290c3RyYXBFbnZpcm9ubWVudCh7XG4gICAgICBhY2NvdW50OiAnMTIzNDU2Nzg5MDEyJyxcbiAgICAgIHJlZ2lvbjogJ3VzLWVhc3QtMScsXG4gICAgICBuYW1lOiAnbW9jaycsXG4gICAgfSwgc2RrLCAnbW9ja1N0YWNrJywgdW5kZWZpbmVkLCB7XG4gICAgICBidWNrZXROYW1lOiAnZm9vYmFyJyxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICB0ZXN0LmVxdWFscyhyZXQubm9PcCwgZmFsc2UpO1xuICAgIHRlc3QuZXF1YWxzKGV4ZWN1dGVkLCB0cnVlKTtcblxuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuICBhc3luYyAnZG8gYm9vdHN0cmFwIHVzaW5nIEtNUyBDTUsnKHRlc3Q6IFRlc3QpIHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHNkayA9IG5ldyBNb2NrU0RLKCk7XG5cbiAgICBsZXQgZXhlY3V0ZWQgPSBmYWxzZTtcblxuICAgIHNkay5zdHViQ2xvdWRGb3JtYXRpb24oe1xuICAgICAgZGVzY3JpYmVTdGFja3MoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgU3RhY2tzOiBbXVxuICAgICAgICB9O1xuICAgICAgfSxcblxuICAgICAgY3JlYXRlQ2hhbmdlU2V0KGluZm86IENyZWF0ZUNoYW5nZVNldElucHV0KSB7XG4gICAgICAgIGNvbnN0IHRlbXBsYXRlID0gZnJvbVlBTUwoaW5mby5UZW1wbGF0ZUJvZHkgYXMgc3RyaW5nKTtcbiAgICAgICAgY29uc3QgYnVja2V0UHJvcGVydGllcyA9IHRlbXBsYXRlLlJlc291cmNlcy5TdGFnaW5nQnVja2V0LlByb3BlcnRpZXM7XG4gICAgICAgIHRlc3QuZXF1YWxzKGJ1Y2tldFByb3BlcnRpZXMuQnVja2V0TmFtZSwgdW5kZWZpbmVkLCAnRXhwZWN0ZWQgQnVja2V0TmFtZSB0byBiZSB1bmRlZmluZWQnKTtcbiAgICAgICAgdGVzdC5lcXVhbHMoYnVja2V0UHJvcGVydGllcy5CdWNrZXRFbmNyeXB0aW9uLlNlcnZlclNpZGVFbmNyeXB0aW9uQ29uZmlndXJhdGlvblswXS5TZXJ2ZXJTaWRlRW5jcnlwdGlvbkJ5RGVmYXVsdC5LTVNNYXN0ZXJLZXlJRCxcbiAgICAgICAgICAnbXlLbXNLZXknLCAnRXhwZWN0ZWQgS01TTWFzdGVyS2V5SUQgdG8gYmUgbXlLbXNLZXknKTtcbiAgICAgICAgcmV0dXJuIHt9O1xuICAgICAgfSxcblxuICAgICAgZGVzY3JpYmVDaGFuZ2VTZXQoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgU3RhdHVzOiAnQ1JFQVRFX0NPTVBMRVRFJyxcbiAgICAgICAgICBDaGFuZ2VzOiBbXSxcbiAgICAgICAgfTtcbiAgICAgIH0sXG5cbiAgICAgIGV4ZWN1dGVDaGFuZ2VTZXQoKSB7XG4gICAgICAgIGV4ZWN1dGVkID0gdHJ1ZTtcbiAgICAgICAgcmV0dXJuIHt9O1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHJldCA9IGF3YWl0IGJvb3RzdHJhcEVudmlyb25tZW50KHtcbiAgICAgIGFjY291bnQ6ICcxMjM0NTY3ODkwMTInLFxuICAgICAgcmVnaW9uOiAndXMtZWFzdC0xJyxcbiAgICAgIG5hbWU6ICdtb2NrJyxcbiAgICB9LCBzZGssICdtb2NrU3RhY2snLCB1bmRlZmluZWQsIHtcbiAgICAgIGttc0tleUlkOiAnbXlLbXNLZXknLFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIHRlc3QuZXF1YWxzKHJldC5ub09wLCBmYWxzZSk7XG4gICAgdGVzdC5lcXVhbHMoZXhlY3V0ZWQsIHRydWUpO1xuXG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG4gIGFzeW5jICdkbyBib290c3RyYXAgd2l0aCBjdXN0b20gdGFncyBmb3IgdG9vbGtpdCBzdGFjaycodGVzdDogVGVzdCkge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc2RrID0gbmV3IE1vY2tTREsoKTtcblxuICAgIGxldCBleGVjdXRlZCA9IGZhbHNlO1xuXG4gICAgc2RrLnN0dWJDbG91ZEZvcm1hdGlvbih7XG4gICAgICBkZXNjcmliZVN0YWNrcygpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBTdGFja3M6IFtdXG4gICAgICAgIH07XG4gICAgICB9LFxuXG4gICAgICBjcmVhdGVDaGFuZ2VTZXQoaW5mbzogQ3JlYXRlQ2hhbmdlU2V0SW5wdXQpIHtcbiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBmcm9tWUFNTChpbmZvLlRlbXBsYXRlQm9keSBhcyBzdHJpbmcpO1xuICAgICAgICBjb25zdCBidWNrZXRQcm9wZXJ0aWVzID0gdGVtcGxhdGUuUmVzb3VyY2VzLlN0YWdpbmdCdWNrZXQuUHJvcGVydGllcztcbiAgICAgICAgdGVzdC5lcXVhbHMoYnVja2V0UHJvcGVydGllcy5CdWNrZXROYW1lLCB1bmRlZmluZWQsICdFeHBlY3RlZCBCdWNrZXROYW1lIHRvIGJlIHVuZGVmaW5lZCcpO1xuICAgICAgICB0ZXN0LmVxdWFscyhidWNrZXRQcm9wZXJ0aWVzLkJ1Y2tldEVuY3J5cHRpb24uU2VydmVyU2lkZUVuY3J5cHRpb25Db25maWd1cmF0aW9uWzBdLlNlcnZlclNpZGVFbmNyeXB0aW9uQnlEZWZhdWx0LktNU01hc3RlcktleUlELFxuICAgICAgICAgICAgdW5kZWZpbmVkLCAnRXhwZWN0ZWQgS01TTWFzdGVyS2V5SUQgdG8gYmUgdW5kZWZpbmVkJyk7XG4gICAgICAgIHJldHVybiB7fTtcbiAgICAgIH0sXG5cbiAgICAgIGRlc2NyaWJlQ2hhbmdlU2V0KCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIFN0YXR1czogJ0NSRUFURV9DT01QTEVURScsXG4gICAgICAgICAgQ2hhbmdlczogW10sXG4gICAgICAgIH07XG4gICAgICB9LFxuXG4gICAgICBleGVjdXRlQ2hhbmdlU2V0KCkge1xuICAgICAgICBleGVjdXRlZCA9IHRydWU7XG4gICAgICAgIHJldHVybiB7fTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCByZXQgPSBhd2FpdCBib290c3RyYXBFbnZpcm9ubWVudCh7XG4gICAgICBhY2NvdW50OiAnMTIzNDU2Nzg5MDEyJyxcbiAgICAgIHJlZ2lvbjogJ3VzLWVhc3QtMScsXG4gICAgICBuYW1lOiAnbW9jaycsXG4gICAgfSwgc2RrLCAnbW9ja1N0YWNrJywgdW5kZWZpbmVkLCB7XG4gICAgICB0YWdzOiBbeyBLZXk6ICdGb28nLCBWYWx1ZTogJ0JhcicgfV1cbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICB0ZXN0LmVxdWFscyhyZXQubm9PcCwgZmFsc2UpO1xuICAgIHRlc3QuZXF1YWxzKGV4ZWN1dGVkLCB0cnVlKTtcblxuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxufTtcbiJdfQ==