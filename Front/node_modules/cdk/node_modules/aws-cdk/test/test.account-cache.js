"use strict";
const fs = require("fs-extra");
const path = require("path");
const account_cache_1 = require("../lib/api/util/account-cache");
module.exports = {
    async 'setUp'(cb) {
        const self = this;
        const dir = await fs.mkdtemp('/tmp/account-cache-test');
        self.file = path.join(dir, 'cache.json');
        self.cache = new account_cache_1.AccountAccessKeyCache(self.file);
        return cb();
    },
    async 'tearDown'(cb) {
        const self = this;
        await fs.remove(path.dirname(self.file));
        cb();
    },
    async 'get(k) when cache is empty'(test) {
        const self = this;
        const cache = self.cache;
        test.equal(await cache.get('foo'), undefined, 'get returns undefined');
        test.equal(await fs.pathExists(self.file), false, 'cache file is not created');
        test.done();
    },
    async 'put(k,v) and then get(k)'(test) {
        const self = this;
        const cache = self.cache;
        await cache.put('key', 'value');
        await cache.put('boo', 'bar');
        test.deepEqual(await cache.get('key'), 'value', '"key" is mapped to "value"');
        // create another cache instance on the same file, should still work
        const cache2 = new account_cache_1.AccountAccessKeyCache(self.file);
        test.deepEqual(await cache2.get('boo'), 'bar', '"boo" is mapped to "bar"');
        // whitebox: read the file
        test.deepEqual(await fs.readJson(self.file), {
            key: 'value',
            boo: 'bar'
        });
        test.done();
    },
    async 'fetch(k, resolver) can be used to "atomically" get + resolve + put'(test) {
        const self = this;
        const cache = self.cache;
        test.deepEqual(await cache.get('foo'), undefined, 'no value for "foo" yet');
        test.deepEqual(await cache.fetch('foo', async () => 'bar'), 'bar', 'resolved by fetch and returned');
        test.deepEqual(await cache.get('foo'), 'bar', 'stored in cache by fetch()');
        test.done();
    },
    async 'cache is nuked if it exceeds 1000 entries'(test) {
        const self = this;
        const cache = self.cache;
        for (let i = 0; i < account_cache_1.AccountAccessKeyCache.MAX_ENTRIES; ++i) {
            await cache.put(`key${i}`, `value${i}`);
        }
        // verify all 1000 values are on disk
        const otherCache = new account_cache_1.AccountAccessKeyCache(self.file);
        for (let i = 0; i < account_cache_1.AccountAccessKeyCache.MAX_ENTRIES; ++i) {
            test.equal(await otherCache.get(`key${i}`), `value${i}`);
        }
        // add another value
        await cache.put('nuke-me', 'genesis');
        // now, we expect only `nuke-me` to exist on disk
        test.equal(await otherCache.get('nuke-me'), 'genesis');
        for (let i = 0; i < account_cache_1.AccountAccessKeyCache.MAX_ENTRIES; ++i) {
            test.equal(await otherCache.get(`key${i}`), undefined);
        }
        test.done();
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5hY2NvdW50LWNhY2hlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGVzdC5hY2NvdW50LWNhY2hlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSwrQkFBZ0M7QUFFaEMsNkJBQThCO0FBQzlCLGlFQUFzRTtBQUV0RSxpQkFBUztJQUNQLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBcUI7UUFDakMsTUFBTSxJQUFJLEdBQUcsSUFBVyxDQUFDO1FBQ3pCLE1BQU0sR0FBRyxHQUFHLE1BQU0sRUFBRSxDQUFDLE9BQU8sQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1FBQ3hELElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFDekMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLHFDQUFxQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNsRCxPQUFPLEVBQUUsRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUVELEtBQUssQ0FBQyxVQUFVLENBQUMsRUFBcUI7UUFDcEMsTUFBTSxJQUFJLEdBQUcsSUFBVyxDQUFDO1FBQ3pCLE1BQU0sRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3pDLEVBQUUsRUFBRSxDQUFDO0lBQ1AsQ0FBQztJQUVELEtBQUssQ0FBQyw0QkFBNEIsQ0FBQyxJQUFVO1FBQzNDLE1BQU0sSUFBSSxHQUFHLElBQVcsQ0FBQztRQUN6QixNQUFNLEtBQUssR0FBMEIsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUNoRCxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxTQUFTLEVBQUUsdUJBQXVCLENBQUMsQ0FBQztRQUN2RSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENB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QUMsQ0FBQztRQUV0QyxpREFBaUQ7UUFDakQsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLFVBQVUsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDdkQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLHFDQUFxQixDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUMsRUFBRTtZQUMxRCxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sVUFBVSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUM7U0FDeEQ7UUFFRCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDZCxDQUFDO0NBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyA9IHJlcXVpcmUoJ2ZzLWV4dHJhJyk7XG5pbXBvcnQgeyBJQ2FsbGJhY2tGdW5jdGlvbiwgVGVzdCB9IGZyb20gJ25vZGV1bml0JztcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuaW1wb3J0IHsgQWNjb3VudEFjY2Vzc0tleUNhY2hlIH0gZnJvbSAnLi4vbGliL2FwaS91dGlsL2FjY291bnQtY2FjaGUnO1xuXG5leHBvcnQgPSB7XG4gIGFzeW5jICdzZXRVcCcoY2I6IElDYWxsYmFja0Z1bmN0aW9uKSB7XG4gICAgY29uc3Qgc2VsZiA9IHRoaXMgYXMgYW55O1xuICAgIGNvbnN0IGRpciA9IGF3YWl0IGZzLm1rZHRlbXAoJy90bXAvYWNjb3VudC1jYWNoZS10ZXN0Jyk7XG4gICAgc2VsZi5maWxlID0gcGF0aC5qb2luKGRpciwgJ2NhY2hlLmpzb24nKTtcbiAgICBzZWxmLmNhY2hlID0gbmV3IEFjY291bnRBY2Nlc3NLZXlDYWNoZShzZWxmLmZpbGUpO1xuICAgIHJldHVybiBjYigpO1xuICB9LFxuXG4gIGFzeW5jICd0ZWFyRG93bicoY2I6IElDYWxsYmFja0Z1bmN0aW9uKSB7XG4gICAgY29uc3Qgc2VsZiA9IHRoaXMgYXMgYW55O1xuICAgIGF3YWl0IGZzLnJlbW92ZShwYXRoLmRpcm5hbWUoc2VsZi5maWxlKSk7XG4gICAgY2IoKTtcbiAgfSxcblxuICBhc3luYyAnZ2V0KGspIHdoZW4gY2FjaGUgaXMgZW1wdHknKHRlc3Q6IFRlc3QpIHtcbiAgICBjb25zdCBzZWxmID0gdGhpcyBhcyBhbnk7XG4gICAgY29uc3QgY2FjaGU6IEFjY291bnRBY2Nlc3NLZXlDYWNoZSA9IHNlbGYuY2FjaGU7XG4gICAgdGVzdC5lcXVhbChhd2FpdCBjYWNoZS5nZXQoJ2ZvbycpLCB1bmRlZmluZWQsICdnZXQgcmV0dXJucyB1bmRlZmluZWQnKTtcbiAgICB0ZXN0LmVxdWFsKGF3YWl0IGZzLnBhdGhFeGlzdHMoc2VsZi5maWxlKSwgZmFsc2UsICdjYWNoZSBmaWxlIGlzIG5vdCBjcmVhdGVkJyk7XG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgYXN5bmMgJ3B1dChrLHYpIGFuZCB0aGVuIGdldChrKScodGVzdDogVGVzdCkge1xuICAgIGNvbnN0IHNlbGYgPSB0aGlzIGFzIGFueTtcbiAgICBjb25zdCBjYWNoZTogQWNjb3VudEFjY2Vzc0tleUNhY2hlID0gc2VsZi5jYWNoZTtcblxuICAgIGF3YWl0IGNhY2hlLnB1dCgna2V5JywgJ3ZhbHVlJyk7XG4gICAgYXdhaXQgY2FjaGUucHV0KCdib28nLCAnYmFyJyk7XG4gICAgdGVzdC5kZWVwRXF1YWwoYXdhaXQgY2FjaGUuZ2V0KCdrZXknKSwgJ3ZhbHVlJywgJ1wia2V5XCIgaXMgbWFwcGVkIHRvIFwidmFsdWVcIicpO1xuXG4gICAgLy8gY3JlYXRlIGFub3RoZXIgY2FjaGUgaW5zdGFuY2Ugb24gdGhlIHNhbWUgZmlsZSwgc2hvdWxkIHN0aWxsIHdvcmtcbiAgICBjb25zdCBjYWNoZTIgPSBuZXcgQWNjb3VudEFjY2Vzc0tleUNhY2hlKHNlbGYuZmlsZSk7XG4gICAgdGVzdC5kZWVwRXF1YWwoYXdhaXQgY2FjaGUyLmdldCgnYm9vJyksICdiYXInLCAnXCJib29cIiBpcyBtYXBwZWQgdG8gXCJiYXJcIicpO1xuXG4gICAgLy8gd2hpdGVib3g6IHJlYWQgdGhlIGZpbGVcbiAgICB0ZXN0LmRlZXBFcXVhbChhd2FpdCBmcy5yZWFkSnNvbihzZWxmLmZpbGUpLCB7XG4gICAgICBrZXk6ICd2YWx1ZScsXG4gICAgICBib286ICdiYXInXG4gICAgfSk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICBhc3luYyAnZmV0Y2goaywgcmVzb2x2ZXIpIGNhbiBiZSB1c2VkIHRvIFwiYXRvbWljYWxseVwiIGdldCArIHJlc29sdmUgKyBwdXQnKHRlc3Q6IFRlc3QpIHtcbiAgICBjb25zdCBzZWxmID0gdGhpcyBhcyBhbnk7XG4gICAgY29uc3QgY2FjaGU6IEFjY291bnRBY2Nlc3NLZXlDYWNoZSA9IHNlbGYuY2FjaGU7XG5cbiAgICB0ZXN0LmRlZXBFcXVhbChhd2FpdCBjYWNoZS5nZXQoJ2ZvbycpLCB1bmRlZmluZWQsICdubyB2YWx1ZSBmb3IgXCJmb29cIiB5ZXQnKTtcbiAgICB0ZXN0LmRlZXBFcXVhbChhd2FpdCBjYWNoZS5mZXRjaCgnZm9vJywgYXN5bmMgKCkgPT4gJ2JhcicpLCAnYmFyJywgJ3Jlc29sdmVkIGJ5IGZldGNoIGFuZCByZXR1cm5lZCcpO1xuICAgIHRlc3QuZGVlcEVxdWFsKGF3YWl0IGNhY2hlLmdldCgnZm9vJyksICdiYXInLCAnc3RvcmVkIGluIGNhY2hlIGJ5IGZldGNoKCknKTtcbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICBhc3luYyAnY2FjaGUgaXMgbnVrZWQgaWYgaXQgZXhjZWVkcyAxMDAwIGVudHJpZXMnKHRlc3Q6IFRlc3QpIHtcbiAgICBjb25zdCBzZWxmID0gdGhpcyBhcyBhbnk7XG4gICAgY29uc3QgY2FjaGU6IEFjY291bnRBY2Nlc3NLZXlDYWNoZSA9IHNlbGYuY2FjaGU7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IEFjY291bnRBY2Nlc3NLZXlDYWNoZS5NQVhfRU5UUklFUzsgKytpKSB7XG4gICAgICBhd2FpdCBjYWNoZS5wdXQoYGtleSR7aX1gLCBgdmFsdWUke2l9YCk7XG4gICAgfVxuXG4gICAgLy8gdmVyaWZ5IGFsbCAxMDAwIHZhbHVlcyBhcmUgb24gZGlza1xuICAgIGNvbnN0IG90aGVyQ2FjaGUgPSBuZXcgQWNjb3VudEFjY2Vzc0tleUNhY2hlKHNlbGYuZmlsZSk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBBY2NvdW50QWNjZXNzS2V5Q2FjaGUuTUFYX0VOVFJJRVM7ICsraSkge1xuICAgICAgdGVzdC5lcXVhbChhd2FpdCBvdGhlckNhY2hlLmdldChga2V5JHtpfWApLCBgdmFsdWUke2l9YCk7XG4gICAgfVxuXG4gICAgLy8gYWRkIGFub3RoZXIgdmFsdWVcbiAgICBhd2FpdCBjYWNoZS5wdXQoJ251a2UtbWUnLCAnZ2VuZXNpcycpO1xuXG4gICAgLy8gbm93LCB3ZSBleHBlY3Qgb25seSBgbnVrZS1tZWAgdG8gZXhpc3Qgb24gZGlza1xuICAgIHRlc3QuZXF1YWwoYXdhaXQgb3RoZXJDYWNoZS5nZXQoJ251a2UtbWUnKSwgJ2dlbmVzaXMnKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IEFjY291bnRBY2Nlc3NLZXlDYWNoZS5NQVhfRU5UUklFUzsgKytpKSB7XG4gICAgICB0ZXN0LmVxdWFsKGF3YWl0IG90aGVyQ2FjaGUuZ2V0KGBrZXkke2l9YCksIHVuZGVmaW5lZCk7XG4gICAgfVxuXG4gICAgdGVzdC5kb25lKCk7XG4gIH1cbn07XG4iXX0=