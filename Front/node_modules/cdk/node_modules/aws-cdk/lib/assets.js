"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// tslint:disable-next-line:max-line-length
const cxapi = require("@aws-cdk/cx-api");
const colors = require("colors");
const fs = require("fs-extra");
const os = require("os");
const path = require("path");
const archive_1 = require("./archive");
const docker_1 = require("./docker");
const logging_1 = require("./logging");
// tslint:disable-next-line:max-line-length
async function prepareAssets(stack, toolkitInfo, ci, reuse) {
    reuse = reuse || [];
    const assets = stack.assets;
    if (assets.length === 0) {
        return [];
    }
    if (!toolkitInfo) {
        // tslint:disable-next-line:max-line-length
        throw new Error(`This stack uses assets, so the toolkit stack must be deployed to the environment (Run "${colors.blue("cdk bootstrap " + stack.environment.name)}")`);
    }
    let params = new Array();
    for (const asset of assets) {
        // FIXME: Should have excluded by construct path here instead of by unique ID, preferably using
        // minimatch so we can support globs. Maybe take up during artifact refactoring.
        const reuseAsset = reuse.indexOf(asset.id) > -1;
        if (reuseAsset) {
            logging_1.debug(`Preparing asset ${asset.id}: ${JSON.stringify(asset)} (reusing)`);
        }
        else {
            logging_1.debug(`Preparing asset ${asset.id}: ${JSON.stringify(asset)}`);
        }
        if (!stack.assembly) {
            throw new Error(`Unexpected: stack assembly is required in order to find assets in assemly directory`);
        }
        const assemblyDir = stack.assembly.directory;
        params = params.concat(await prepareAsset(assemblyDir, asset, toolkitInfo, reuseAsset, ci));
    }
    return params;
}
exports.prepareAssets = prepareAssets;
// tslint:disable-next-line:max-line-length
async function prepareAsset(assemblyDir, asset, toolkitInfo, reuse, ci) {
    switch (asset.packaging) {
        case 'zip':
            return await prepareZipAsset(assemblyDir, asset, toolkitInfo, reuse);
        case 'file':
            return await prepareFileAsset(assemblyDir, asset, toolkitInfo, reuse);
        case 'container-image':
            return await docker_1.prepareContainerAsset(assemblyDir, asset, toolkitInfo, reuse, ci);
        default:
            // tslint:disable-next-line:max-line-length
            throw new Error(`Unsupported packaging type: ${asset.packaging}. You might need to upgrade your aws-cdk toolkit to support this asset type.`);
    }
}
async function prepareZipAsset(assemblyDir, asset, toolkitInfo, reuse) {
    if (reuse) {
        return await prepareFileAsset(assemblyDir, asset, toolkitInfo, reuse);
    }
    const dirPath = path.isAbsolute(asset.path) ? asset.path : path.join(assemblyDir, asset.path);
    if (!(await fs.pathExists(dirPath)) || !(await fs.stat(dirPath)).isDirectory()) {
        throw new Error(`Unable to find directory: ${dirPath}`);
    }
    logging_1.debug('Preparing zip asset from directory:', dirPath);
    const staging = await fs.mkdtemp(path.join(os.tmpdir(), 'cdk-assets'));
    try {
        const archiveFile = path.join(staging, 'archive.zip');
        await archive_1.zipDirectory(dirPath, archiveFile);
        logging_1.debug('zip archive:', archiveFile);
        return await prepareFileAsset(assemblyDir, asset, toolkitInfo, reuse, archiveFile, 'application/zip');
    }
    finally {
        await fs.remove(staging);
    }
}
/**
 * @param asset The asset descriptor
 * @param toolkitInfo The toolkit stack
 * @param filePath Alternative file path to use (instead of asset.path)
 * @param contentType Content-type to use when uploading to S3 (none will be specified by default)
 */
async function prepareFileAsset(assemblyDir, asset, toolkitInfo, reuse, filePath, contentType) {
    if (reuse) {
        return [
            { ParameterKey: asset.s3BucketParameter, UsePreviousValue: true },
            { ParameterKey: asset.s3KeyParameter, UsePreviousValue: true },
            { ParameterKey: asset.artifactHashParameter, UsePreviousValue: true },
        ];
    }
    filePath = filePath || asset.path;
    if (!path.isAbsolute(filePath)) {
        filePath = path.join(assemblyDir, filePath);
    }
    logging_1.debug('Preparing file asset:', filePath);
    const data = await fs.readFile(filePath);
    const s3KeyPrefix = `assets/${asset.id}/`;
    const { filename, key, changed, hash } = await toolkitInfo.uploadIfChanged(data, {
        s3KeyPrefix,
        s3KeySuffix: path.extname(filePath),
        contentType
    });
    const relativePath = path.relative(process.cwd(), asset.path);
    const s3url = `s3://${toolkitInfo.bucketName}/${key}`;
    logging_1.debug(`S3 url for ${relativePath}: ${s3url}`);
    if (changed) {
        logging_1.success(`Updated: ${colors.bold(relativePath)} (${asset.packaging})`);
    }
    else {
        logging_1.debug(`Up-to-date: ${colors.bold(relativePath)} (${asset.packaging})`);
    }
    return [
        { ParameterKey: asset.s3BucketParameter, ParameterValue: toolkitInfo.bucketName },
        { ParameterKey: asset.s3KeyParameter, ParameterValue: `${s3KeyPrefix}${cxapi.ASSET_PREFIX_SEPARATOR}${filename}` },
        { ParameterKey: asset.artifactHashParameter, ParameterValue: hash },
    ];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXNzZXRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsMkNBQTJDO0FBQzNDLHlDQUEwQztBQUUxQyxpQ0FBa0M7QUFDbEMsK0JBQWdDO0FBQ2hDLHlCQUEwQjtBQUMxQiw2QkFBOEI7QUFFOUIsdUNBQXlDO0FBQ3pDLHFDQUFpRDtBQUNqRCx1Q0FBMkM7QUFFM0MsMkNBQTJDO0FBQ3BDLEtBQUssVUFBVSxhQUFhLENBQUMsS0FBd0MsRUFBRSxXQUF5QixFQUFFLEVBQVksRUFBRSxLQUFnQjtJQUNySSxLQUFLLEdBQUcsS0FBSyxJQUFJLEVBQUUsQ0FBQztJQUNwQixNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO0lBRTVCLElBQUksTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7UUFDdkIsT0FBTyxFQUFFLENBQUM7S0FDWDtJQUVELElBQUksQ0FBQyxXQUFXLEVBQUU7UUFDaEIsMkNBQTJDO1FBQzNDLE1BQU0sSUFBSSxLQUFLLENBQUMsMEZBQTBGLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDLFdBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDeEs7SUFFRCxJQUFJLE1BQU0sR0FBRyxJQUFJLEtBQUssRUFBNEIsQ0FBQztJQUNuRCxLQUFLLE1BQU0sS0FBSyxJQUFJLE1BQU0sRUFBRTtRQUMxQiwrRkFBK0Y7UUFDL0YsZ0ZBQWdGO1FBQ2hGLE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRWhELElBQUksVUFBVSxFQUFFO1lBQ2QsZUFBSyxDQUFDLG1CQUFtQixLQUFLLENBQUMsRUFBRSxLQUFLLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQzFFO2FBQU07WUFDTCxlQUFL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S0FDWixDQUFDLENBQUM7SUFFSCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFOUQsTUFBTSxLQUFLLEdBQUcsUUFBUSxXQUFXLENBQUMsVUFBVSxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ3RELGVBQUssQ0FBQyxjQUFjLFlBQVksS0FBSyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBQzlDLElBQUksT0FBTyxFQUFFO1FBQ1gsaUJBQU8sQ0FBQyxZQUFZLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssS0FBSyxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUM7S0FDdkU7U0FBTTtRQUNMLGVBQUssQ0FBQyxlQUFlLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssS0FBSyxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUM7S0FDeEU7SUFFRCxPQUFPO1FBQ0wsRUFBRSxZQUFZLEVBQUUsS0FBSyxDQUFDLGlCQUFpQixFQUFFLGNBQWMsRUFBRSxXQUFXLENBQUMsVUFBVSxFQUFFO1FBQ2pGLEVBQUUsWUFBWSxFQUFFLEtBQUssQ0FBQyxjQUFjLEVBQUUsY0FBYyxFQUFFLEdBQUcsV0FBVyxHQUFHLEtBQUssQ0FBQyxzQkFBc0IsR0FBRyxRQUFRLEVBQUUsRUFBRTtRQUNsSCxFQUFFLFlBQVksRUFBRSxLQUFLLENBQUMscUJBQXFCLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRTtLQUNwRSxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbmltcG9ydCBjeGFwaSA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2N4LWFwaScpO1xuaW1wb3J0IHsgQ2xvdWRGb3JtYXRpb24gfSBmcm9tICdhd3Mtc2RrJztcbmltcG9ydCBjb2xvcnMgPSByZXF1aXJlKCdjb2xvcnMnKTtcbmltcG9ydCBmcyA9IHJlcXVpcmUoJ2ZzLWV4dHJhJyk7XG5pbXBvcnQgb3MgPSByZXF1aXJlKCdvcycpO1xuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5pbXBvcnQgeyBUb29sa2l0SW5mbyB9IGZyb20gJy4vYXBpL3Rvb2xraXQtaW5mbyc7XG5pbXBvcnQgeyB6aXBEaXJlY3RvcnkgfSBmcm9tICcuL2FyY2hpdmUnO1xuaW1wb3J0IHsgcHJlcGFyZUNvbnRhaW5lckFzc2V0IH0gZnJvbSAnLi9kb2NrZXInO1xuaW1wb3J0IHsgZGVidWcsIHN1Y2Nlc3MgfSBmcm9tICcuL2xvZ2dpbmcnO1xuXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcHJlcGFyZUFzc2V0cyhzdGFjazogY3hhcGkuQ2xvdWRGb3JtYXRpb25TdGFja0FydGlmYWN0LCB0b29sa2l0SW5mbz86IFRvb2xraXRJbmZvLCBjaT86IGJvb2xlYW4sIHJldXNlPzogc3RyaW5nW10pOiBQcm9taXNlPENsb3VkRm9ybWF0aW9uLlBhcmFtZXRlcltdPiB7XG4gIHJldXNlID0gcmV1c2UgfHwgW107XG4gIGNvbnN0IGFzc2V0cyA9IHN0YWNrLmFzc2V0cztcblxuICBpZiAoYXNzZXRzLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIGlmICghdG9vbGtpdEluZm8pIHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGlzIHN0YWNrIHVzZXMgYXNzZXRzLCBzbyB0aGUgdG9vbGtpdCBzdGFjayBtdXN0IGJlIGRlcGxveWVkIHRvIHRoZSBlbnZpcm9ubWVudCAoUnVuIFwiJHtjb2xvcnMuYmx1ZShcImNkayBib290c3RyYXAgXCIgKyBzdGFjay5lbnZpcm9ubWVudCEubmFtZSl9XCIpYCk7XG4gIH1cblxuICBsZXQgcGFyYW1zID0gbmV3IEFycmF5PENsb3VkRm9ybWF0aW9uLlBhcmFtZXRlcj4oKTtcbiAgZm9yIChjb25zdCBhc3NldCBvZiBhc3NldHMpIHtcbiAgICAvLyBGSVhNRTogU2hvdWxkIGhhdmUgZXhjbHVkZWQgYnkgY29uc3RydWN0IHBhdGggaGVyZSBpbnN0ZWFkIG9mIGJ5IHVuaXF1ZSBJRCwgcHJlZmVyYWJseSB1c2luZ1xuICAgIC8vIG1pbmltYXRjaCBzbyB3ZSBjYW4gc3VwcG9ydCBnbG9icy4gTWF5YmUgdGFrZSB1cCBkdXJpbmcgYXJ0aWZhY3QgcmVmYWN0b3JpbmcuXG4gICAgY29uc3QgcmV1c2VBc3NldCA9IHJldXNlLmluZGV4T2YoYXNzZXQuaWQpID4gLTE7XG5cbiAgICBpZiAocmV1c2VBc3NldCkge1xuICAgICAgZGVidWcoYFByZXBhcmluZyBhc3NldCAke2Fzc2V0LmlkfTogJHtKU09OLnN0cmluZ2lmeShhc3NldCl9IChyZXVzaW5nKWApO1xuICAgIH0gZWxzZSB7XG4gICAgICBkZWJ1ZyhgUHJlcGFyaW5nIGFzc2V0ICR7YXNzZXQuaWR9OiAke0pTT04uc3RyaW5naWZ5KGFzc2V0KX1gKTtcbiAgICB9XG5cbiAgICBpZiAoIXN0YWNrLmFzc2VtYmx5KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQ6IHN0YWNrIGFzc2VtYmx5IGlzIHJlcXVpcmVkIGluIG9yZGVyIHRvIGZpbmQgYXNzZXRzIGluIGFzc2VtbHkgZGlyZWN0b3J5YCk7XG4gICAgfVxuXG4gICAgY29uc3QgYXNzZW1ibHlEaXIgPSBzdGFjay5hc3NlbWJseS5kaXJlY3Rvcnk7XG4gICAgcGFyYW1zID0gcGFyYW1zLmNvbmNhdChhd2FpdCBwcmVwYXJlQXNzZXQoYXNzZW1ibHlEaXIsIGFzc2V0LCB0b29sa2l0SW5mbywgcmV1c2VBc3NldCwgY2kpKTtcbiAgfVxuXG4gIHJldHVybiBwYXJhbXM7XG59XG5cbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbmFzeW5jIGZ1bmN0aW9uIHByZXBhcmVBc3NldChhc3NlbWJseURpcjogc3RyaW5nLCBhc3NldDogY3hhcGkuQXNzZXRNZXRhZGF0YUVudHJ5LCB0b29sa2l0SW5mbzogVG9vbGtpdEluZm8sIHJldXNlOiBib29sZWFuLCBjaT86IGJvb2xlYW4pOiBQcm9taXNlPENsb3VkRm9ybWF0aW9uLlBhcmFtZXRlcltdPiB7XG4gIHN3aXRjaCAoYXNzZXQucGFja2FnaW5nKSB7XG4gICAgY2FzZSAnemlwJzpcbiAgICAgIHJldHVybiBhd2FpdCBwcmVwYXJlWmlwQXNzZXQoYXNzZW1ibHlEaXIsIGFzc2V0LCB0b29sa2l0SW5mbywgcmV1c2UpO1xuICAgIGNhc2UgJ2ZpbGUnOlxuICAgICAgcmV0dXJuIGF3YWl0IHByZXBhcmVGaWxlQXNzZXQoYXNzZW1ibHlEaXIsIGFzc2V0LCB0b29sa2l0SW5mbywgcmV1c2UpO1xuICAgIGNhc2UgJ2NvbnRhaW5lci1pbWFnZSc6XG4gICAgICByZXR1cm4gYXdhaXQgcHJlcGFyZUNvbnRhaW5lckFzc2V0KGFzc2VtYmx5RGlyLCBhc3NldCwgdG9vbGtpdEluZm8sIHJldXNlLCBjaSk7XG4gICAgZGVmYXVsdDpcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5zdXBwb3J0ZWQgcGFja2FnaW5nIHR5cGU6ICR7KGFzc2V0IGFzIGFueSkucGFja2FnaW5nfS4gWW91IG1pZ2h0IG5lZWQgdG8gdXBncmFkZSB5b3VyIGF3cy1jZGsgdG9vbGtpdCB0byBzdXBwb3J0IHRoaXMgYXNzZXQgdHlwZS5gKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBwcmVwYXJlWmlwQXNzZXQoXG4gICAgYXNzZW1ibHlEaXI6IHN0cmluZyxcbiAgICBhc3NldDogY3hhcGkuRmlsZUFzc2V0TWV0YWRhdGFFbnRyeSxcbiAgICB0b29sa2l0SW5mbzogVG9vbGtpdEluZm8sXG4gICAgcmV1c2U6IGJvb2xlYW4pOiBQcm9taXNlPENsb3VkRm9ybWF0aW9uLlBhcmFtZXRlcltdPiB7XG5cbiAgaWYgKHJldXNlKSB7XG4gICAgcmV0dXJuIGF3YWl0IHByZXBhcmVGaWxlQXNzZXQoYXNzZW1ibHlEaXIsIGFzc2V0LCB0b29sa2l0SW5mbywgcmV1c2UpO1xuICB9XG5cbiAgY29uc3QgZGlyUGF0aCA9IHBhdGguaXNBYnNvbHV0ZShhc3NldC5wYXRoKSA/IGFzc2V0LnBhdGggOiBwYXRoLmpvaW4oYXNzZW1ibHlEaXIsIGFzc2V0LnBhdGgpO1xuXG4gIGlmICghKGF3YWl0IGZzLnBhdGhFeGlzdHMoZGlyUGF0aCkpIHx8ICEoYXdhaXQgZnMuc3RhdChkaXJQYXRoKSkuaXNEaXJlY3RvcnkoKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIGZpbmQgZGlyZWN0b3J5OiAke2RpclBhdGh9YCk7XG4gIH1cblxuICBkZWJ1ZygnUHJlcGFyaW5nIHppcCBhc3NldCBmcm9tIGRpcmVjdG9yeTonLCBkaXJQYXRoKTtcbiAgY29uc3Qgc3RhZ2luZyA9IGF3YWl0IGZzLm1rZHRlbXAocGF0aC5qb2luKG9zLnRtcGRpcigpLCAnY2RrLWFzc2V0cycpKTtcbiAgdHJ5IHtcbiAgICBjb25zdCBhcmNoaXZlRmlsZSA9IHBhdGguam9pbihzdGFnaW5nLCAnYXJjaGl2ZS56aXAnKTtcbiAgICBhd2FpdCB6aXBEaXJlY3RvcnkoZGlyUGF0aCwgYXJjaGl2ZUZpbGUpO1xuICAgIGRlYnVnKCd6aXAgYXJjaGl2ZTonLCBhcmNoaXZlRmlsZSk7XG4gICAgcmV0dXJuIGF3YWl0IHByZXBhcmVGaWxlQXNzZXQoYXNzZW1ibHlEaXIsIGFzc2V0LCB0b29sa2l0SW5mbywgcmV1c2UsIGFyY2hpdmVGaWxlLCAnYXBwbGljYXRpb24vemlwJyk7XG4gIH0gZmluYWxseSB7XG4gICAgYXdhaXQgZnMucmVtb3ZlKHN0YWdpbmcpO1xuICB9XG59XG5cbi8qKlxuICogQHBhcmFtIGFzc2V0IFRoZSBhc3NldCBkZXNjcmlwdG9yXG4gKiBAcGFyYW0gdG9vbGtpdEluZm8gVGhlIHRvb2xraXQgc3RhY2tcbiAqIEBwYXJhbSBmaWxlUGF0aCBBbHRlcm5hdGl2ZSBmaWxlIHBhdGggdG8gdXNlIChpbnN0ZWFkIG9mIGFzc2V0LnBhdGgpXG4gKiBAcGFyYW0gY29udGVudFR5cGUgQ29udGVudC10eXBlIHRvIHVzZSB3aGVuIHVwbG9hZGluZyB0byBTMyAobm9uZSB3aWxsIGJlIHNwZWNpZmllZCBieSBkZWZhdWx0KVxuICovXG5hc3luYyBmdW5jdGlvbiBwcmVwYXJlRmlsZUFzc2V0KFxuICAgIGFzc2VtYmx5RGlyOiBzdHJpbmcsXG4gICAgYXNzZXQ6IGN4YXBpLkZpbGVBc3NldE1ldGFkYXRhRW50cnksXG4gICAgdG9vbGtpdEluZm86IFRvb2xraXRJbmZvLFxuICAgIHJldXNlOiBib29sZWFuLFxuICAgIGZpbGVQYXRoPzogc3RyaW5nLFxuICAgIGNvbnRlbnRUeXBlPzogc3RyaW5nKTogUHJvbWlzZTxDbG91ZEZvcm1hdGlvbi5QYXJhbWV0ZXJbXT4ge1xuXG4gIGlmIChyZXVzZSkge1xuICAgIHJldHVybiBbXG4gICAgICB7IFBhcmFtZXRlcktleTogYXNzZXQuczNCdWNrZXRQYXJhbWV0ZXIsIFVzZVByZXZpb3VzVmFsdWU6IHRydWUgfSxcbiAgICAgIHsgUGFyYW1ldGVyS2V5OiBhc3NldC5zM0tleVBhcmFtZXRlciwgVXNlUHJldmlvdXNWYWx1ZTogdHJ1ZSB9LFxuICAgICAgeyBQYXJhbWV0ZXJLZXk6IGFzc2V0LmFydGlmYWN0SGFzaFBhcmFtZXRlciwgVXNlUHJldmlvdXNWYWx1ZTogdHJ1ZSB9LFxuICAgIF07XG4gIH1cblxuICBmaWxlUGF0aCA9IGZpbGVQYXRoIHx8IGFzc2V0LnBhdGg7XG5cbiAgaWYgKCFwYXRoLmlzQWJzb2x1dGUoZmlsZVBhdGgpKSB7XG4gICAgZmlsZVBhdGggPSBwYXRoLmpvaW4oYXNzZW1ibHlEaXIsIGZpbGVQYXRoKTtcbiAgfVxuXG4gIGRlYnVnKCdQcmVwYXJpbmcgZmlsZSBhc3NldDonLCBmaWxlUGF0aCk7XG5cbiAgY29uc3QgZGF0YSA9IGF3YWl0IGZzLnJlYWRGaWxlKGZpbGVQYXRoKTtcblxuICBjb25zdCBzM0tleVByZWZpeCA9IGBhc3NldHMvJHthc3NldC5pZH0vYDtcblxuICBjb25zdCB7IGZpbGVuYW1lLCBrZXksIGNoYW5nZWQsIGhhc2ggfSA9IGF3YWl0IHRvb2xraXRJbmZvLnVwbG9hZElmQ2hhbmdlZChkYXRhLCB7XG4gICAgczNLZXlQcmVmaXgsXG4gICAgczNLZXlTdWZmaXg6IHBhdGguZXh0bmFtZShmaWxlUGF0aCksXG4gICAgY29udGVudFR5cGVcbiAgfSk7XG5cbiAgY29uc3QgcmVsYXRpdmVQYXRoID0gcGF0aC5yZWxhdGl2ZShwcm9jZXNzLmN3ZCgpLCBhc3NldC5wYXRoKTtcblxuICBjb25zdCBzM3VybCA9IGBzMzovLyR7dG9vbGtpdEluZm8uYnVja2V0TmFtZX0vJHtrZXl9YDtcbiAgZGVidWcoYFMzIHVybCBmb3IgJHtyZWxhdGl2ZVBhdGh9OiAke3MzdXJsfWApO1xuICBpZiAoY2hhbmdlZCkge1xuICAgIHN1Y2Nlc3MoYFVwZGF0ZWQ6ICR7Y29sb3JzLmJvbGQocmVsYXRpdmVQYXRoKX0gKCR7YXNzZXQucGFja2FnaW5nfSlgKTtcbiAgfSBlbHNlIHtcbiAgICBkZWJ1ZyhgVXAtdG8tZGF0ZTogJHtjb2xvcnMuYm9sZChyZWxhdGl2ZVBhdGgpfSAoJHthc3NldC5wYWNrYWdpbmd9KWApO1xuICB9XG5cbiAgcmV0dXJuIFtcbiAgICB7IFBhcmFtZXRlcktleTogYXNzZXQuczNCdWNrZXRQYXJhbWV0ZXIsIFBhcmFtZXRlclZhbHVlOiB0b29sa2l0SW5mby5idWNrZXROYW1lIH0sXG4gICAgeyBQYXJhbWV0ZXJLZXk6IGFzc2V0LnMzS2V5UGFyYW1ldGVyLCBQYXJhbWV0ZXJWYWx1ZTogYCR7czNLZXlQcmVmaXh9JHtjeGFwaS5BU1NFVF9QUkVGSVhfU0VQQVJBVE9SfSR7ZmlsZW5hbWV9YCB9LFxuICAgIHsgUGFyYW1ldGVyS2V5OiBhc3NldC5hcnRpZmFjdEhhc2hQYXJhbWV0ZXIsIFBhcmFtZXRlclZhbHVlOiBoYXNoIH0sXG4gIF07XG59XG4iXX0=