"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("source-map-support/register");
const diff_template_1 = require("../lib/diff-template");
const POLICY_DOCUMENT = { foo: 'Bar' }; // Obviously a fake one!
const BUCKET_POLICY_RESOURCE = {
    Type: 'AWS::S3::BucketPolicy',
    Properties: {
        PolicyDocument: POLICY_DOCUMENT,
        Bucket: { Ref: 'BucketResource' }
    }
};
exports.diffTemplate = {
    'when there is no difference': (test) => {
        const bucketName = 'ShineyBucketName';
        const currentTemplate = {
            Resources: {
                BucketPolicyResource: BUCKET_POLICY_RESOURCE,
                BucketResource: {
                    Type: 'AWS::S3::Bucket',
                    Properties: {
                        BucketName: bucketName
                    }
                }
            }
        };
        // Making a JSON-clone, because === is cheating!
        const newTemplate = JSON.parse(JSON.stringify(currentTemplate));
        const differences = diff_template_1.diffTemplate(currentTemplate, newTemplate);
        test.deepEqual(differences.differenceCount, 0, 'returns an empty diff');
        test.done();
    },
    'when a resource is created': (test) => {
        const currentTemplate = { Resources: {} };
        const newTemplate = { Resources: { BucketResource: { Type: 'AWS::S3::Bucket' } } };
        const differences = diff_template_1.diffTemplate(currentTemplate, newTemplate);
        test.equal(differences.differenceCount, 1, 'returns a single difference');
        test.equal(differences.resources.differenceCount, 1, 'the difference is in the Resources section');
        const difference = differences.resources.changes.BucketResource;
        test.notStrictEqual(difference, undefined, 'the difference is on the BucketResource logical ID');
        test.ok(difference && difference.isAddition, 'the difference reflects there was no such resource before');
        test.deepEqual(difference && difference.newResourceType, 'AWS::S3::Bucket', 'the difference reports the resource type');
        test.equal(difference && difference.changeImpact, diff_template_1.ResourceImpact.WILL_CREATE, 'the difference reflects that a new resource will be created');
        test.done();
    },
    'when a resource is deleted (no DeletionPolicy)': (test) => {
        const currentTemplate = {
            Resources: {
                BucketResource: { Type: 'AWS::S3::Bucket' },
                BucketPolicyResource: BUCKET_POLICY_RESOURCE
            }
        };
        const newTemplate = {
            Resources: {
                BucketResource: { Type: 'AWS::S3::Bucket' }
            }
        };
        const differences = diff_template_1.diffTemplate(currentTemplate, newTemplate);
        test.equal(differences.differenceCount, 1, 'returns a single difference');
        test.equal(differences.resources.differenceCount, 1, 'the difference is in the Resources section');
        const difference = differences.resources.changes.BucketPolicyResource;
        test.notStrictEqual(difference, undefined, 'the difference is on the BucketPolicyResource logical ID');
        test.ok(difference && difference.isRemoval, 'the difference reflects there is no such resource after');
        test.deepEqual(difference && difference.oldResourceType, 'AWS::S3::BucketPolicy', 'the difference reports the resource type');
        test.equal(difference && difference.changeImpact, diff_template_1.ResourceImpact.WILL_DESTROY, 'the difference reflects that the resource will be deleted');
        test.done();
    },
    'when a resource is deleted (DeletionPolicy=Retain)': (test) => {
        const currentTemplate = {
            Resources: {
                BucketResource: { Type: 'AWS::S3::Bucket' },
                BucketPolicyResource: {
                    Type: 'AWS::S3::BucketPolicy',
                    DeletionPolicy: 'Retain',
                    Properties: {
                        PolicyDocument: POLICY_DOCUMENT,
                        Bucket: { Ref: 'BucketResource' }
                    }
                }
            }
        };
        const newTemplate = {
            Resources: { BucketResource: { Type: 'AWS::S3::Bucket' } }
        };
        const differences = diff_template_1.diffTemplate(currentTemplate, newTemplate);
        test.equal(differences.differenceCount, 1, 'returns a single difference');
        test.equal(differences.resources.differenceCount, 1, 'the difference is in the Resources section');
        const difference = differences.resources.changes.BucketPolicyResource;
        test.notStrictEqual(difference, undefined, 'the difference is on the BucketPolicyResource logical ID');
        test.ok(difference && difference.isRemoval, 'the difference reflects there is no such resource after');
        test.deepEqual(difference && difference.oldResourceType, 'AWS::S3::BucketPolicy', 'the difference reports the resource type');
        test.equal(difference && difference.changeImpact, diff_template_1.ResourceImpact.WILL_ORPHAN, 'the difference reflects that the resource will be orphaned');
        test.done();
    },
    'when a property changes': (test) => {
        const bucketName = 'ShineyBucketName';
        const currentTemplate = {
            Resources: {
                QueueResource: {
                    Type: 'AWS::SQS::Queue'
                },
                BucketResource: {
                    Type: 'AWS::S3::Bucket',
                    Properties: {
                        BucketName: bucketName
                    }
                }
            }
        };
        const newBucketName = `${bucketName}-v2`;
        const newTemplate = {
            Resources: {
                QueueResource: {
                    Type: 'AWS::SQS::Queue'
                },
                BucketResource: {
                    Type: 'AWS::S3::Bucket',
                    Properties: {
                        BucketName: newBucketName
                    }
                }
            }
        };
        const differences = diff_template_1.diffTemplate(currentTemplate, newTemplate);
        test.equal(differences.differenceCount, 1, 'returns a single difference');
        test.equal(differences.resources.differenceCount, 1, 'the difference is in the Resources section');
        const difference = differences.resources.changes.BucketResource;
        test.notStrictEqual(difference, undefined, 'the difference is on the BucketResource logical ID');
        test.equal(difference && difference.oldResourceType, 'AWS::S3::Bucket', 'the difference reports the resource type');
        test.deepEqual(difference && difference.propertyUpdates, { BucketName: { oldValue: bucketName, newValue: newBucketName, changeImpact: diff_template_1.ResourceImpact.WILL_REPLACE, isDifferent: true } }, 'the difference reports property-level changes');
        test.done();
    },
    'change in dependencies counts as a simple update'(test) {
        // GIVEN
        const currentTemplate = {
            Resources: {
                BucketResource: {
                    Type: 'AWS::S3::Bucket',
                    DependsOn: ['SomeResource']
                }
            }
        };
        // WHEN
        const newTemplate = {
            Resources: {
                BucketResource: {
                    Type: 'AWS::S3::Bucket',
                    DependsOn: ['SomeResource', 'SomeOtherResource']
                }
            }
        };
        const differences = diff_template_1.diffTemplate(currentTemplate, newTemplate);
        // THEN
        test.equal(differences.differenceCount, 1, 'no change');
        const difference = differences.resources.changes.BucketResource;
        test.equal(difference && difference.changeImpact, diff_template_1.ResourceImpact.WILL_UPDATE, 'the difference reflects that the resource will be replaced');
        test.done();
    },
    'when a property is deleted': (test) => {
        const bucketName = 'ShineyBucketName';
        const currentTemplate = {
            Resources: {
                QueueResource: {
                    Type: 'AWS::SQS::Queue'
                },
                BucketResource: {
                    Type: 'AWS::S3::Bucket',
                    Properties: {
                        BucketName: bucketName
                    }
                }
            }
        };
        const newTemplate = {
            Resources: {
                QueueResource: {
                    Type: 'AWS::SQS::Queue'
                },
                BucketResource: {
                    Type: 'AWS::S3::Bucket'
                }
            }
        };
        const differences = diff_template_1.diffTemplate(currentTemplate, newTemplate);
        test.equal(differences.differenceCount, 1, 'returns a single difference');
        test.equal(differences.resources.differenceCount, 1, 'the difference is in the Resources section');
        const difference = differences.resources.changes.BucketResource;
        test.notStrictEqual(difference, undefined, 'the difference is on the BucketResource logical ID');
        test.equal(difference && difference.oldResourceType, 'AWS::S3::Bucket', 'the difference reports the resource type');
        test.deepEqual(difference && difference.propertyUpdates, { BucketName: { oldValue: bucketName, newValue: undefined, changeImpact: diff_template_1.ResourceImpact.WILL_REPLACE, isDifferent: true } }, 'the difference reports property-level changes');
        test.done();
    },
    'when a property is added': (test) => {
        const bucketName = 'ShineyBucketName';
        const currentTemplate = {
            Resources: {
                QueueResource: {
                    Type: 'AWS::SQS::Queue'
                },
                BucketResource: {
                    Type: 'AWS::S3::Bucket'
                }
            }
        };
        const newTemplate = {
            Resources: {
                QueueResource: {
                    Type: 'AWS::SQS::Queue'
                },
                BucketResource: {
                    Type: 'AWS::S3::Bucket',
                    Properties: {
                        BucketName: bucketName
                    }
                }
            }
        };
        const differences = diff_template_1.diffTemplate(currentTemplate, newTemplate);
        test.equal(differences.differenceCount, 1, 'returns a single difference');
        test.equal(differences.resources.differenceCount, 1, 'the difference is in the Resources section');
        const difference = differences.resources.changes.BucketResource;
        test.notStrictEqual(difference, undefined, 'the difference is on the BucketResource logical ID');
        test.equal(difference && difference.oldResourceType, 'AWS::S3::Bucket', 'the difference reports the resource type');
        test.deepEqual(difference && difference.propertyUpdates, { BucketName: { oldValue: undefined, newValue: bucketName, changeImpact: diff_template_1.ResourceImpact.WILL_REPLACE, isDifferent: true } }, 'the difference reports property-level changes');
        test.done();
    },
    'when a resource type changed': (test) => {
        const currentTemplate = {
            Resources: {
                BucketResource: {
                    Type: 'AWS::IAM::Policy',
                    Properties: {
                        PolicyName: 'PolicyName'
                    }
                }
            }
        };
        const newTemplate = {
            Resources: {
                BucketResource: {
                    Type: 'AWS::S3::Bucket',
                    Properties: {
                        BucketName: 'BucketName'
                    }
                }
            }
        };
        const differences = diff_template_1.diffTemplate(currentTemplate, newTemplate);
        test.equal(differences.differenceCount, 1, 'returns a single difference');
        test.equal(differences.resources.differenceCount, 1, 'the difference is in the Resources section');
        const difference = differences.resources.changes.BucketResource;
        test.notStrictEqual(difference, undefined, 'the difference is on the BucketResource logical ID');
        test.deepEqual(difference && difference.oldResourceType, 'AWS::IAM::Policy');
        test.deepEqual(difference && difference.newResourceType, 'AWS::S3::Bucket');
        test.equal(difference && difference.changeImpact, diff_template_1.ResourceImpact.WILL_REPLACE, 'the difference reflects that the resource will be replaced');
        test.done();
    },
    'resource replacement is tracked through references': (test) => {
        // If a resource is replaced, then that change shows that references are
        // going to change. This may lead to replacement of downstream resources
        // if the reference is used in an immutable property, and so on.
        // GIVEN
        const currentTemplate = {
            Resources: {
                Bucket: {
                    Type: 'AWS::S3::Bucket',
                    Properties: { BucketName: 'Name1', },
                },
                Queue: {
                    Type: 'AWS::SQS::Queue',
                    Properties: { QueueName: { Ref: 'Bucket' } },
                },
                Topic: {
                    Type: 'AWS::SNS::Topic',
                    Properties: { TopicName: { Ref: 'Queue' } },
                }
            }
        };
        // WHEN
        const newTemplate = {
            Resources: {
                Bucket: {
                    Type: 'AWS::S3::Bucket',
                    Properties: { BucketName: 'Name2', },
                },
                Queue: {
                    Type: 'AWS::SQS::Queue',
                    Properties: { QueueName: { Ref: 'Bucket' } },
                },
                Topic: {
                    Type: 'AWS::SNS::Topic',
                    Properties: { TopicName: { Ref: 'Queue' } },
                }
            }
        };
        const differences = diff_template_1.diffTemplate(currentTemplate, newTemplate);
        // THEN
        test.equal(differences.resources.differenceCount, 3, 'all resources are replaced');
        test.done();
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5kaWZmLXRlbXBsYXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGVzdC5kaWZmLXRlbXBsYXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsdUNBQXFDO0FBR3JDLHdEQUFvRTtBQUVwRSxNQUFNLGVBQWUsR0FBRyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDLHdCQUF3QjtBQUNoRSxNQUFNLHNCQUFzQixHQUFHO0lBQzdCLElBQUksRUFBRSx1QkFBdUI7SUFDN0IsVUFBVSxFQUFFO1FBQ1YsY0FBYyxFQUFFLGVBQWU7UUFDL0IsTUFBTSxFQUFFLEVBQUUsR0FBRyxFQUFFLGdCQUFnQixFQUFFO0tBQ2xDO0NBQ0YsQ0FBQztBQUVGLE9BQU8sQ0FBQyxZQUFZLEdBQUc7SUFDckIsNkJBQTZCLEVBQUUsQ0FBQyxJQUFVLEVBQUUsRUFBRTtRQUM1QyxNQUFNLFVBQVUsR0FBRyxrQkFBa0IsQ0FBQztRQUN0QyxNQUFNLGVBQWUsR0FBRztZQUN0QixTQUFTLEVBQUU7Z0JBQ1Qsb0JBQW9CLEVBQUUsc0JBQXNCO2dCQUM1QyxjQUFjLEVBQUU7b0JBQ2QsSUFBSSxFQUFFLGlCQUFpQjtvQkFDdkIsVUFBVSxFQUFFO3dCQUNWLFVBQVUsRUFBRSxVQUFVO3FCQUN2QjtpQkFDRjthQUNGO1NBQ0YsQ0FBQztRQUNGLGdEQUFnRDtRQUNoRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztRQUVoRSxNQUFNLFdBQVcsR0FBRyw0QkFBWSxDQUFDLGVBQWUsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUMvRCxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxFQUFFLHVCQUF1QixDQUFDLENBQUM7UUFDeEUsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUVELDRCQUE0QixFQUFFLENBQUMs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R0FBRztpQkFDckM7Z0JBQ0QsS0FBSyxFQUFFO29CQUNMLElBQUksRUFBRSxpQkFBaUI7b0JBQ3ZCLFVBQVUsRUFBRSxFQUFFLFNBQVMsRUFBRSxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsRUFBQztpQkFDNUM7Z0JBQ0QsS0FBSyxFQUFFO29CQUNMLElBQUksRUFBRSxpQkFBaUI7b0JBQ3ZCLFVBQVUsRUFBRSxFQUFFLFNBQVMsRUFBRSxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsRUFBQztpQkFDM0M7YUFDRjtTQUNGLENBQUM7UUFDRixNQUFNLFdBQVcsR0FBRyw0QkFBWSxDQUFDLGVBQWUsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUUvRCxPQUFPO1FBQ1AsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLGVBQWUsRUFBRSxDQUFDLEVBQUUsNEJBQTRCLENBQUMsQ0FBQztRQUNuRixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDZCxDQUFDO0NBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAnc291cmNlLW1hcC1zdXBwb3J0L3JlZ2lzdGVyJztcblxuaW1wb3J0IHsgVGVzdCB9IGZyb20gJ25vZGV1bml0JztcbmltcG9ydCB7IGRpZmZUZW1wbGF0ZSwgUmVzb3VyY2VJbXBhY3QgfSBmcm9tICcuLi9saWIvZGlmZi10ZW1wbGF0ZSc7XG5cbmNvbnN0IFBPTElDWV9ET0NVTUVOVCA9IHsgZm9vOiAnQmFyJyB9OyAvLyBPYnZpb3VzbHkgYSBmYWtlIG9uZSFcbmNvbnN0IEJVQ0tFVF9QT0xJQ1lfUkVTT1VSQ0UgPSB7XG4gIFR5cGU6ICdBV1M6OlMzOjpCdWNrZXRQb2xpY3knLFxuICBQcm9wZXJ0aWVzOiB7XG4gICAgUG9saWN5RG9jdW1lbnQ6IFBPTElDWV9ET0NVTUVOVCxcbiAgICBCdWNrZXQ6IHsgUmVmOiAnQnVja2V0UmVzb3VyY2UnIH1cbiAgfVxufTtcblxuZXhwb3J0cy5kaWZmVGVtcGxhdGUgPSB7XG4gICd3aGVuIHRoZXJlIGlzIG5vIGRpZmZlcmVuY2UnOiAodGVzdDogVGVzdCkgPT4ge1xuICAgIGNvbnN0IGJ1Y2tldE5hbWUgPSAnU2hpbmV5QnVja2V0TmFtZSc7XG4gICAgY29uc3QgY3VycmVudFRlbXBsYXRlID0ge1xuICAgICAgUmVzb3VyY2VzOiB7XG4gICAgICAgIEJ1Y2tldFBvbGljeVJlc291cmNlOiBCVUNLRVRfUE9MSUNZX1JFU09VUkNFLFxuICAgICAgICBCdWNrZXRSZXNvdXJjZToge1xuICAgICAgICAgIFR5cGU6ICdBV1M6OlMzOjpCdWNrZXQnLFxuICAgICAgICAgIFByb3BlcnRpZXM6IHtcbiAgICAgICAgICAgIEJ1Y2tldE5hbWU6IGJ1Y2tldE5hbWVcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuICAgIC8vIE1ha2luZyBhIEpTT04tY2xvbmUsIGJlY2F1c2UgPT09IGlzIGNoZWF0aW5nIVxuICAgIGNvbnN0IG5ld1RlbXBsYXRlID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShjdXJyZW50VGVtcGxhdGUpKTtcblxuICAgIGNvbnN0IGRpZmZlcmVuY2VzID0gZGlmZlRlbXBsYXRlKGN1cnJlbnRUZW1wbGF0ZSwgbmV3VGVtcGxhdGUpO1xuICAgIHRlc3QuZGVlcEVxdWFsKGRpZmZlcmVuY2VzLmRpZmZlcmVuY2VDb3VudCwgMCwgJ3JldHVybnMgYW4gZW1wdHkgZGlmZicpO1xuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gICd3aGVuIGEgcmVzb3VyY2UgaXMgY3JlYXRlZCc6ICh0ZXN0OiBUZXN0KSA9PiB7XG4gICAgY29uc3QgY3VycmVudFRlbXBsYXRlID0geyBSZXNvdXJjZXM6IHt9IH07XG5cbiAgICBjb25zdCBuZXdUZW1wbGF0ZSA9IHsgUmVzb3VyY2VzOiB7IEJ1Y2tldFJlc291cmNlOiB7IFR5cGU6ICdBV1M6OlMzOjpCdWNrZXQnIH0gfSB9O1xuXG4gICAgY29uc3QgZGlmZmVyZW5jZXMgPSBkaWZmVGVtcGxhdGUoY3VycmVudFRlbXBsYXRlLCBuZXdUZW1wbGF0ZSk7XG4gICAgdGVzdC5lcXVhbChkaWZmZXJlbmNlcy5kaWZmZXJlbmNlQ291bnQsIDEsICdyZXR1cm5zIGEgc2luZ2xlIGRpZmZlcmVuY2UnKTtcbiAgICB0ZXN0LmVxdWFsKGRpZmZlcmVuY2VzLnJlc291cmNlcy5kaWZmZXJlbmNlQ291bnQsIDEsICd0aGUgZGlmZmVyZW5jZSBpcyBpbiB0aGUgUmVzb3VyY2VzIHNlY3Rpb24nKTtcbiAgICBjb25zdCBkaWZmZXJlbmNlID0gZGlmZmVyZW5jZXMucmVzb3VyY2VzLmNoYW5nZXMuQnVja2V0UmVzb3VyY2U7XG4gICAgdGVzdC5ub3RTdHJpY3RFcXVhbChkaWZmZXJlbmNlLCB1bmRlZmluZWQsICd0aGUgZGlmZmVyZW5jZSBpcyBvbiB0aGUgQnVja2V0UmVzb3VyY2UgbG9naWNhbCBJRCcpO1xuICAgIHRlc3Qub2soZGlmZmVyZW5jZSAmJiBkaWZmZXJlbmNlLmlzQWRkaXRpb24sICd0aGUgZGlmZmVyZW5jZSByZWZsZWN0cyB0aGVyZSB3YXMgbm8gc3VjaCByZXNvdXJjZSBiZWZvcmUnKTtcbiAgICB0ZXN0LmRlZXBFcXVhbChkaWZmZXJlbmNlICYmIGRpZmZlcmVuY2UubmV3UmVzb3VyY2VUeXBlLCAnQVdTOjpTMzo6QnVja2V0JywgJ3RoZSBkaWZmZXJlbmNlIHJlcG9ydHMgdGhlIHJlc291cmNlIHR5cGUnKTtcbiAgICB0ZXN0LmVxdWFsKGRpZmZlcmVuY2UgJiYgZGlmZmVyZW5jZS5jaGFuZ2VJbXBhY3QsIFJlc291cmNlSW1wYWN0LldJTExfQ1JFQVRFLCAndGhlIGRpZmZlcmVuY2UgcmVmbGVjdHMgdGhhdCBhIG5ldyByZXNvdXJjZSB3aWxsIGJlIGNyZWF0ZWQnKTtcbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICAnd2hlbiBhIHJlc291cmNlIGlzIGRlbGV0ZWQgKG5vIERlbGV0aW9uUG9saWN5KSc6ICh0ZXN0OiBUZXN0KSA9PiB7XG4gICAgY29uc3QgY3VycmVudFRlbXBsYXRlID0ge1xuICAgICAgUmVzb3VyY2VzOiB7XG4gICAgICAgIEJ1Y2tldFJlc291cmNlOiB7IFR5cGU6ICdBV1M6OlMzOjpCdWNrZXQnIH0sXG4gICAgICAgIEJ1Y2tldFBvbGljeVJlc291cmNlOiBCVUNLRVRfUE9MSUNZX1JFU09VUkNFXG4gICAgICB9XG4gICAgfTtcblxuICAgIGNvbnN0IG5ld1RlbXBsYXRlID0ge1xuICAgICAgUmVzb3VyY2VzOiB7XG4gICAgICAgIEJ1Y2tldFJlc291cmNlOiB7IFR5cGU6ICdBV1M6OlMzOjpCdWNrZXQnIH1cbiAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3QgZGlmZmVyZW5jZXMgPSBkaWZmVGVtcGxhdGUoY3VycmVudFRlbXBsYXRlLCBuZXdUZW1wbGF0ZSk7XG4gICAgdGVzdC5lcXVhbChkaWZmZXJlbmNlcy5kaWZmZXJlbmNlQ291bnQsIDEsICdyZXR1cm5zIGEgc2luZ2xlIGRpZmZlcmVuY2UnKTtcbiAgICB0ZXN0LmVxdWFsKGRpZmZlcmVuY2VzLnJlc291cmNlcy5kaWZmZXJlbmNlQ291bnQsIDEsICd0aGUgZGlmZmVyZW5jZSBpcyBpbiB0aGUgUmVzb3VyY2VzIHNlY3Rpb24nKTtcbiAgICBjb25zdCBkaWZmZXJlbmNlID0gZGlmZmVyZW5jZXMucmVzb3VyY2VzLmNoYW5nZXMuQnVja2V0UG9saWN5UmVzb3VyY2U7XG4gICAgdGVzdC5ub3RTdHJpY3RFcXVhbChkaWZmZXJlbmNlLCB1bmRlZmluZWQsICd0aGUgZGlmZmVyZW5jZSBpcyBvbiB0aGUgQnVja2V0UG9saWN5UmVzb3VyY2UgbG9naWNhbCBJRCcpO1xuICAgIHRlc3Qub2soZGlmZmVyZW5jZSAmJiBkaWZmZXJlbmNlLmlzUmVtb3ZhbCwgJ3RoZSBkaWZmZXJlbmNlIHJlZmxlY3RzIHRoZXJlIGlzIG5vIHN1Y2ggcmVzb3VyY2UgYWZ0ZXInKTtcbiAgICB0ZXN0LmRlZXBFcXVhbChkaWZmZXJlbmNlICYmIGRpZmZlcmVuY2Uub2xkUmVzb3VyY2VUeXBlLCAnQVdTOjpTMzo6QnVja2V0UG9saWN5JywgJ3RoZSBkaWZmZXJlbmNlIHJlcG9ydHMgdGhlIHJlc291cmNlIHR5cGUnKTtcbiAgICB0ZXN0LmVxdWFsKGRpZmZlcmVuY2UgJiYgZGlmZmVyZW5jZS5jaGFuZ2VJbXBhY3QsIFJlc291cmNlSW1wYWN0LldJTExfREVTVFJPWSwgJ3RoZSBkaWZmZXJlbmNlIHJlZmxlY3RzIHRoYXQgdGhlIHJlc291cmNlIHdpbGwgYmUgZGVsZXRlZCcpO1xuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gICd3aGVuIGEgcmVzb3VyY2UgaXMgZGVsZXRlZCAoRGVsZXRpb25Qb2xpY3k9UmV0YWluKSc6ICh0ZXN0OiBUZXN0KSA9PiB7XG4gICAgY29uc3QgY3VycmVudFRlbXBsYXRlID0ge1xuICAgICAgUmVzb3VyY2VzOiB7XG4gICAgICAgIEJ1Y2tldFJlc291cmNlOiB7IFR5cGU6ICdBV1M6OlMzOjpCdWNrZXQnIH0sXG4gICAgICAgIEJ1Y2tldFBvbGljeVJlc291cmNlOiB7XG4gICAgICAgICAgVHlwZTogJ0FXUzo6UzM6OkJ1Y2tldFBvbGljeScsXG4gICAgICAgICAgRGVsZXRpb25Qb2xpY3k6ICdSZXRhaW4nLFxuICAgICAgICAgIFByb3BlcnRpZXM6IHtcbiAgICAgICAgICAgIFBvbGljeURvY3VtZW50OiBQT0xJQ1lfRE9DVU1FTlQsXG4gICAgICAgICAgICBCdWNrZXQ6IHsgUmVmOiAnQnVja2V0UmVzb3VyY2UnIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3QgbmV3VGVtcGxhdGUgPSB7XG4gICAgICBSZXNvdXJjZXM6IHsgQnVja2V0UmVzb3VyY2U6IHsgVHlwZTogJ0FXUzo6UzM6OkJ1Y2tldCcgfSB9XG4gICAgfTtcblxuICAgIGNvbnN0IGRpZmZlcmVuY2VzID0gZGlmZlRlbXBsYXRlKGN1cnJlbnRUZW1wbGF0ZSwgbmV3VGVtcGxhdGUpO1xuICAgIHRlc3QuZXF1YWwoZGlmZmVyZW5jZXMuZGlmZmVyZW5jZUNvdW50LCAxLCAncmV0dXJucyBhIHNpbmdsZSBkaWZmZXJlbmNlJyk7XG4gICAgdGVzdC5lcXVhbChkaWZmZXJlbmNlcy5yZXNvdXJjZXMuZGlmZmVyZW5jZUNvdW50LCAxLCAndGhlIGRpZmZlcmVuY2UgaXMgaW4gdGhlIFJlc291cmNlcyBzZWN0aW9uJyk7XG4gICAgY29uc3QgZGlmZmVyZW5jZSA9IGRpZmZlcmVuY2VzLnJlc291cmNlcy5jaGFuZ2VzLkJ1Y2tldFBvbGljeVJlc291cmNlO1xuICAgIHRlc3Qubm90U3RyaWN0RXF1YWwoZGlmZmVyZW5jZSwgdW5kZWZpbmVkLCAndGhlIGRpZmZlcmVuY2UgaXMgb24gdGhlIEJ1Y2tldFBvbGljeVJlc291cmNlIGxvZ2ljYWwgSUQnKTtcbiAgICB0ZXN0Lm9rKGRpZmZlcmVuY2UgJiYgZGlmZmVyZW5jZS5pc1JlbW92YWwsICd0aGUgZGlmZmVyZW5jZSByZWZsZWN0cyB0aGVyZSBpcyBubyBzdWNoIHJlc291cmNlIGFmdGVyJyk7XG4gICAgdGVzdC5kZWVwRXF1YWwoZGlmZmVyZW5jZSAmJiBkaWZmZXJlbmNlLm9sZFJlc291cmNlVHlwZSwgJ0FXUzo6UzM6OkJ1Y2tldFBvbGljeScsICd0aGUgZGlmZmVyZW5jZSByZXBvcnRzIHRoZSByZXNvdXJjZSB0eXBlJyk7XG4gICAgdGVzdC5lcXVhbChkaWZmZXJlbmNlICYmIGRpZmZlcmVuY2UuY2hhbmdlSW1wYWN0LCBSZXNvdXJjZUltcGFjdC5XSUxMX09SUEhBTiwgJ3RoZSBkaWZmZXJlbmNlIHJlZmxlY3RzIHRoYXQgdGhlIHJlc291cmNlIHdpbGwgYmUgb3JwaGFuZWQnKTtcbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICAnd2hlbiBhIHByb3BlcnR5IGNoYW5nZXMnOiAodGVzdDogVGVzdCkgPT4ge1xuICAgIGNvbnN0IGJ1Y2tldE5hbWUgPSAnU2hpbmV5QnVja2V0TmFtZSc7XG4gICAgY29uc3QgY3VycmVudFRlbXBsYXRlID0ge1xuICAgICAgUmVzb3VyY2VzOiB7XG4gICAgICAgIFF1ZXVlUmVzb3VyY2U6IHtcbiAgICAgICAgICBUeXBlOiAnQVdTOjpTUVM6OlF1ZXVlJ1xuICAgICAgICB9LFxuICAgICAgICBCdWNrZXRSZXNvdXJjZToge1xuICAgICAgICAgIFR5cGU6ICdBV1M6OlMzOjpCdWNrZXQnLFxuICAgICAgICAgIFByb3BlcnRpZXM6IHtcbiAgICAgICAgICAgIEJ1Y2tldE5hbWU6IGJ1Y2tldE5hbWVcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3QgbmV3QnVja2V0TmFtZSA9IGAke2J1Y2tldE5hbWV9LXYyYDtcbiAgICBjb25zdCBuZXdUZW1wbGF0ZSA9IHtcbiAgICAgIFJlc291cmNlczoge1xuICAgICAgICBRdWV1ZVJlc291cmNlOiB7XG4gICAgICAgICAgVHlwZTogJ0FXUzo6U1FTOjpRdWV1ZSdcbiAgICAgICAgfSxcbiAgICAgICAgQnVja2V0UmVzb3VyY2U6IHtcbiAgICAgICAgICBUeXBlOiAnQVdTOjpTMzo6QnVja2V0JyxcbiAgICAgICAgICBQcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgICBCdWNrZXROYW1lOiBuZXdCdWNrZXROYW1lXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcblxuICAgIGNvbnN0IGRpZmZlcmVuY2VzID0gZGlmZlRlbXBsYXRlKGN1cnJlbnRUZW1wbGF0ZSwgbmV3VGVtcGxhdGUpO1xuICAgIHRlc3QuZXF1YWwoZGlmZmVyZW5jZXMuZGlmZmVyZW5jZUNvdW50LCAxLCAncmV0dXJucyBhIHNpbmdsZSBkaWZmZXJlbmNlJyk7XG4gICAgdGVzdC5lcXVhbChkaWZmZXJlbmNlcy5yZXNvdXJjZXMuZGlmZmVyZW5jZUNvdW50LCAxLCAndGhlIGRpZmZlcmVuY2UgaXMgaW4gdGhlIFJlc291cmNlcyBzZWN0aW9uJyk7XG4gICAgY29uc3QgZGlmZmVyZW5jZSA9IGRpZmZlcmVuY2VzLnJlc291cmNlcy5jaGFuZ2VzLkJ1Y2tldFJlc291cmNlO1xuICAgIHRlc3Qubm90U3RyaWN0RXF1YWwoZGlmZmVyZW5jZSwgdW5kZWZpbmVkLCAndGhlIGRpZmZlcmVuY2UgaXMgb24gdGhlIEJ1Y2tldFJlc291cmNlIGxvZ2ljYWwgSUQnKTtcbiAgICB0ZXN0LmVxdWFsKGRpZmZlcmVuY2UgJiYgZGlmZmVyZW5jZS5vbGRSZXNvdXJjZVR5cGUsICdBV1M6OlMzOjpCdWNrZXQnLCAndGhlIGRpZmZlcmVuY2UgcmVwb3J0cyB0aGUgcmVzb3VyY2UgdHlwZScpO1xuICAgIHRlc3QuZGVlcEVxdWFsKGRpZmZlcmVuY2UgJiYgZGlmZmVyZW5jZS5wcm9wZXJ0eVVwZGF0ZXMsXG4gICAgICAgICAgICAgeyBCdWNrZXROYW1lOiB7IG9sZFZhbHVlOiBidWNrZXROYW1lLCBuZXdWYWx1ZTogbmV3QnVja2V0TmFtZSwgY2hhbmdlSW1wYWN0OiBSZXNvdXJjZUltcGFjdC5XSUxMX1JFUExBQ0UsIGlzRGlmZmVyZW50OiB0cnVlIH0gfSxcbiAgICAgICAgICAgICAndGhlIGRpZmZlcmVuY2UgcmVwb3J0cyBwcm9wZXJ0eS1sZXZlbCBjaGFuZ2VzJyk7XG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgJ2NoYW5nZSBpbiBkZXBlbmRlbmNpZXMgY291bnRzIGFzIGEgc2ltcGxlIHVwZGF0ZScodGVzdDogVGVzdCkge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3QgY3VycmVudFRlbXBsYXRlID0ge1xuICAgICAgUmVzb3VyY2VzOiB7XG4gICAgICAgIEJ1Y2tldFJlc291cmNlOiB7XG4gICAgICAgICAgVHlwZTogJ0FXUzo6UzM6OkJ1Y2tldCcsXG4gICAgICAgICAgRGVwZW5kc09uOiBbJ1NvbWVSZXNvdXJjZSddXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IG5ld1RlbXBsYXRlID0ge1xuICAgICAgUmVzb3VyY2VzOiB7XG4gICAgICAgIEJ1Y2tldFJlc291cmNlOiB7XG4gICAgICAgICAgVHlwZTogJ0FXUzo6UzM6OkJ1Y2tldCcsXG4gICAgICAgICAgRGVwZW5kc09uOiBbJ1NvbWVSZXNvdXJjZScsICdTb21lT3RoZXJSZXNvdXJjZSddXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuICAgIGNvbnN0IGRpZmZlcmVuY2VzID0gZGlmZlRlbXBsYXRlKGN1cnJlbnRUZW1wbGF0ZSwgbmV3VGVtcGxhdGUpO1xuXG4gICAgLy8gVEhFTlxuICAgIHRlc3QuZXF1YWwoZGlmZmVyZW5jZXMuZGlmZmVyZW5jZUNvdW50LCAxLCAnbm8gY2hhbmdlJyk7XG4gICAgY29uc3QgZGlmZmVyZW5jZSA9IGRpZmZlcmVuY2VzLnJlc291cmNlcy5jaGFuZ2VzLkJ1Y2tldFJlc291cmNlO1xuICAgIHRlc3QuZXF1YWwoZGlmZmVyZW5jZSAmJiBkaWZmZXJlbmNlLmNoYW5nZUltcGFjdCwgUmVzb3VyY2VJbXBhY3QuV0lMTF9VUERBVEUsICd0aGUgZGlmZmVyZW5jZSByZWZsZWN0cyB0aGF0IHRoZSByZXNvdXJjZSB3aWxsIGJlIHJlcGxhY2VkJyk7XG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgJ3doZW4gYSBwcm9wZXJ0eSBpcyBkZWxldGVkJzogKHRlc3Q6IFRlc3QpID0+IHtcbiAgICBjb25zdCBidWNrZXROYW1lID0gJ1NoaW5leUJ1Y2tldE5hbWUnO1xuICAgIGNvbnN0IGN1cnJlbnRUZW1wbGF0ZSA9IHtcbiAgICAgIFJlc291cmNlczoge1xuICAgICAgICBRdWV1ZVJlc291cmNlOiB7XG4gICAgICAgICAgVHlwZTogJ0FXUzo6U1FTOjpRdWV1ZSdcbiAgICAgICAgfSxcbiAgICAgICAgQnVja2V0UmVzb3VyY2U6IHtcbiAgICAgICAgICBUeXBlOiAnQVdTOjpTMzo6QnVja2V0JyxcbiAgICAgICAgICBQcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgICBCdWNrZXROYW1lOiBidWNrZXROYW1lXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcblxuICAgIGNvbnN0IG5ld1RlbXBsYXRlID0ge1xuICAgICAgUmVzb3VyY2VzOiB7XG4gICAgICAgIFF1ZXVlUmVzb3VyY2U6IHtcbiAgICAgICAgICBUeXBlOiAnQVdTOjpTUVM6OlF1ZXVlJ1xuICAgICAgICB9LFxuICAgICAgICBCdWNrZXRSZXNvdXJjZToge1xuICAgICAgICAgIFR5cGU6ICdBV1M6OlMzOjpCdWNrZXQnXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3QgZGlmZmVyZW5jZXMgPSBkaWZmVGVtcGxhdGUoY3VycmVudFRlbXBsYXRlLCBuZXdUZW1wbGF0ZSk7XG4gICAgdGVzdC5lcXVhbChkaWZmZXJlbmNlcy5kaWZmZXJlbmNlQ291bnQsIDEsICdyZXR1cm5zIGEgc2luZ2xlIGRpZmZlcmVuY2UnKTtcbiAgICB0ZXN0LmVxdWFsKGRpZmZlcmVuY2VzLnJlc291cmNlcy5kaWZmZXJlbmNlQ291bnQsIDEsICd0aGUgZGlmZmVyZW5jZSBpcyBpbiB0aGUgUmVzb3VyY2VzIHNlY3Rpb24nKTtcbiAgICBjb25zdCBkaWZmZXJlbmNlID0gZGlmZmVyZW5jZXMucmVzb3VyY2VzLmNoYW5nZXMuQnVja2V0UmVzb3VyY2U7XG4gICAgdGVzdC5ub3RTdHJpY3RFcXVhbChkaWZmZXJlbmNlLCB1bmRlZmluZWQsICd0aGUgZGlmZmVyZW5jZSBpcyBvbiB0aGUgQnVja2V0UmVzb3VyY2UgbG9naWNhbCBJRCcpO1xuICAgIHRlc3QuZXF1YWwoZGlmZmVyZW5jZSAmJiBkaWZmZXJlbmNlLm9sZFJlc291cmNlVHlwZSwgJ0FXUzo6UzM6OkJ1Y2tldCcsICd0aGUgZGlmZmVyZW5jZSByZXBvcnRzIHRoZSByZXNvdXJjZSB0eXBlJyk7XG4gICAgdGVzdC5kZWVwRXF1YWwoZGlmZmVyZW5jZSAmJiBkaWZmZXJlbmNlLnByb3BlcnR5VXBkYXRlcyxcbiAgICAgICAgICAgICB7IEJ1Y2tldE5hbWU6IHsgb2xkVmFsdWU6IGJ1Y2tldE5hbWUsIG5ld1ZhbHVlOiB1bmRlZmluZWQsIGNoYW5nZUltcGFjdDogUmVzb3VyY2VJbXBhY3QuV0lMTF9SRVBMQUNFLCBpc0RpZmZlcmVudDogdHJ1ZSB9IH0sXG4gICAgICAgICAgICAgJ3RoZSBkaWZmZXJlbmNlIHJlcG9ydHMgcHJvcGVydHktbGV2ZWwgY2hhbmdlcycpO1xuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gICd3aGVuIGEgcHJvcGVydHkgaXMgYWRkZWQnOiAodGVzdDogVGVzdCkgPT4ge1xuICAgIGNvbnN0IGJ1Y2tldE5hbWUgPSAnU2hpbmV5QnVja2V0TmFtZSc7XG4gICAgY29uc3QgY3VycmVudFRlbXBsYXRlID0ge1xuICAgICAgUmVzb3VyY2VzOiB7XG4gICAgICAgIFF1ZXVlUmVzb3VyY2U6IHtcbiAgICAgICAgICBUeXBlOiAnQVdTOjpTUVM6OlF1ZXVlJ1xuICAgICAgICB9LFxuICAgICAgICBCdWNrZXRSZXNvdXJjZToge1xuICAgICAgICAgIFR5cGU6ICdBV1M6OlMzOjpCdWNrZXQnXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3QgbmV3VGVtcGxhdGUgPSB7XG4gICAgICBSZXNvdXJjZXM6IHtcbiAgICAgICAgUXVldWVSZXNvdXJjZToge1xuICAgICAgICAgIFR5cGU6ICdBV1M6OlNRUzo6UXVldWUnXG4gICAgICAgIH0sXG4gICAgICAgIEJ1Y2tldFJlc291cmNlOiB7XG4gICAgICAgICAgVHlwZTogJ0FXUzo6UzM6OkJ1Y2tldCcsXG4gICAgICAgICAgUHJvcGVydGllczoge1xuICAgICAgICAgICAgQnVja2V0TmFtZTogYnVja2V0TmFtZVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH07XG5cbiAgICBjb25zdCBkaWZmZXJlbmNlcyA9IGRpZmZUZW1wbGF0ZShjdXJyZW50VGVtcGxhdGUsIG5ld1RlbXBsYXRlKTtcbiAgICB0ZXN0LmVxdWFsKGRpZmZlcmVuY2VzLmRpZmZlcmVuY2VDb3VudCwgMSwgJ3JldHVybnMgYSBzaW5nbGUgZGlmZmVyZW5jZScpO1xuICAgIHRlc3QuZXF1YWwoZGlmZmVyZW5jZXMucmVzb3VyY2VzLmRpZmZlcmVuY2VDb3VudCwgMSwgJ3RoZSBkaWZmZXJlbmNlIGlzIGluIHRoZSBSZXNvdXJjZXMgc2VjdGlvbicpO1xuICAgIGNvbnN0IGRpZmZlcmVuY2UgPSBkaWZmZXJlbmNlcy5yZXNvdXJjZXMuY2hhbmdlcy5CdWNrZXRSZXNvdXJjZTtcbiAgICB0ZXN0Lm5vdFN0cmljdEVxdWFsKGRpZmZlcmVuY2UsIHVuZGVmaW5lZCwgJ3RoZSBkaWZmZXJlbmNlIGlzIG9uIHRoZSBCdWNrZXRSZXNvdXJjZSBsb2dpY2FsIElEJyk7XG4gICAgdGVzdC5lcXVhbChkaWZmZXJlbmNlICYmIGRpZmZlcmVuY2Uub2xkUmVzb3VyY2VUeXBlLCAnQVdTOjpTMzo6QnVja2V0JywgJ3RoZSBkaWZmZXJlbmNlIHJlcG9ydHMgdGhlIHJlc291cmNlIHR5cGUnKTtcbiAgICB0ZXN0LmRlZXBFcXVhbChkaWZmZXJlbmNlICYmIGRpZmZlcmVuY2UucHJvcGVydHlVcGRhdGVzLFxuICAgICAgICAgICAgIHsgQnVja2V0TmFtZTogeyBvbGRWYWx1ZTogdW5kZWZpbmVkLCBuZXdWYWx1ZTogYnVja2V0TmFtZSwgY2hhbmdlSW1wYWN0OiBSZXNvdXJjZUltcGFjdC5XSUxMX1JFUExBQ0UsIGlzRGlmZmVyZW50OiB0cnVlIH0gfSxcbiAgICAgICAgICAgICAndGhlIGRpZmZlcmVuY2UgcmVwb3J0cyBwcm9wZXJ0eS1sZXZlbCBjaGFuZ2VzJyk7XG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgJ3doZW4gYSByZXNvdXJjZSB0eXBlIGNoYW5nZWQnOiAodGVzdDogVGVzdCkgPT4ge1xuICAgIGNvbnN0IGN1cnJlbnRUZW1wbGF0ZSA9IHtcbiAgICAgIFJlc291cmNlczoge1xuICAgICAgICBCdWNrZXRSZXNvdXJjZToge1xuICAgICAgICAgIFR5cGU6ICdBV1M6OklBTTo6UG9saWN5JyxcbiAgICAgICAgICBQcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgICBQb2xpY3lOYW1lOiAnUG9saWN5TmFtZSdcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3QgbmV3VGVtcGxhdGUgPSB7XG4gICAgICBSZXNvdXJjZXM6IHtcbiAgICAgICAgQnVja2V0UmVzb3VyY2U6IHtcbiAgICAgICAgICBUeXBlOiAnQVdTOjpTMzo6QnVja2V0JyxcbiAgICAgICAgICBQcm9wZXJ0aWVzOiB7XG4gICAgICAgICAgICBCdWNrZXROYW1lOiAnQnVja2V0TmFtZSdcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3QgZGlmZmVyZW5jZXMgPSBkaWZmVGVtcGxhdGUoY3VycmVudFRlbXBsYXRlLCBuZXdUZW1wbGF0ZSk7XG4gICAgdGVzdC5lcXVhbChkaWZmZXJlbmNlcy5kaWZmZXJlbmNlQ291bnQsIDEsICdyZXR1cm5zIGEgc2luZ2xlIGRpZmZlcmVuY2UnKTtcbiAgICB0ZXN0LmVxdWFsKGRpZmZlcmVuY2VzLnJlc291cmNlcy5kaWZmZXJlbmNlQ291bnQsIDEsICd0aGUgZGlmZmVyZW5jZSBpcyBpbiB0aGUgUmVzb3VyY2VzIHNlY3Rpb24nKTtcbiAgICBjb25zdCBkaWZmZXJlbmNlID0gZGlmZmVyZW5jZXMucmVzb3VyY2VzLmNoYW5nZXMuQnVja2V0UmVzb3VyY2U7XG4gICAgdGVzdC5ub3RTdHJpY3RFcXVhbChkaWZmZXJlbmNlLCB1bmRlZmluZWQsICd0aGUgZGlmZmVyZW5jZSBpcyBvbiB0aGUgQnVja2V0UmVzb3VyY2UgbG9naWNhbCBJRCcpO1xuICAgIHRlc3QuZGVlcEVxdWFsKGRpZmZlcmVuY2UgJiYgZGlmZmVyZW5jZS5vbGRSZXNvdXJjZVR5cGUsICdBV1M6OklBTTo6UG9saWN5Jyk7XG4gICAgdGVzdC5kZWVwRXF1YWwoZGlmZmVyZW5jZSAmJiBkaWZmZXJlbmNlLm5ld1Jlc291cmNlVHlwZSwgJ0FXUzo6UzM6OkJ1Y2tldCcpO1xuICAgIHRlc3QuZXF1YWwoZGlmZmVyZW5jZSAmJiBkaWZmZXJlbmNlLmNoYW5nZUltcGFjdCwgUmVzb3VyY2VJbXBhY3QuV0lMTF9SRVBMQUNFLCAndGhlIGRpZmZlcmVuY2UgcmVmbGVjdHMgdGhhdCB0aGUgcmVzb3VyY2Ugd2lsbCBiZSByZXBsYWNlZCcpO1xuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gICdyZXNvdXJjZSByZXBsYWNlbWVudCBpcyB0cmFja2VkIHRocm91Z2ggcmVmZXJlbmNlcyc6ICh0ZXN0OiBUZXN0KSA9PiB7XG4gICAgLy8gSWYgYSByZXNvdXJjZSBpcyByZXBsYWNlZCwgdGhlbiB0aGF0IGNoYW5nZSBzaG93cyB0aGF0IHJlZmVyZW5jZXMgYXJlXG4gICAgLy8gZ29pbmcgdG8gY2hhbmdlLiBUaGlzIG1heSBsZWFkIHRvIHJlcGxhY2VtZW50IG9mIGRvd25zdHJlYW0gcmVzb3VyY2VzXG4gICAgLy8gaWYgdGhlIHJlZmVyZW5jZSBpcyB1c2VkIGluIGFuIGltbXV0YWJsZSBwcm9wZXJ0eSwgYW5kIHNvIG9uLlxuXG4gICAgLy8gR0lWRU5cbiAgICBjb25zdCBjdXJyZW50VGVtcGxhdGUgPSB7XG4gICAgICBSZXNvdXJjZXM6IHtcbiAgICAgICAgQnVja2V0OiB7XG4gICAgICAgICAgVHlwZTogJ0FXUzo6UzM6OkJ1Y2tldCcsXG4gICAgICAgICAgUHJvcGVydGllczogeyBCdWNrZXROYW1lOiAnTmFtZTEnLCB9LCAvLyBJbW11dGFibGUgcHJvcFxuICAgICAgICB9LFxuICAgICAgICBRdWV1ZToge1xuICAgICAgICAgIFR5cGU6ICdBV1M6OlNRUzo6UXVldWUnLFxuICAgICAgICAgIFByb3BlcnRpZXM6IHsgUXVldWVOYW1lOiB7IFJlZjogJ0J1Y2tldCcgfX0sIC8vIEltbXV0YWJsZSBwcm9wXG4gICAgICAgIH0sXG4gICAgICAgIFRvcGljOiB7XG4gICAgICAgICAgVHlwZTogJ0FXUzo6U05TOjpUb3BpYycsXG4gICAgICAgICAgUHJvcGVydGllczogeyBUb3BpY05hbWU6IHsgUmVmOiAnUXVldWUnIH19LCAvLyBJbW11dGFibGUgcHJvcFxuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcblxuICAgIC8vIFdIRU5cbiAgICBjb25zdCBuZXdUZW1wbGF0ZSA9IHtcbiAgICAgIFJlc291cmNlczoge1xuICAgICAgICBCdWNrZXQ6IHtcbiAgICAgICAgICBUeXBlOiAnQVdTOjpTMzo6QnVja2V0JyxcbiAgICAgICAgICBQcm9wZXJ0aWVzOiB7IEJ1Y2tldE5hbWU6ICdOYW1lMicsIH0sXG4gICAgICAgIH0sXG4gICAgICAgIFF1ZXVlOiB7XG4gICAgICAgICAgVHlwZTogJ0FXUzo6U1FTOjpRdWV1ZScsXG4gICAgICAgICAgUHJvcGVydGllczogeyBRdWV1ZU5hbWU6IHsgUmVmOiAnQnVja2V0JyB9fSxcbiAgICAgICAgfSxcbiAgICAgICAgVG9waWM6IHtcbiAgICAgICAgICBUeXBlOiAnQVdTOjpTTlM6OlRvcGljJyxcbiAgICAgICAgICBQcm9wZXJ0aWVzOiB7IFRvcGljTmFtZTogeyBSZWY6ICdRdWV1ZScgfX0sXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuICAgIGNvbnN0IGRpZmZlcmVuY2VzID0gZGlmZlRlbXBsYXRlKGN1cnJlbnRUZW1wbGF0ZSwgbmV3VGVtcGxhdGUpO1xuXG4gICAgLy8gVEhFTlxuICAgIHRlc3QuZXF1YWwoZGlmZmVyZW5jZXMucmVzb3VyY2VzLmRpZmZlcmVuY2VDb3VudCwgMywgJ2FsbCByZXNvdXJjZXMgYXJlIHJlcGxhY2VkJyk7XG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG59O1xuIl19