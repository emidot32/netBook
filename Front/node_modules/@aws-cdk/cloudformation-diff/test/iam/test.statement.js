"use strict";
const fc = require("fast-check");
const statement_1 = require("../../lib/iam/statement");
const arbitraryResource = fc.oneof(fc.constantFrom('*', 'arn:resource'));
const arbitraryAction = fc.constantFrom('*', 's3:*', 's3:GetObject', 's3:PutObject');
const arbitraryPrincipal = fc.oneof(fc.constant(undefined), fc.constant('*'), fc.record({ AWS: fc.oneof(fc.string(), fc.constant('*')) }), fc.record({ Service: fc.string() }), fc.record({ Federated: fc.string() }));
const arbitraryCondition = fc.oneof(fc.constant(undefined), fc.constant({ StringEquals: { Key: 'Value' } }), fc.constant({ StringEquals: { Key: 'Value' }, NumberEquals: { Key: 5 } }));
const arbitraryStatement = fc.record({
    Sid: fc.oneof(fc.string(), fc.constant(undefined)),
    Effect: fc.constantFrom('Allow', 'Deny'),
    Resource: fc.array(arbitraryResource, 0, 2),
    NotResource: fc.boolean(),
    Action: fc.array(arbitraryAction, 1, 2),
    NotAction: fc.boolean(),
    Principal: fc.array(arbitraryPrincipal, 0, 2),
    NotPrincipal: fc.boolean(),
    Condition: arbitraryCondition
}).map(record => {
    // This map() that shuffles keys is the easiest way to create variation between Action/NotAction etc.
    makeNot(record, 'Resource', 'NotResource');
    makeNot(record, 'Action', 'NotAction');
    makeNot(record, 'Principal', 'NotPrincipal');
    return record;
});
function makeNot(obj, key, notKey) {
    if (obj[notKey]) {
        obj[notKey] = obj[key];
        delete obj[key];
    }
    else {
        delete obj[notKey];
    }
}
/**
 * Two statements where one is a modification of the other
 *
 * This is to generate two statements that have a higher chance of being similar
 * than generating two arbitrary statements independently.
 */
const twoArbitraryStatements = fc.record({
    statement1: arbitraryStatement,
    statement2: arbitraryStatement,
    copySid: fc.boolean(),
    copyEffect: fc.boolean(),
    copyResource: fc.boolean(),
    copyAction: fc.boolean(),
    copyPrincipal: fc.boolean(),
    copyCondition: fc.boolean(),
}).map(op => {
    const original = op.statement1;
    const modified = Object.create(original, {});
    if (op.copySid) {
        modified.Sid = op.statement2.Sid;
    }
    if (op.copyEffect) {
        modified.Effect = op.statement2.Effect;
    }
    if (op.copyResource) {
        modified.Resource = op.statement2.Resource;
        modified.NotResource = op.statement2.NotResource;
    }
    if (op.copyAction) {
        modified.Action = op.statement2.Action;
        modified.NotAction = op.statement2.NotAction;
    }
    if (op.copyPrincipal) {
        modified.Principal = op.statement2.Principal;
        modified.NotPrincipal = op.statement2.NotPrincipal;
    }
    if (op.copyCondition) {
        modified.Condition = op.statement2.Condition;
    }
    return { statement1: original, statement2: modified };
});
module.exports = {
    'can parse all positive fields'(test) {
        const statement = new statement_1.Statement({
            Sid: 'Sid',
            Effect: 'Allow',
            Resource: ['resource'],
            Action: ['action'],
            Principal: [{ AWS: 'arn' }],
            Condition: { StringEquals: { 'Amzn-This': 'That' } }
        });
        test.equal(statement.sid, 'Sid');
        test.equal(statement.effect, 'Allow');
        test.deepEqual(statement.resources.values, ['resource']);
        test.deepEqual(statement.actions.values, ['action']);
        test.deepEqual(statement.principals.values, ['AWS:arn']);
        test.deepEqual(statement.condition, { StringEquals: { 'Amzn-This': 'That' } });
        test.equal(statement.resources.not, false);
        test.equal(statement.actions.not, false);
        test.equal(statement.principals.not, false);
        test.done();
    },
    'parses strings as singleton lists'(test) {
        const statement = new statement_1.Statement({
            Resource: 'resource'
        });
        test.deepEqual(statement.resources.values, ['resource']);
        test.done();
    },
    'correctly parses NotFields'(test) {
        const statement = new statement_1.Statement({
            NotResource: ['resource'],
            NotAction: ['action'],
            NotPrincipal: [{ AWS: 'arn' }],
        });
        test.equal(statement.resources.not, true);
        test.equal(statement.actions.not, true);
        test.equal(statement.principals.not, true);
        test.done();
    },
    'parse all LambdaPermission fields'(test) {
        const statement = statement_1.parseLambdaPermission({
            Action: 'lambda:CallMeMaybe',
            FunctionName: 'Function',
            Principal: '*',
            SourceAccount: '123456789012',
            SourceArn: 'arn',
        });
        test.deepEqual(statement.actions.values, ['lambda:CallMeMaybe']);
        test.deepEqual(statement.resources.values, ['Function']);
        test.deepEqual(statement.principals.values, ['*']);
        test.deepEqual(statement.condition, {
            ArnLike: { 'AWS:SourceArn': 'arn' },
            StringEquals: { 'AWS:SourceAccount': '123456789012', },
        });
        test.done();
    },
    'parse lambda eventsourcetoken'(test) {
        const statement = statement_1.parseLambdaPermission({
            Action: 'lambda:CallMeMaybe',
            FunctionName: 'Function',
            EventSourceToken: 'token',
            Principal: '*',
        });
        test.deepEqual(statement.condition, {
            StringEquals: { 'lambda:EventSourceToken': 'token' },
        });
        test.done();
    },
    'stringify complex condition'(test) {
        // WHEN
        const stringified = statement_1.renderCondition({
            StringEquals: { 'AWS:SourceAccount': '${AWS::AccountId}' },
            ArnLike: { 'AWS:SourceArn': '${MyBucket.Arn}' }
        }).split('\n');
        // THEN
        test.deepEqual(stringified, [
            '"StringEquals": {',
            '  "AWS:SourceAccount": "${AWS::AccountId}"',
            '},',
            '"ArnLike": {',
            '  "AWS:SourceArn": "${MyBucket.Arn}"',
            '}',
        ]);
        test.done();
    },
    'an Allow statement with a NotPrincipal is negative'(test) {
        // WHEN
        const statement = new statement_1.Statement({
            Effect: 'Allow',
            Resource: 'resource',
            NotPrincipal: { AWS: 'me' },
        });
        // THEN
        test.equals(statement.isNegativeStatement, true);
        test.done();
    },
    'a Deny statement with a NotPrincipal is positive'(test) {
        // In effect, this is a roundabout way of saying only the given Principal
        // should be allowed ("everyone who's not me can't do this").
        // WHEN
        const statement = new statement_1.Statement({
            Effect: 'Deny',
            Resource: 'resource',
            NotPrincipal: { AWS: 'me' },
        });
        // THEN
        test.equals(statement.isNegativeStatement, false);
        test.done();
    },
    'equality is reflexive'(test) {
        fc.assert(fc.property(arbitraryStatement, (statement) => {
            return new statement_1.Statement(statement).equal(new statement_1.Statement(statement));
        }));
        test.done();
    },
    'equality is symmetric'(test) {
        fc.assert(fc.property(twoArbitraryStatements, (s) => {
            const a = new statement_1.Statement(s.statement1);
            const b = new statement_1.Statement(s.statement2);
            fc.pre(a.equal(b));
            return b.equal(a);
        }));
        test.done();
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5zdGF0ZW1lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0ZXN0LnN0YXRlbWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsaUNBQWtDO0FBRWxDLHVEQUE0RjtBQW1LNUYsTUFBTSxpQkFBaUIsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsR0FBRyxFQUFFLGNBQWMsQ0FBQyxDQUFDLENBQUM7QUFDekUsTUFBTSxlQUFlLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLGNBQWMsRUFBRSxjQUFjLENBQUMsQ0FBQztBQUNyRixNQUFNLGtCQUFrQixHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQ2pDLEVBQUUsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQ3RCLEVBQUUsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQ2hCLEVBQUUsQ0FBQyxNQUFNLENBQUMsRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFDM0QsRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFLE9BQU8sRUFBRSxFQUFFLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxFQUNuQyxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQUUsU0FBUyxFQUFFLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQ3RDLENBQUM7QUFDRixNQUFNLGtCQUFrQixHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQ2pDLEVBQUUsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQ3RCLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxZQUFZLEVBQUUsRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFLEVBQUMsQ0FBQyxFQUM5QyxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsWUFBWSxFQUFF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QUMsQ0FBQztZQUN0QyxNQUFNLENBQUMsR0FBRyxJQUFJLHFCQUFTLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBRXRDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ25CLE9BQU8sQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNwQixDQUFDLENBQ0YsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2QsQ0FBQztDQUlGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZmMgPSByZXF1aXJlKCdmYXN0LWNoZWNrJyk7XG5pbXBvcnQgeyBUZXN0IH0gZnJvbSAnbm9kZXVuaXQnO1xuaW1wb3J0IHsgcGFyc2VMYW1iZGFQZXJtaXNzaW9uLCByZW5kZXJDb25kaXRpb24sIFN0YXRlbWVudCB9IGZyb20gJy4uLy4uL2xpYi9pYW0vc3RhdGVtZW50JztcblxuZXhwb3J0ID0ge1xuICAnY2FuIHBhcnNlIGFsbCBwb3NpdGl2ZSBmaWVsZHMnKHRlc3Q6IFRlc3QpIHtcbiAgICBjb25zdCBzdGF0ZW1lbnQgPSBuZXcgU3RhdGVtZW50KHtcbiAgICAgIFNpZDogJ1NpZCcsXG4gICAgICBFZmZlY3Q6ICdBbGxvdycsXG4gICAgICBSZXNvdXJjZTogWydyZXNvdXJjZSddLFxuICAgICAgQWN0aW9uOiBbJ2FjdGlvbiddLFxuICAgICAgUHJpbmNpcGFsOiBbe0FXUzogJ2Fybid9XSxcbiAgICAgIENvbmRpdGlvbjogeyBTdHJpbmdFcXVhbHM6IHsgJ0Ftem4tVGhpcyc6ICdUaGF0JyB9IH1cbiAgICB9KTtcblxuICAgIHRlc3QuZXF1YWwoc3RhdGVtZW50LnNpZCwgJ1NpZCcpO1xuICAgIHRlc3QuZXF1YWwoc3RhdGVtZW50LmVmZmVjdCwgJ0FsbG93Jyk7XG4gICAgdGVzdC5kZWVwRXF1YWwoc3RhdGVtZW50LnJlc291cmNlcy52YWx1ZXMsIFsncmVzb3VyY2UnXSk7XG4gICAgdGVzdC5kZWVwRXF1YWwoc3RhdGVtZW50LmFjdGlvbnMudmFsdWVzLCBbJ2FjdGlvbiddKTtcbiAgICB0ZXN0LmRlZXBFcXVhbChzdGF0ZW1lbnQucHJpbmNpcGFscy52YWx1ZXMsIFsnQVdTOmFybiddKTtcbiAgICB0ZXN0LmRlZXBFcXVhbChzdGF0ZW1lbnQuY29uZGl0aW9uLCB7IFN0cmluZ0VxdWFsczogeyAnQW16bi1UaGlzJzogJ1RoYXQnIH0gfSk7XG5cbiAgICB0ZXN0LmVxdWFsKHN0YXRlbWVudC5yZXNvdXJjZXMubm90LCBmYWxzZSk7XG4gICAgdGVzdC5lcXVhbChzdGF0ZW1lbnQuYWN0aW9ucy5ub3QsIGZhbHNlKTtcbiAgICB0ZXN0LmVxdWFsKHN0YXRlbWVudC5wcmluY2lwYWxzLm5vdCwgZmFsc2UpO1xuXG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgJ3BhcnNlcyBzdHJpbmdzIGFzIHNpbmdsZXRvbiBsaXN0cycodGVzdDogVGVzdCkge1xuICAgIGNvbnN0IHN0YXRlbWVudCA9IG5ldyBTdGF0ZW1lbnQoe1xuICAgICAgUmVzb3VyY2U6ICdyZXNvdXJjZSdcbiAgICB9KTtcblxuICAgIHRlc3QuZGVlcEVxdWFsKHN0YXRlbWVudC5yZXNvdXJjZXMudmFsdWVzLCBbJ3Jlc291cmNlJ10pO1xuXG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgJ2NvcnJlY3RseSBwYXJzZXMgTm90RmllbGRzJyh0ZXN0OiBUZXN0KSB7XG4gICAgY29uc3Qgc3RhdGVtZW50ID0gbmV3IFN0YXRlbWVudCh7XG4gICAgICBOb3RSZXNvdXJjZTogWydyZXNvdXJjZSddLFxuICAgICAgTm90QWN0aW9uOiBbJ2FjdGlvbiddLFxuICAgICAgTm90UHJpbmNpcGFsOiBbe0FXUzogJ2Fybid9XSxcbiAgICB9KTtcblxuICAgIHRlc3QuZXF1YWwoc3RhdGVtZW50LnJlc291cmNlcy5ub3QsIHRydWUpO1xuICAgIHRlc3QuZXF1YWwoc3RhdGVtZW50LmFjdGlvbnMubm90LCB0cnVlKTtcbiAgICB0ZXN0LmVxdWFsKHN0YXRlbWVudC5wcmluY2lwYWxzLm5vdCwgdHJ1ZSk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICAncGFyc2UgYWxsIExhbWJkYVBlcm1pc3Npb24gZmllbGRzJyh0ZXN0OiBUZXN0KSB7XG4gICAgY29uc3Qgc3RhdGVtZW50ID0gcGFyc2VMYW1iZGFQZXJtaXNzaW9uKHtcbiAgICAgIEFjdGlvbjogJ2xhbWJkYTpDYWxsTWVNYXliZScsXG4gICAgICBGdW5jdGlvbk5hbWU6ICdGdW5jdGlvbicsXG4gICAgICBQcmluY2lwYWw6ICcqJyxcbiAgICAgIFNvdXJjZUFjY291bnQ6ICcxMjM0NTY3ODkwMTInLFxuICAgICAgU291cmNlQXJuOiAnYXJuJyxcbiAgICB9KTtcblxuICAgIHRlc3QuZGVlcEVxdWFsKHN0YXRlbWVudC5hY3Rpb25zLnZhbHVlcywgWydsYW1iZGE6Q2FsbE1lTWF5YmUnXSk7XG4gICAgdGVzdC5kZWVwRXF1YWwoc3RhdGVtZW50LnJlc291cmNlcy52YWx1ZXMsIFsnRnVuY3Rpb24nXSk7XG4gICAgdGVzdC5kZWVwRXF1YWwoc3RhdGVtZW50LnByaW5jaXBhbHMudmFsdWVzLCBbJyonXSk7XG4gICAgdGVzdC5kZWVwRXF1YWwoc3RhdGVtZW50LmNvbmRpdGlvbiwge1xuICAgICAgQXJuTGlrZTogeyAnQVdTOlNvdXJjZUFybic6ICdhcm4nIH0sXG4gICAgICBTdHJpbmdFcXVhbHM6IHsgJ0FXUzpTb3VyY2VBY2NvdW50JzogJzEyMzQ1Njc4OTAxMicsIH0sXG4gICAgfSk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICAncGFyc2UgbGFtYmRhIGV2ZW50c291cmNldG9rZW4nKHRlc3Q6IFRlc3QpIHtcbiAgICBjb25zdCBzdGF0ZW1lbnQgPSBwYXJzZUxhbWJkYVBlcm1pc3Npb24oe1xuICAgICAgQWN0aW9uOiAnbGFtYmRhOkNhbGxNZU1heWJlJyxcbiAgICAgIEZ1bmN0aW9uTmFtZTogJ0Z1bmN0aW9uJyxcbiAgICAgIEV2ZW50U291cmNlVG9rZW46ICd0b2tlbicsXG4gICAgICBQcmluY2lwYWw6ICcqJyxcbiAgICB9KTtcblxuICAgIHRlc3QuZGVlcEVxdWFsKHN0YXRlbWVudC5jb25kaXRpb24sIHtcbiAgICAgIFN0cmluZ0VxdWFsczogeyAnbGFtYmRhOkV2ZW50U291cmNlVG9rZW4nOiAndG9rZW4nIH0sXG4gICAgfSk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICAnc3RyaW5naWZ5IGNvbXBsZXggY29uZGl0aW9uJyh0ZXN0OiBUZXN0KSB7XG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHN0cmluZ2lmaWVkID0gcmVuZGVyQ29uZGl0aW9uKHtcbiAgICAgIFN0cmluZ0VxdWFsczogeyAnQVdTOlNvdXJjZUFjY291bnQnOiAnJHtBV1M6OkFjY291bnRJZH0nIH0sXG4gICAgICBBcm5MaWtlOiB7ICdBV1M6U291cmNlQXJuJzogJyR7TXlCdWNrZXQuQXJufScgfVxuICAgIH0pLnNwbGl0KCdcXG4nKTtcblxuICAgIC8vIFRIRU5cbiAgICB0ZXN0LmRlZXBFcXVhbChzdHJpbmdpZmllZCwgW1xuICAgICAgJ1wiU3RyaW5nRXF1YWxzXCI6IHsnLFxuICAgICAgJyAgXCJBV1M6U291cmNlQWNjb3VudFwiOiBcIiR7QVdTOjpBY2NvdW50SWR9XCInLFxuICAgICAgJ30sJyxcbiAgICAgICdcIkFybkxpa2VcIjogeycsXG4gICAgICAnICBcIkFXUzpTb3VyY2VBcm5cIjogXCIke015QnVja2V0LkFybn1cIicsXG4gICAgICAnfScsXG4gICAgXSk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICAnYW4gQWxsb3cgc3RhdGVtZW50IHdpdGggYSBOb3RQcmluY2lwYWwgaXMgbmVnYXRpdmUnKHRlc3Q6IFRlc3QpIHtcbiAgICAvLyBXSEVOXG4gICAgY29uc3Qgc3RhdGVtZW50ID0gbmV3IFN0YXRlbWVudCh7XG4gICAgICBFZmZlY3Q6ICdBbGxvdycsXG4gICAgICBSZXNvdXJjZTogJ3Jlc291cmNlJyxcbiAgICAgIE5vdFByaW5jaXBhbDogeyBBV1M6ICdtZScgfSxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICB0ZXN0LmVxdWFscyhzdGF0ZW1lbnQuaXNOZWdhdGl2ZVN0YXRlbWVudCwgdHJ1ZSk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICAnYSBEZW55IHN0YXRlbWVudCB3aXRoIGEgTm90UHJpbmNpcGFsIGlzIHBvc2l0aXZlJyh0ZXN0OiBUZXN0KSB7XG4gICAgLy8gSW4gZWZmZWN0LCB0aGlzIGlzIGEgcm91bmRhYm91dCB3YXkgb2Ygc2F5aW5nIG9ubHkgdGhlIGdpdmVuIFByaW5jaXBhbFxuICAgIC8vIHNob3VsZCBiZSBhbGxvd2VkIChcImV2ZXJ5b25lIHdobydzIG5vdCBtZSBjYW4ndCBkbyB0aGlzXCIpLlxuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHN0YXRlbWVudCA9IG5ldyBTdGF0ZW1lbnQoe1xuICAgICAgRWZmZWN0OiAnRGVueScsXG4gICAgICBSZXNvdXJjZTogJ3Jlc291cmNlJyxcbiAgICAgIE5vdFByaW5jaXBhbDogeyBBV1M6ICdtZScgfSxcbiAgICB9KTtcblxuICAgIC8vIFRIRU5cbiAgICB0ZXN0LmVxdWFscyhzdGF0ZW1lbnQuaXNOZWdhdGl2ZVN0YXRlbWVudCwgZmFsc2UpO1xuXG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgJ2VxdWFsaXR5IGlzIHJlZmxleGl2ZScodGVzdDogVGVzdCkge1xuICAgIGZjLmFzc2VydChmYy5wcm9wZXJ0eShcbiAgICAgIGFyYml0cmFyeVN0YXRlbWVudCwgKHN0YXRlbWVudCkgPT4ge1xuICAgICAgICByZXR1cm4gbmV3IFN0YXRlbWVudChzdGF0ZW1lbnQpLmVxdWFsKG5ldyBTdGF0ZW1lbnQoc3RhdGVtZW50KSk7XG4gICAgICB9XG4gICAgKSk7XG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgJ2VxdWFsaXR5IGlzIHN5bW1ldHJpYycodGVzdDogVGVzdCkge1xuICAgIGZjLmFzc2VydChmYy5wcm9wZXJ0eShcbiAgICAgIHR3b0FyYml0cmFyeVN0YXRlbWVudHMsIChzKSA9PiB7XG4gICAgICAgIGNvbnN0IGEgPSBuZXcgU3RhdGVtZW50KHMuc3RhdGVtZW50MSk7XG4gICAgICAgIGNvbnN0IGIgPSBuZXcgU3RhdGVtZW50KHMuc3RhdGVtZW50Mik7XG5cbiAgICAgICAgZmMucHJlKGEuZXF1YWwoYikpO1xuICAgICAgICByZXR1cm4gYi5lcXVhbChhKTtcbiAgICAgIH1cbiAgICApKTtcbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICAvLyBXZSBzaG91bGQgYmUgdGVzdGluZyB0cmFuc2l0aXZpdHkgYXMgd2VsbCBidXQgaXQncyB0b28gbXVjaCBjb2RlIHRvIGdlbmVyYXRlXG4gIC8vIGFyYml0cmFyaWVzIHRoYXQgc2F0aXNmeSB0aGUgcHJlY29uZGl0aW9uIGVub3VnaCB0aW1lcyB0byBiZSB1c2VmdWwuXG59O1xuXG5jb25zdCBhcmJpdHJhcnlSZXNvdXJjZSA9IGZjLm9uZW9mKGZjLmNvbnN0YW50RnJvbSgnKicsICdhcm46cmVzb3VyY2UnKSk7XG5jb25zdCBhcmJpdHJhcnlBY3Rpb24gPSBmYy5jb25zdGFudEZyb20oJyonLCAnczM6KicsICdzMzpHZXRPYmplY3QnLCAnczM6UHV0T2JqZWN0Jyk7XG5jb25zdCBhcmJpdHJhcnlQcmluY2lwYWwgPSBmYy5vbmVvZjxhbnk+KFxuICBmYy5jb25zdGFudCh1bmRlZmluZWQpLFxuICBmYy5jb25zdGFudCgnKicpLFxuICBmYy5yZWNvcmQoeyBBV1M6IGZjLm9uZW9mKGZjLnN0cmluZygpLCBmYy5jb25zdGFudCgnKicpKSB9KSxcbiAgZmMucmVjb3JkKHsgU2VydmljZTogZmMuc3RyaW5nKCkgfSksXG4gIGZjLnJlY29yZCh7IEZlZGVyYXRlZDogZmMuc3RyaW5nKCkgfSlcbik7XG5jb25zdCBhcmJpdHJhcnlDb25kaXRpb24gPSBmYy5vbmVvZihcbiAgZmMuY29uc3RhbnQodW5kZWZpbmVkKSxcbiAgZmMuY29uc3RhbnQoeyBTdHJpbmdFcXVhbHM6IHsgS2V5OiAnVmFsdWUnIH19KSxcbiAgZmMuY29uc3RhbnQoeyBTdHJpbmdFcXVhbHM6IHsgS2V5OiAnVmFsdWUnIH0sIE51bWJlckVxdWFsczogeyBLZXk6IDUgfX0pLFxuKTtcblxuY29uc3QgYXJiaXRyYXJ5U3RhdGVtZW50ID0gZmMucmVjb3JkKHtcbiAgU2lkOiBmYy5vbmVvZihmYy5zdHJpbmcoKSwgZmMuY29uc3RhbnQodW5kZWZpbmVkKSksXG4gIEVmZmVjdDogZmMuY29uc3RhbnRGcm9tKCdBbGxvdycsICdEZW55JyksXG4gIFJlc291cmNlOiBmYy5hcnJheShhcmJpdHJhcnlSZXNvdXJjZSwgMCwgMiksXG4gIE5vdFJlc291cmNlOiBmYy5ib29sZWFuKCksXG4gIEFjdGlvbjogZmMuYXJyYXkoYXJiaXRyYXJ5QWN0aW9uLCAxLCAyKSxcbiAgTm90QWN0aW9uOiBmYy5ib29sZWFuKCksXG4gIFByaW5jaXBhbDogZmMuYXJyYXkoYXJiaXRyYXJ5UHJpbmNpcGFsLCAwLCAyKSxcbiAgTm90UHJpbmNpcGFsOiBmYy5ib29sZWFuKCksXG4gIENvbmRpdGlvbjogYXJiaXRyYXJ5Q29uZGl0aW9uXG59KS5tYXAocmVjb3JkID0+IHtcbiAgLy8gVGhpcyBtYXAoKSB0aGF0IHNodWZmbGVzIGtleXMgaXMgdGhlIGVhc2llc3Qgd2F5IHRvIGNyZWF0ZSB2YXJpYXRpb24gYmV0d2VlbiBBY3Rpb24vTm90QWN0aW9uIGV0Yy5cbiAgbWFrZU5vdChyZWNvcmQsICdSZXNvdXJjZScsICdOb3RSZXNvdXJjZScpO1xuICBtYWtlTm90KHJlY29yZCwgJ0FjdGlvbicsICdOb3RBY3Rpb24nKTtcbiAgbWFrZU5vdChyZWNvcmQsICdQcmluY2lwYWwnLCAnTm90UHJpbmNpcGFsJyk7XG4gIHJldHVybiByZWNvcmQ7XG59KTtcblxuZnVuY3Rpb24gbWFrZU5vdChvYmo6IGFueSwga2V5OiBzdHJpbmcsIG5vdEtleTogc3RyaW5nKSB7XG4gIGlmIChvYmpbbm90S2V5XSkge1xuICAgIG9ialtub3RLZXldID0gb2JqW2tleV07XG4gICAgZGVsZXRlIG9ialtrZXldO1xuICB9IGVsc2Uge1xuICAgIGRlbGV0ZSBvYmpbbm90S2V5XTtcbiAgfVxufVxuXG4vKipcbiAqIFR3byBzdGF0ZW1lbnRzIHdoZXJlIG9uZSBpcyBhIG1vZGlmaWNhdGlvbiBvZiB0aGUgb3RoZXJcbiAqXG4gKiBUaGlzIGlzIHRvIGdlbmVyYXRlIHR3byBzdGF0ZW1lbnRzIHRoYXQgaGF2ZSBhIGhpZ2hlciBjaGFuY2Ugb2YgYmVpbmcgc2ltaWxhclxuICogdGhhbiBnZW5lcmF0aW5nIHR3byBhcmJpdHJhcnkgc3RhdGVtZW50cyBpbmRlcGVuZGVudGx5LlxuICovXG5jb25zdCB0d29BcmJpdHJhcnlTdGF0ZW1lbnRzID0gZmMucmVjb3JkKHtcbiAgc3RhdGVtZW50MTogYXJiaXRyYXJ5U3RhdGVtZW50LFxuICBzdGF0ZW1lbnQyOiBhcmJpdHJhcnlTdGF0ZW1lbnQsXG4gIGNvcHlTaWQ6IGZjLmJvb2xlYW4oKSxcbiAgY29weUVmZmVjdDogZmMuYm9vbGVhbigpLFxuICBjb3B5UmVzb3VyY2U6IGZjLmJvb2xlYW4oKSxcbiAgY29weUFjdGlvbjogZmMuYm9vbGVhbigpLFxuICBjb3B5UHJpbmNpcGFsOiBmYy5ib29sZWFuKCksXG4gIGNvcHlDb25kaXRpb246IGZjLmJvb2xlYW4oKSxcbn0pLm1hcChvcCA9PiB7XG4gIGNvbnN0IG9yaWdpbmFsID0gb3Auc3RhdGVtZW50MTtcbiAgY29uc3QgbW9kaWZpZWQgPSBPYmplY3QuY3JlYXRlKG9yaWdpbmFsLCB7fSk7XG5cbiAgaWYgKG9wLmNvcHlTaWQpIHsgbW9kaWZpZWQuU2lkID0gb3Auc3RhdGVtZW50Mi5TaWQ7IH1cbiAgaWYgKG9wLmNvcHlFZmZlY3QpIHsgbW9kaWZpZWQuRWZmZWN0ID0gb3Auc3RhdGVtZW50Mi5FZmZlY3Q7IH1cbiAgaWYgKG9wLmNvcHlSZXNvdXJjZSkgeyBtb2RpZmllZC5SZXNvdXJjZSA9IG9wLnN0YXRlbWVudDIuUmVzb3VyY2U7IG1vZGlmaWVkLk5vdFJlc291cmNlID0gb3Auc3RhdGVtZW50Mi5Ob3RSZXNvdXJjZTsgfVxuICBpZiAob3AuY29weUFjdGlvbikgeyBtb2RpZmllZC5BY3Rpb24gPSBvcC5zdGF0ZW1lbnQyLkFjdGlvbjsgbW9kaWZpZWQuTm90QWN0aW9uID0gb3Auc3RhdGVtZW50Mi5Ob3RBY3Rpb247IH1cbiAgaWYgKG9wLmNvcHlQcmluY2lwYWwpIHsgbW9kaWZpZWQuUHJpbmNpcGFsID0gb3Auc3RhdGVtZW50Mi5QcmluY2lwYWw7IG1vZGlmaWVkLk5vdFByaW5jaXBhbCA9IG9wLnN0YXRlbWVudDIuTm90UHJpbmNpcGFsOyB9XG4gIGlmIChvcC5jb3B5Q29uZGl0aW9uKSB7IG1vZGlmaWVkLkNvbmRpdGlvbiA9IG9wLnN0YXRlbWVudDIuQ29uZGl0aW9uOyB9XG5cbiAgcmV0dXJuIHsgc3RhdGVtZW50MTogb3JpZ2luYWwsIHN0YXRlbWVudDI6IG1vZGlmaWVkIH07XG59KTsiXX0=